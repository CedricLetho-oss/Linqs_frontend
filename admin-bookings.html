<!DOCTYPE html>
<html lang="en-ZA">
<head>
    <!-- Essential Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResLinQ | Student Accommodation Platform - Find Your Perfect Student Home in South Africa</title>
    <meta name="description" content="ResLinQ helps students find verified accommodations near campuses in South Africa. Browse listings, book viewings, and join our student community. Safe, affordable student housing.">
    <meta name="keywords" content="student accommodation, South Africa student housing, university residences, student rentals, campus accommodation, student living, ResLinQ">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://www.reslinq.co.za/">

    <!-- Favicon & App Icons -->
    <link rel="icon" href="/images/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="manifest" href="/images/site.webmanifest">

    <!-- Enhanced Open Graph / Social Media -->
    <meta property="og:title" content="ResLinQ - Student Living, Simplified | Find Student Accommodation in South Africa">
    <meta property="og:description" content="Find verified student accommodations near South African campuses. Safe, affordable housing with easy booking and community support. Browse 500+ listings.">
    <meta property="og:image" content="/images/og-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://www.reslinq.co.za/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="ResLinQ">
    <meta property="og:locale" content="en_ZA">
    
    <!-- Enhanced Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ResLinQ - Student Accommodation Made Simple">
    <meta name="twitter:description" content="Find your perfect student home near campus with verified listings and easy booking. 500+ accommodations across South Africa.">
    <meta name="twitter:image" content="/images/og-image.jpg">
    <meta name="twitter:site" content="@ResLinQ">

    <!-- Additional SEO Meta Tags -->
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta name="author" content="ResLinQ">
    <meta name="geo.region" content="ZA">
    <meta name="geo.placename" content="South Africa">
    

    <!-- Preload critical resources -->
    <link rel="preload" href="style.css" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" as="style">

    <!-- Then the actual stylesheet links (keep your existing ones) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
    <style>
    :root {
      --primary: #1e3a8a;
      --primary-light: #3b82f6;
      --primary-dark: #1e40af;
      --success: #059669;
      --warning: #f59e0b;
      --danger: #dc2626;
      --info: #60a5fa;
      --light-bg: #f8fafc;
      --navy: #0b2447;
      --admin-sidebar: #0f172a;
    }

    body {
      background: #f8fafc;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      overflow-x: hidden;
    }

    .admin-sidebar {
      background: var(--admin-sidebar);
      color: white;
      min-height: 100vh;
      position: fixed;
      width: 280px;
      transition: all 0.3s ease;
      z-index: 1000;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }

    .admin-sidebar.collapsed {
      width: 80px;
    }

    .admin-sidebar.collapsed .sidebar-text {
      display: none;
    }

    .sidebar-brand {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }

    .sidebar-nav {
      padding: 1rem 0;
    }

    .nav-item {
      margin: 0.25rem 1rem;
    }

    .nav-link {
      color: rgba(255,255,255,0.8);
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .nav-link:hover, .nav-link.active {
      background: rgba(59, 130, 246, 0.1);
      color: white;
      border-left: 3px solid var(--primary-light);
    }

    .admin-main {
      margin-left: 280px;
      transition: all 0.3s ease;
      min-height: 100vh;
    }

    .admin-main.expanded {
      margin-left: 80px;
    }

    .admin-header {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 1rem 2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .admin-content {
      padding: 2rem;
    }

    /* Booking-specific styles */
    .booking-card {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      border-left: 4px solid var(--primary);
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }

    .booking-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }

    .booking-card.success { border-left-color: var(--success); }
    .booking-card.warning { border-left-color: var(--warning); }
    .booking-card.danger { border-left-color: var(--danger); }
    .booking-card.info { border-left-color: var(--info); }

    .timeline {
      position: relative;
      padding-left: 2rem;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #e2e8f0;
    }

    .timeline-item {
      position: relative;
      margin-bottom: 1.5rem;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -2rem;
      top: 0.5rem;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-pending { background: #fef3c7; color: #d97706; }
    .status-confirmed { background: #d1fae5; color: #059669; }
    .status-cancelled { background: #fee2e2; color: #dc2626; }
    .status-completed { background: #dbeafe; color: #1d4ed8; }

    .calendar-view {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .calendar-day {
      border: 1px solid #e2e8f0;
      padding: 0.5rem;
      min-height: 100px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .calendar-day:hover {
      background: #f8fafc;
    }

    .calendar-day.has-booking {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--primary-light);
    }

    .calendar-day.today {
      background: rgba(245, 158, 11, 0.1);
      border-color: var(--warning);
    }

    .booking-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--primary);
      display: inline-block;
      margin-right: 0.25rem;
    }

    .calendar-booking {
      font-size: 0.7rem;
      background: var(--primary-light);
      color: white;
      padding: 0.1rem 0.3rem;
      border-radius: 0.25rem;
      margin-top: 0.2rem;
      display: block;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .data-table {
      background: white;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .table th {
      background: #f8fafc;
      border-bottom: 2px solid #e2e8f0;
      font-weight: 600;
      color: #64748b;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* View Toggle */
    .view-toggle {
      display: flex;
      background: #f1f5f9;
      border-radius: 0.75rem;
      padding: 0.25rem;
      margin-bottom: 1.5rem;
    }

    .view-toggle-btn {
      padding: 0.5rem 1rem;
      border: none;
      background: transparent;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .view-toggle-btn.active {
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Booking Type Badges */
    .booking-type-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.7rem;
      font-weight: 600;
    }
    
    .booking-type-viewing { background: #dbeafe; color: #1d4ed8; }
    .booking-type-contract { background: #fef3c7; color: #d97706; }
    .booking-type-both { background: #d1fae5; color: #059669; }

    /* Time Display */
    .time-display {
      font-size: 0.875rem;
      color: #64748b;
      background: #f8fafc;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      border: 1px solid #e2e8f0;
    }

    /* Card View Styles */
    .booking-card-item {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      border-left: 4px solid var(--primary);
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }

    .booking-card-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }

    .booking-card-item.pending { border-left-color: var(--warning); }
    .booking-card-item.confirmed { border-left-color: var(--success); }
    .booking-card-item.cancelled { border-left-color: var(--danger); }
    .booking-card-item.completed { border-left-color: var(--info); }

    /* Reschedule specific styles */
.reschedule-indicator {
  background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 0.5rem;
  font-size: 0.7rem;
  font-weight: 600;
}

.reschedule-history-item {
  border-left: 3px solid #3b82f6;
  margin-bottom: 0.5rem;
}

.reschedule-pending {
  border-left-color: #f59e0b;
  background: rgba(245, 158, 11, 0.1);
}

.reschedule-approved {
  border-left-color: #059669;
  background: rgba(5, 150, 105, 0.1);
}

.reschedule-rejected {
  border-left-color: #dc2626;
  background: rgba(220, 38, 38, 0.1);
}

/* Add to your existing CSS styles */
.badge.bg-success { background: var(--success) !important; }
.badge.bg-info { background: var(--info) !important; }
.badge.bg-warning { background: var(--warning) !important; }
.badge.bg-secondary { background: #6b7280 !important; }

/* Price display styles */
.price-display {
    font-size: 1.1rem;
    font-weight: 600;
}

.price-type {
    font-size: 0.75rem;
    opacity: 0.8;
}

/* Booking source badges */
.booking-source-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 0.5rem;
    font-size: 0.7rem;
    font-weight: 600;
}
  </style>
</head>
<body>

  <!-- Admin Redirect Check -->
  <script>
    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    
    if (!token) {
      alert("Please log in to access admin panel.");
      window.location.href = "authorization.html";
    } else if (user.role !== 'admin') {
      alert("Access denied. Admin privileges required.");
      window.location.href = "index.html";
    }
  </script>

  <!-- Admin Sidebar -->
  <div class="admin-sidebar" id="adminSidebar">
    <div class="sidebar-brand">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="bi bi-shield-check text-primary fs-4 me-2"></i>
          <span class="sidebar-text fs-5 ">ResLinQ Admin</span>
        </div>
        <button class="btn btn-sm btn-outline-light" id="sidebarToggle">
          <i class="bi bi-list"></i>
        </button>
      </div>
    </div>

    <div class="sidebar-nav">
      <div class="nav-item">
        <a class="nav-link" href="admin-dashboard.html">
          <i class="bi bi-speedometer2"></i>
          <span class="sidebar-text">Dashboard</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="admin-users.html">
          <i class="bi bi-people"></i>
          <span class="sidebar-text">Users</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="admin-properties.html">
          <i class="bi bi-houses"></i>
          <span class="sidebar-text">Properties</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link active" href="admin-bookings.html">
          <i class="bi bi-calendar-check"></i>
          <span class="sidebar-text">Bookings</span>
          <span class="notification-badge" id="sidebarNotificationBadge">0</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="admin-reports.html">
          <i class="bi bi-flag"></i>
          <span class="sidebar-text">Reports</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="admin-reviews.html">
          <i class="bi bi-star"></i>
          <span class="sidebar-text">Reviews</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="admin-verification.html">
          <i class="bi bi-patch-check"></i>
          <span class="sidebar-text">Verification</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="admin-messages.html">
          <i class="bi bi-chat-dots"></i>
          <span class="sidebar-text">Messages</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link " href="admin-payments.html">
          <i class="bi bi-credit-card"></i>
          <span class="sidebar-text">Payments</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="admin-settings.html">
          <i class="bi bi-gear"></i>
          <span class="sidebar-text">Settings</span>
        </a>
      </div>
      
      <div class="nav-item mt-4">
        <a class="nav-link text-warning" href="admin-login.html">
          <i class="bi bi-box-arrow-right"></i>
          <span class="sidebar-text">Logout</span>
        </a>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="admin-main" id="adminMain">
    <!-- Header -->
    <header class="admin-header">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4 class="fw-bold mb-0">Bookings Management</h4>
          <small class="text-muted">Monitor and manage accommodation bookings</small>
        </div>
        <div class="d-flex align-items-center gap-3">
          <button class="btn btn-primary" onclick="exportBookings()">
            <i class="bi bi-download me-2"></i>Export Bookings
          </button>
          <div class="dropdown">
            <button class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown" id="alertsDropdown">
              <i class="bi bi-bell"></i>
              <span class="notification-badge" id="headerNotificationBadge">0</span>
            </button>
            <div class="dropdown-menu dropdown-menu-end" id="alertsDropdownMenu">
              <h6 class="dropdown-header">Booking Alerts</h6>
              <div id="alertsContent">
                <!-- Alerts will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="admin-content">
      <!-- Stats Overview -->
      <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
          <div class="booking-card">
            <div class="d-flex align-items-center">
              <div class="bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                <i class="bi bi-calendar-week text-primary fs-4"></i>
              </div>
              <div>
                <h3 class="fw-bold mb-0" id="totalBookings">0</h3>
                <p class="text-muted mb-0">Total Bookings</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
          <div class="booking-card warning">
            <div class="d-flex align-items-center">
              <div class="bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                <i class="bi bi-clock text-warning fs-4"></i>
              </div>
              <div>
                <h3 class="fw-bold mb-0" id="pendingBookings">0</h3>
                <p class="text-muted mb-0">Pending</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
          <div class="booking-card success">
            <div class="d-flex align-items-center">
              <div class="bg-success bg-opacity-10 rounded-circle p-3 me-3">
                <i class="bi bi-check-circle text-success fs-4"></i>
              </div>
              <div>
                <h3 class="fw-bold mb-0" id="confirmedBookings">0</h3>
                <p class="text-muted mb-0">Confirmed</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
          <div class="booking-card info">
            <div class="d-flex align-items-center">
              <div class="bg-info bg-opacity-10 rounded-circle p-3 me-3">
                <i class="bi bi-calendar-event text-info fs-4"></i>
              </div>
              <div>
                <h3 class="fw-bold mb-0" id="upcomingBookings">0</h3>
                <p class="text-muted mb-0">Upcoming Today</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- View Toggle and Filters -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="view-toggle">
              <button class="view-toggle-btn active" onclick="switchView('table')">
                <i class="bi bi-list-ul me-2"></i>Table View
              </button>
              <button class="view-toggle-btn" onclick="switchView('calendar')">
                <i class="bi bi-calendar3 me-2"></i>Calendar View
              </button>
              <button class="view-toggle-btn" onclick="switchView('cards')">
                <i class="bi bi-grid-3x3 me-2"></i>Card View
              </button>
            </div>
            <div class="d-flex gap-2">
              <input type="date" class="form-control" id="dateFilter" style="width: auto;">
              <select class="form-select" id="statusFilter" style="width: auto;">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="confirmed">Confirmed</option>
                <option value="cancelled">Cancelled</option>
                <option value="completed">Completed</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Table View -->
      <div class="row" id="tableView">
        <div class="col-12">
          <div class="data-table">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
              <h5 class="fw-bold mb-0">Recent Bookings</h5>
              <div class="d-flex gap-2">
                <input type="text" class="form-control form-control-sm" placeholder="Search bookings..." id="searchInput" style="width: 200px;">
                <button class="btn btn-sm btn-primary" onclick="filterBookings()">
                  <i class="bi bi-search"></i>
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>Booking ID</th>
                    <th>Property</th>
                    <th>Student</th>
                    <th>Date & Time</th>
                    <th>Booking Type</th>
                    <th>Price</th> 
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="bookingsTable">
                  <tr>
                    <td colspan="7" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading bookings...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Calendar View -->
      <div class="row d-none" id="calendarView">
        <div class="col-12">
          <div class="calendar-view">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h5 class="fw-bold mb-0" id="calendarMonth">December 2024</h5>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" onclick="changeMonth(-1)">
                  <i class="bi bi-chevron-left"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="changeMonth(1)">
                  <i class="bi bi-chevron-right"></i>
                </button>
              </div>
            </div>
            <div class="row" id="calendarGrid">
              <!-- Calendar will be generated here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Card View -->
      <div class="row d-none" id="cardView">
        <div class="col-12">
          <div class="row" id="bookingsCards">
            <!-- Booking cards will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="data-table">
            <div class="p-3 border-bottom">
              <h5 class="fw-bold mb-0">Recent Activity</h5>
            </div>
            <div class="p-4">
              <div class="timeline" id="bookingTimeline">
                <!-- Real activity will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking Details Modal -->
  <div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Booking Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="bookingDetails">
          <!-- Booking details will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Global variables
    let currentView = 'table';
    let currentMonth = new Date();
    let allBookings = [];
    let filteredBookings = [];
    let recentActivity = [];
    let pendingReschedules = [];
    const API_BASE_URL = 'https://linqs-backend.onrender.com/api';

    // Sidebar Toggle
    document.getElementById('sidebarToggle').addEventListener('click', function() {
      document.getElementById('adminSidebar').classList.toggle('collapsed');
      document.getElementById('adminMain').classList.toggle('expanded');
    });

    // View Management
    function switchView(view) {
      currentView = view;
      
      // Update toggle buttons
      document.querySelectorAll('.view-toggle-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Show/hide views
      document.getElementById('tableView').classList.add('d-none');
      document.getElementById('calendarView').classList.add('d-none');
      document.getElementById('cardView').classList.add('d-none');
      
      document.getElementById(view + 'View').classList.remove('d-none');

      if (view === 'calendar') {
        generateCalendar();
      } else if (view === 'cards') {
        loadCardView();
      }
    }

    // Update your existing loadBookings function to include reschedule data
async function loadBookings() {
  try {
    console.log('Loading admin bookings...');
    
    const token = localStorage.getItem('token');
    if (!token) {
      throw new Error('No authentication token found');
    }

    const response = await fetch(`${API_BASE_URL}/admin/bookings`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    allBookings = data.data?.bookings || data.bookings || [];
    filteredBookings = [...allBookings];
    
    displayBookings(allBookings);
    updateBookingStats(allBookings);
    updateAlerts(allBookings);
    updateRecentActivity(allBookings);
    updateBookingDisplayWithReschedules(); // NEW: Add reschedule indicators
    loadPendingReschedules(); // NEW: Load pending reschedules
    
  } catch (error) {
    console.error('Error loading bookings:', error);
    showErrorState('Failed to load bookings: ' + error.message);
  }
}

    // Add this method to the script in admin-bookings.html
async function deleteBooking(bookingId) {
    if (!confirm('Are you sure you want to delete this booking? This action cannot be undone and all booking data will be permanently removed.')) {
        return;
    }

    try {
        console.log('Deleting booking:', bookingId);
        
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/admin/bookings/${bookingId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();
        
        if (response.ok && data.success) {
            showNotification('Booking deleted successfully!', 'success');
            await loadBookings(); // Reload to reflect changes
            
            // Close modal if open
            const modal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
            if (modal) modal.hide();
        } else {
            throw new Error(data.error || 'Failed to delete booking');
        }
    } catch (error) {
        console.error('Error deleting booking:', error);
        showNotification('Failed to delete booking: ' + error.message, 'danger');
    }
}

    // Filter bookings based on search and filters
    function filterBookings() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const dateFilter = document.getElementById('dateFilter').value;

      filteredBookings = allBookings.filter(booking => {
        // Search filter
        if (searchTerm) {
          const searchFields = [
            booking._id,
            booking.property?.title,
            booking.student?.username,
            booking.student?.email,
            booking.specialRequests
          ];
          const matchesSearch = searchFields.some(field => 
            field && field.toString().toLowerCase().includes(searchTerm)
          );
          if (!matchesSearch) return false;
        }

        // Status filter
        if (statusFilter && booking.status !== statusFilter) {
          return false;
        }

        // Date filter
        if (dateFilter) {
          const bookingDate = new Date(booking.checkIn).toISOString().split('T')[0];
          if (bookingDate !== dateFilter) {
            return false;
          }
        }

        return true;
      });

      displayBookings(filteredBookings);
      
      // Update current view
      if (currentView === 'calendar') {
        generateCalendar();
      } else if (currentView === 'cards') {
        loadCardView();
      }
    }

// SIMPLIFIED: Get display price with proper tenant/student detection
function getDisplayPrice(booking) {
  const negotiatedPrice = booking.negotiatedPrice || 0;
  const totalPrice = booking.totalPrice || 0;
  const basePrice = booking.property?.price || 0;
  
  // Debug logging to see what we're working with
  console.log('Booking pricing data:', {
    bookingId: booking._id,
    bookingType: booking.bookingType,
    bookingSource: booking.bookingSource,
    priceType: booking.priceType,
    negotiatedPrice: negotiatedPrice,
    totalPrice: totalPrice,
    basePrice: basePrice,
    studentRole: booking.student?.role,
    bookingMode: booking.student?.booking_mode
  });

  let displayPrice = 0;
  let priceType = booking.priceType || 'monthly';
  let priceLabel = '/month';

  // Determine price and type based on available prices
  if (negotiatedPrice > 0) {
    displayPrice = negotiatedPrice;
    priceType = 'negotiated';
    priceLabel = ' (negotiated)';
  } else if (totalPrice > 0) {
    displayPrice = totalPrice;
    
    // Use the priceType from backend aggregation
    if (priceType === 'daily') {
      priceLabel = '/day';
    } else {
      priceLabel = '/month';
    }
  } else if (basePrice > 0) {
    displayPrice = basePrice;
    priceType = 'base';
    priceLabel = '/month (base)';
  } else {
    // If all prices are 0, it's negotiable
    priceType = 'negotiable';
    priceLabel = ' (negotiable)';
  }
  
  // Format the display
  let formattedPrice = '';
  if (priceType === 'negotiable') {
    formattedPrice = `<span class="text-warning">Negotiable</span>`;
  } else if (displayPrice > 0) {
    formattedPrice = `R${displayPrice}${priceLabel}`;
  } else {
    formattedPrice = `<span class="text-muted">To be discussed</span>`;
  }
  
  return {
    amount: displayPrice,
    type: priceType,
    label: priceLabel,
    formatted: formattedPrice,
    isNegotiable: priceType === 'negotiable' || displayPrice === 0
  };
}

// SIMPLIFIED: Get enhanced booking type
function getEnhancedBookingType(booking) {
  // Use the backend aggregation field if available
  if (booking.bookingSource) {
    return booking.bookingSource;
  }
  
  // Fallback: Check booking type and user info
  const baseType = booking.bookingType || 'student';
  const studentRole = booking.student?.role || 'student';
  const bookingMode = booking.student?.booking_mode || 'student';
  
  if (baseType === 'tenant' || studentRole === 'tenant' || bookingMode === 'tenant') {
    return 'Tenant';
  } else if (baseType === 'short-term') {
    return 'Short-term';
  } else {
    return 'Student';
  }
}

// IMPROVED: Get booking source badge with better tenant detection
function getBookingSourceBadge(booking) {
  const source = booking.bookingSource || getEnhancedBookingType(booking);
  const priceInfo = getDisplayPrice(booking);
  
  const badges = {
    'Student': { class: 'bg-primary', text: 'Student', icon: 'bi-person' },
    'Tenant': { class: 'bg-success', text: 'Tenant', icon: 'bi-house' },
    'Tenant (Negotiated)': { class: 'bg-warning', text: 'Tenant (Negotiated)', icon: 'bi-currency-exchange' },
    'Tenant (Student Mode)': { class: 'bg-info', text: 'Tenant Mode', icon: 'bi-arrow-repeat' },
    'Short-term': { class: 'bg-secondary', text: 'Short-term', icon: 'bi-calendar-week' }
  };
  
  const config = badges[source] || badges['Student'];
  
  // Add negotiable indicator
  const negotiableBadge = priceInfo.isNegotiable ? 
    `<span class="badge bg-warning ms-1" title="Price is negotiable">
      <i class="bi bi-question-circle me-1"></i>Negotiable
    </span>` : '';
  
  return `<span class="badge ${config.class} me-1" title="${source}">
            <i class="${config.icon} me-1"></i>${config.text}
          </span>${negotiableBadge}`;
}

// In your displayBookings function, update the table headers and content:
function displayBookings(bookings) {
    const tbody = document.getElementById('bookingsTable');
    
    if (!bookings || bookings.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-4">
              <i class="bi bi-calendar-x fs-1 text-muted mb-3 d-block"></i>
              <p class="text-muted">No bookings found</p>
              <button class="btn btn-primary btn-sm" onclick="loadBookings()">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
              </button>
            </td>
          </tr>
        `;
        return;
    }

    tbody.innerHTML = bookings.map(booking => {
        // Safe property access with admin format
        const property = booking.property || {};
        const student = booking.student || {};
        const landlord = booking.landlord || {};
        
        // Check for deleted users/properties
        const isPropertyDeleted = property.title === '[Deleted Property]';
        const isStudentDeleted = student.firstName === '[Deleted User]';
        const isLandlordDeleted = landlord.firstName === '[Deleted User]';
        const hasDeletedEntity = isPropertyDeleted || isStudentDeleted || isLandlordDeleted;
        
        const propertyImage = property.images && property.images[0] 
          ? property.images[0] 
          : 'https://via.placeholder.com/40';
        
        const studentName = student.username || student.firstName 
          ? `${student.firstName || ''} ${student.surname || ''}`.trim() 
          : 'Unknown Student';
        
        const studentEmail = student.email || 'No email';
        const propertyName = property.title || 'Unknown Property';
        const status = booking.status || 'pending';
        
        // NEW: Get enhanced booking info
        const bookingSource = getBookingSourceBadge(booking);
        const priceInfo = getDisplayPrice(booking);
        const bookingType = extractBookingType(booking.specialRequests);
        const bookingTypeBadge = getBookingTypeBadge(bookingType);
        
        // Format date and time
        const dateTime = formatBookingDateTime(booking.checkIn);

        // Get initials for avatar
        const getInitials = (name) => {
          return name ? name.split(' ').map(n => n[0]).join('').toUpperCase() : '?';
        };

        // Generate action buttons based on booking status and deleted entities
        const actionButtons = generateActionButtons(booking, hasDeletedEntity);

        return `
          <tr data-booking-id="${booking._id}">
            <td>
              <strong>#${booking._id ? booking._id.slice(-6) : 'N/A'}</strong>
              ${hasDeletedEntity ? '<br><small class="text-danger">Contains Deleted Data</small>' : ''}
            </td>
            <td>
              <div class="d-flex align-items-center">
                <img src="${propertyImage}" 
                    class="rounded me-2" width="30" height="30" style="object-fit: cover;"
                    onerror="this.src='https://via.placeholder.com/40'">
                <span class="${isPropertyDeleted ? 'text-muted' : ''}">${propertyName}</span>
              </div>
            </td>
            <td>
              <div class="d-flex align-items-center">
                <div class="student-avatar me-2" style="width: 35px; height: 35px; border-radius: 50%; background: #1e3a8a; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem;">
                  ${getInitials(studentName)}
                </div>
                <div>
                  <div class="fw-bold small ${isStudentDeleted ? 'text-muted' : ''}">${studentName}</div>
                  <small class="text-muted">${studentEmail}</small>
                  ${isStudentDeleted ? '<small class="text-danger d-block"><i class="bi bi-exclamation-triangle"></i> Account Deleted</small>' : ''}
                </div>
              </div>
            </td>
            <td>
              <div class="fw-bold">${dateTime.date}</div>
              <div class="time-display">${dateTime.time}</div>
            </td>
            <td>
              ${bookingSource}
              ${bookingTypeBadge}
            </td>
            <td>
              <div class="fw-bold text-success">${priceInfo.formatted}</div>
              <small class="text-muted">${priceInfo.type}</small>
            </td>
            <td>
              <span class="status-badge status-${status}">${status}</span>
            </td>
            <td>
              ${actionButtons}
            </td>
          </tr>
        `;
    }).join('');
}

// NEW: Check if booking has pending reschedule request
function hasPendingReschedule(booking) {
  return booking.rescheduleRequests && 
         booking.rescheduleRequests.some(req => req.status === 'pending');
}

// NEW: Get latest reschedule request
function getLatestRescheduleRequest(booking) {
  if (!booking.rescheduleRequests || booking.rescheduleRequests.length === 0) {
    return null;
  }
  return booking.rescheduleRequests[booking.rescheduleRequests.length - 1];
}

// NEW: Load pending reschedules for alerts
async function loadPendingReschedules() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_BASE_URL}/admin/bookings/pending-reschedules`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      const data = await response.json();
      pendingReschedules = data.data?.bookings || [];
      updateRescheduleAlerts();
    }
  } catch (error) {
    console.error('Error loading pending reschedules:', error);
  }
}

// NEW: Update alerts to include reschedule notifications
function updateRescheduleAlerts() {
  const totalRescheduleAlerts = pendingReschedules.length;
  
  // Update notification badges with reschedule count
  const totalAlerts = parseInt(document.getElementById('sidebarNotificationBadge').textContent) + totalRescheduleAlerts;
  const headerBadge = document.getElementById('headerNotificationBadge');
  
  document.getElementById('sidebarNotificationBadge').textContent = totalAlerts;
  headerBadge.textContent = totalAlerts;
  
  // Add reschedule alerts to dropdown
  const alertsContent = document.getElementById('alertsContent');
  let alertsHTML = alertsContent.innerHTML;

  if (pendingReschedules.length > 0) {
    alertsHTML = `
      <div class="dropdown-item-text">
        <small class="text-info fw-bold">Pending Reschedules (${pendingReschedules.length})</small>
      </div>
    `;
    
    pendingReschedules.slice(0, 3).forEach(booking => {
      const studentName = booking.student?.username || 'Unknown Student';
      const propertyName = booking.property?.title || 'Unknown Property';
      const latestReschedule = getLatestRescheduleRequest(booking);
      const requestedTime = latestReschedule ? getTimeAgo(latestReschedule.requestedAt) : '';
      
      alertsHTML += `
        <a class="dropdown-item small" href="#" onclick="viewRescheduleRequest('${booking._id}')">
          <i class="bi bi-calendar-week text-info me-2"></i>
          ${studentName} - ${propertyName}
          <br><small class="text-muted">${requestedTime}</small>
        </a>
      `;
    });
    
    alertsHTML += `<div class="dropdown-divider"></div>` + alertsContent.innerHTML;
  }

  alertsContent.innerHTML = alertsHTML;
}

// NEW: View and manage reschedule request
async function viewRescheduleRequest(bookingId) {
  try {
    const token = localStorage.getItem('token');
    
    // Fetch booking with reschedule details
    const response = await fetch(`${API_BASE_URL}/admin/bookings/${bookingId}`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error('Failed to fetch booking details');
    }

    const data = await response.json();
    const booking = data.data?.booking || data.booking;
    const latestReschedule = getLatestRescheduleRequest(booking);

    if (!latestReschedule || latestReschedule.status !== 'pending') {
      alert('No pending reschedule request found for this booking.');
      return;
    }

    const modalContent = `
      <div class="alert alert-info">
        <h6><i class="bi bi-calendar-week me-2"></i>Reschedule Request - Admin Review</h6>
        <p class="mb-0">Student has requested to reschedule this viewing appointment.</p>
      </div>
      
      <div class="row">
        <div class="col-md-6">
          <h6>Current Schedule</h6>
          <div class="card bg-light">
            <div class="card-body">
              <p class="mb-1"><strong>Original Time:</strong></p>
              <p class="mb-0">${formatDateTime(latestReschedule.originalCheckIn)}</p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <h6>Requested New Time</h6>
          <div class="card bg-light">
            <div class="card-body">
              <p class="mb-1"><strong>New Time:</strong></p>
              <p class="mb-0">${formatDateTime(latestReschedule.newCheckIn)}</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row mt-3">
        <div class="col-12">
          <h6>Student's Reason</h6>
          <div class="alert alert-light">
            ${latestReschedule.reason || "No reason provided"}
          </div>
        </div>
      </div>
      
      <div class="row mt-3">
        <div class="col-12">
          <h6>Reschedule History</h6>
          <div class="small text-muted mb-2">
            Total reschedule requests: ${booking.rescheduleRequests?.length || 0}
          </div>
          ${booking.rescheduleRequests && booking.rescheduleRequests.length > 0 ? `
            <div class="list-group" style="max-height: 200px; overflow-y: auto;">
              ${booking.rescheduleRequests.map((req, index) => `
                <div class="list-group-item ${req.status === 'pending' ? 'list-group-item-warning' : req.status === 'approved' ? 'list-group-item-success' : 'list-group-item-danger'}">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <small class="text-muted">Request ${index + 1}</small>
                      <div><strong>From:</strong> ${formatDateTime(req.originalCheckIn)}</div>
                      <div><strong>To:</strong> ${formatDateTime(req.newCheckIn)}</div>
                      ${req.reason ? `<div><strong>Reason:</strong> ${req.reason}</div>` : ''}
                      <div><strong>Status:</strong> 
                        <span class="badge bg-${req.status === 'approved' ? 'success' : req.status === 'rejected' ? 'danger' : 'warning'}">
                          ${req.status}
                        </span>
                      </div>
                    </div>
                    <small class="text-muted">${formatDateTime(req.requestedAt)}</small>
                  </div>
                </div>
              `).join('')}
            </div>
          ` : '<p class="text-muted">No previous reschedule requests</p>'}
        </div>
      </div>
      
      <div class="row mt-3">
        <div class="col-12">
          <h6>Admin Response</h6>
          <form id="adminRescheduleResponseForm">
            <div class="mb-3">
              <label for="adminResponseAction" class="form-label">Action</label>
              <select class="form-select" id="adminResponseAction" required>
                <option value="">Choose action...</option>
                <option value="approve">Approve Reschedule</option>
                <option value="reject">Reject Reschedule</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="adminResponseReason" class="form-label">Admin Notes (Optional)</label>
              <textarea class="form-control" id="adminResponseReason" rows="3" placeholder="Add administrative notes..."></textarea>
            </div>
          </form>
        </div>
      </div>
      
      <div class="row mt-4">
        <div class="col-12">
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="submitAdminRescheduleResponse('${booking._id}')">
              <i class="bi bi-send me-1"></i>Submit Admin Response
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.getElementById('bookingDetails').innerHTML = modalContent;
    new bootstrap.Modal(document.getElementById('bookingModal')).show();
    
  } catch (error) {
    console.error('Error loading reschedule request:', error);
    alert('Failed to load reschedule request: ' + error.message);
  }
}

// NEW: Submit admin response to reschedule
async function submitAdminRescheduleResponse(bookingId) {
  const action = document.getElementById('adminResponseAction').value;
  const reason = document.getElementById('adminResponseReason').value;

  if (!action) {
    alert('Please select an action (approve or reject).');
    return;
  }

  try {
    const token = localStorage.getItem('token');
    
    // Show loading state
    const submitBtn = document.querySelector('#bookingModal .btn-primary');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
    submitBtn.disabled = true;

    const response = await fetch(`${API_BASE_URL}/admin/bookings/${bookingId}/admin-respond-reschedule`, {
      method: 'PATCH',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        action: action,
        responseReason: reason || 'Admin action'
      })
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to respond to reschedule request');
    }

    const result = await response.json();
    
    // Close the modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
    modal.hide();
    
    // Show success message
    showNotification(`Reschedule request ${action === 'approve' ? 'approved' : 'rejected'} successfully!`, 'success');
    
    // Reload bookings and reschedules to reflect changes
    await loadBookings();
    await loadPendingReschedules();
    
  } catch (error) {
    console.error('Error responding to reschedule:', error);
    alert('Failed to respond to reschedule request: ' + error.message);
    
    // Restore button state
    const submitBtn = document.querySelector('#bookingModal .btn-primary');
    if (submitBtn) {
      submitBtn.innerHTML = '<i class="bi bi-send me-1"></i>Submit Admin Response';
      submitBtn.disabled = false;
    }
  }
}

// NEW: Update booking display to show reschedule indicators
function updateBookingDisplayWithReschedules() {
  // Update table rows to show reschedule indicators
  const rows = document.querySelectorAll('#bookingsTable tr');
  rows.forEach(row => {
    const bookingId = row.getAttribute('data-booking-id');
    if (bookingId) {
      const booking = allBookings.find(b => b._id === bookingId);
      if (booking && hasPendingReschedule(booking)) {
        // Add reschedule indicator to the row
        const statusCell = row.querySelector('td:nth-child(6)'); // Status column
        if (statusCell) {
          const rescheduleBadge = `<span class="badge bg-info ms-1" title="Pending Reschedule"><i class="bi bi-calendar-week"></i></span>`;
          statusCell.innerHTML = statusCell.innerHTML + rescheduleBadge;
        }
      }
    }
  });

  // Update card view with reschedule indicators
  const cards = document.querySelectorAll('.booking-card-item');
  cards.forEach(card => {
    const bookingId = card.getAttribute('data-booking-id');
    if (bookingId) {
      const booking = allBookings.find(b => b._id === bookingId);
      if (booking && hasPendingReschedule(booking)) {
        // Add reschedule indicator to the card
        const header = card.querySelector('.d-flex.justify-content-between');
        if (header) {
          const rescheduleIndicator = `<span class="badge bg-info" title="Pending Reschedule Request"><i class="bi bi-calendar-week me-1"></i>Reschedule</span>`;
          header.innerHTML = header.innerHTML + rescheduleIndicator;
        }
      }
    }
  });
}

// NEW: Enhanced booking details modal to show reschedule info
function createBookingModalContentWithReschedules(booking) {
  const baseContent = createBookingModalContent(booking); // Your existing function
  const hasReschedules = booking.rescheduleRequests && booking.rescheduleRequests.length > 0;
  
  if (!hasReschedules) {
    return baseContent;
  }

  // Insert reschedule section before the action buttons
  const rescheduleSection = `
    <div class="row mt-3">
      <div class="col-12">
        <h6>Reschedule History</h6>
        <div class="list-group">
          ${booking.rescheduleRequests.map((req, index) => `
            <div class="list-group-item ${req.status === 'pending' ? 'list-group-item-warning' : req.status === 'approved' ? 'list-group-item-success' : 'list-group-item-danger'}">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <small class="text-muted">Request ${index + 1}</small>
                  <div><strong>From:</strong> ${formatDateTime(req.originalCheckIn)}</div>
                  <div><strong>To:</strong> ${formatDateTime(req.newCheckIn)}</div>
                  ${req.reason ? `<div><strong>Reason:</strong> ${req.reason}</div>` : ''}
                  <div><strong>Status:</strong> 
                    <span class="badge bg-${req.status === 'approved' ? 'success' : req.status === 'rejected' ? 'danger' : 'warning'}">
                      ${req.status}
                    </span>
                  </div>
                  ${req.responseReason ? `<div><strong>Response:</strong> ${req.responseReason}</div>` : ''}
                </div>
                <small class="text-muted">${formatDateTime(req.requestedAt)}</small>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;

  // Find where to insert the reschedule section (before action buttons)
  const actionButtonsIndex = baseContent.indexOf('<div class="row mt-4">');
  
  if (actionButtonsIndex !== -1) {
    return baseContent.slice(0, actionButtonsIndex) + rescheduleSection + baseContent.slice(actionButtonsIndex);
  }
  
  return baseContent + rescheduleSection;
}

// NEW: Format date time helper
function formatDateTime(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return date.toLocaleString('en-ZA', {
    weekday: 'short',
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

    // Update your existing updateAlerts function to work with reschedules
function updateAlerts(bookings) {
  const pendingBookings = bookings.filter(b => b.status === 'pending');
  const today = new Date().toDateString();
  const upcomingToday = bookings.filter(b => {
    if (b.status !== 'confirmed') return false;
    const bookingDate = new Date(b.checkIn).toDateString();
    return bookingDate === today;
  });

  // Remove the badge updates from here since they're handled by updateRescheduleAlerts
  // Just update the alerts content
  updateAlertsContent(pendingBookings, upcomingToday);
}

function updateAlertsContent(pendingBookings, upcomingToday) {
  const alertsContent = document.getElementById('alertsContent');
  let alertsHTML = '';

  if (pendingBookings.length > 0) {
    alertsHTML += `
      <div class="dropdown-item-text">
        <small class="text-warning fw-bold">Pending Bookings (${pendingBookings.length})</small>
      </div>
    `;
    pendingBookings.slice(0, 3).forEach(booking => {
      const studentName = booking.student?.username || 'Unknown Student';
      const propertyName = booking.property?.title || 'Unknown Property';
      alertsHTML += `
        <a class="dropdown-item small" href="#" onclick="viewBooking('${booking._id}')">
          <i class="bi bi-clock text-warning me-2"></i>
          ${studentName} - ${propertyName}
        </a>
      `;
    });
  }

  if (upcomingToday.length > 0) {
    alertsHTML += pendingBookings.length > 0 ? `<div class="dropdown-divider"></div>` : '';
    alertsHTML += `
      <div class="dropdown-item-text">
        <small class="text-info fw-bold">Upcoming Today (${upcomingToday.length})</small>
      </div>
    `;
    upcomingToday.slice(0, 3).forEach(booking => {
      const studentName = booking.student?.username || 'Unknown Student';
      const propertyName = booking.property?.title || 'Unknown Property';
      const time = new Date(booking.checkIn).toLocaleTimeString('en-ZA', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      alertsHTML += `
        <a class="dropdown-item small" href="#" onclick="viewBooking('${booking._id}')">
          <i class="bi bi-calendar-event text-info me-2"></i>
          ${time} - ${studentName} - ${propertyName}
        </a>
      `;
    });
  }

  if (pendingBookings.length === 0 && upcomingToday.length === 0) {
    alertsHTML = `
      <div class="dropdown-item-text text-muted">
        <small>No booking alerts</small>
      </div>
    `;
  }

  alertsContent.innerHTML = alertsHTML;
}

    // Update recent activity
    function updateRecentActivity(bookings) {
      const timeline = document.getElementById('bookingTimeline');
      
      // Sort bookings by creation date (newest first) and take latest 5
      const recentBookings = [...bookings]
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
        .slice(0, 5);

      if (recentBookings.length === 0) {
        timeline.innerHTML = `
          <div class="text-center text-muted py-4">
            <i class="bi bi-calendar-x fs-1 mb-3 d-block"></i>
            <p>No recent activity</p>
          </div>
        `;
        return;
      }

      timeline.innerHTML = recentBookings.map(booking => {
        const studentName = booking.student?.username || 'Unknown Student';
        const propertyName = booking.property?.title || 'Unknown Property';
        const timeAgo = getTimeAgo(booking.createdAt);
        const statusConfig = getStatusConfig(booking.status);

        return `
          <div class="timeline-item">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="fw-bold mb-1">${statusConfig.action} - ${propertyName}</h6>
                <p class="text-muted mb-1">${studentName} - ${statusConfig.description}</p>
                <small class="text-muted">${timeAgo}</small>
              </div>
              <span class="status-badge status-${booking.status}">${booking.status}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function getStatusConfig(status) {
      const configs = {
        pending: { action: 'New Booking Request', description: 'Waiting for confirmation' },
        confirmed: { action: 'Booking Confirmed', description: 'Viewing scheduled' },
        cancelled: { action: 'Booking Cancelled', description: 'Booking was cancelled' },
        completed: { action: 'Booking Completed', description: 'Viewing completed' }
      };
      return configs[status] || { action: 'Booking Updated', description: 'Status changed' };
    }

    function getTimeAgo(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins} minutes ago`;
      if (diffHours < 24) return `${diffHours} hours ago`;
      if (diffDays < 7) return `${diffDays} days ago`;
      return date.toLocaleDateString('en-ZA');
    }

    // Extract booking type from special requests
    function extractBookingType(specialRequests) {
      if (!specialRequests) return 'viewing';
      
      const requests = specialRequests.toLowerCase();
      if (requests.includes('viewing + contract') || requests.includes('viewing and contract')) {
        return 'both';
      } else if (requests.includes('contract only') || requests.includes('contract finalization')) {
        return 'contract';
      } else {
        return 'viewing';
      }
    }

    // Get booking type badge HTML
    function getBookingTypeBadge(type) {
      const types = {
        'viewing': { class: 'booking-type-viewing', text: 'Viewing Only', icon: 'bi-eye' },
        'contract': { class: 'booking-type-contract', text: 'Contract Only', icon: 'bi-pen' },
        'both': { class: 'booking-type-both', text: 'Viewing + Contract', icon: 'bi-house-check' }
      };
      
      const config = types[type] || types['viewing'];
      return `<span class="booking-type-badge ${config.class}">
                <i class="${config.icon} me-1"></i>${config.text}
              </span>`;
    }

    // Format booking date and time
    function formatBookingDateTime(dateTimeString) {
      if (!dateTimeString) return { date: 'N/A', time: 'N/A' };
      
      const date = new Date(dateTimeString);
      const options = { 
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      };
      
      return {
        date: date.toLocaleDateString('en-ZA', options),
        time: date.toLocaleTimeString('en-ZA', { 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: false 
        })
      };
    }

    // Update booking statistics
    function updateBookingStats(bookings) {
      const totalBookings = bookings.length;
      const pendingBookings = bookings.filter(b => b.status === 'pending').length;
      const confirmedBookings = bookings.filter(b => b.status === 'confirmed').length;
      
      // Count upcoming bookings for today
      const today = new Date().toDateString();
      const upcomingBookings = bookings.filter(b => {
        if (b.status !== 'confirmed') return false;
        const bookingDate = new Date(b.checkIn).toDateString();
        return bookingDate === today;
      }).length;

      document.getElementById('totalBookings').textContent = totalBookings;
      document.getElementById('pendingBookings').textContent = pendingBookings;
      document.getElementById('confirmedBookings').textContent = confirmedBookings;
      document.getElementById('upcomingBookings').textContent = upcomingBookings;
    }

    // Generate calendar view with real data
        // Generate calendar view with real data - FIXED DATE MATCHING
    function generateCalendar() {
      const calendarGrid = document.getElementById('calendarGrid');
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      
      document.getElementById('calendarMonth').textContent = 
        `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;

      // Get first day of month and number of days
      const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
      const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDay = firstDay.getDay();

      let calendarHTML = '';
      
      // Add empty cells for days before the first day of the month
      for (let i = 0; i < startingDay; i++) {
        calendarHTML += `<div class="col-3 col-md-2 col-lg-1 mb-2"></div>`;
      }

      // Add days of the month
      const today = new Date();
      for (let i = 1; i <= daysInMonth; i++) {
        const currentDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), i);
        
        // FIXED: Use local date string without timezone conversion
        const dateString = formatDateToLocalString(currentDate);
        
        // Find bookings for this date - FIXED: Use proper date comparison
        const dayBookings = filteredBookings.filter(booking => {
          const bookingDate = new Date(booking.checkIn);
          return isSameDay(bookingDate, currentDate);
        });

        const isToday = isSameDay(currentDate, today);
        const hasBooking = dayBookings.length > 0;

        calendarHTML += `
          <div class="col-3 col-md-2 col-lg-1 mb-2">
            <div class="calendar-day ${hasBooking ? 'has-booking' : ''} ${isToday ? 'today' : ''}" 
                 onclick="viewDayBookings('${dateString}')">
              <div class="fw-bold">${i}</div>
              ${dayBookings.slice(0, 2).map(booking => {
                const studentName = booking.student?.username || 'Student';
                const status = booking.status;
                return `<div class="calendar-booking" style="background: ${getStatusColorHex(status)}">${studentName}</div>`;
              }).join('')}
              ${dayBookings.length > 2 ? `<small class="text-muted">+${dayBookings.length - 2} more</small>` : ''}
            </div>
          </div>
        `;
      }
      
      calendarGrid.innerHTML = calendarHTML;
    }

    // FIXED: Helper function to check if two dates are the same day (ignoring time)
    function isSameDay(date1, date2) {
      return date1.getFullYear() === date2.getFullYear() &&
             date1.getMonth() === date2.getMonth() &&
             date1.getDate() === date2.getDate();
    }

    // FIXED: Format date to local string without timezone issues
    function formatDateToLocalString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function getStatusColorHex(status) {
      const colors = {
        pending: '#f59e0b',
        confirmed: '#059669',
        cancelled: '#dc2626',
        completed: '#60a5fa'
      };
      return colors[status] || '#1e3a8a';
    }

    // FIXED: View day bookings with proper date handling
    function viewDayBookings(dateString) {
      const [year, month, day] = dateString.split('-').map(Number);
      const targetDate = new Date(year, month - 1, day);
      
      const dayBookings = filteredBookings.filter(booking => {
        const bookingDate = new Date(booking.checkIn);
        return isSameDay(bookingDate, targetDate);
      });

      if (dayBookings.length > 0) {
        const modalContent = `
          <h6>Bookings for ${targetDate.toLocaleDateString('en-ZA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h6>
          <div class="mt-3">
            ${dayBookings.map(booking => {
              const studentName = booking.student?.username || 'Unknown Student';
              const propertyName = booking.property?.title || 'Unknown Property';
              const time = new Date(booking.checkIn).toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });
              return `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                  <div>
                    <strong>${studentName}</strong><br>
                    <small>${propertyName} - ${time}</small>
                  </div>
                  <span class="status-badge status-${booking.status}">${booking.status}</span>
                </div>
              `;
            }).join('')}
          </div>
        `;
        document.getElementById('bookingDetails').innerHTML = modalContent;
        new bootstrap.Modal(document.getElementById('bookingModal')).show();
      }
    }

    // Load card view with real data
    // Update the loadCardView function to include pricing info
// Update the card view pricing display
function loadCardView() {
    const cardsContainer = document.getElementById('bookingsCards');
    
    if (filteredBookings.length === 0) {
        cardsContainer.innerHTML = `
          <div class="col-12 text-center py-4">
            <i class="bi bi-calendar-x fs-1 text-muted mb-3"></i>
            <p class="text-muted">No bookings found</p>
          </div>
        `;
        return;
    }

    cardsContainer.innerHTML = filteredBookings.map(booking => {
        const property = booking.property || {};
        const student = booking.student || {};
        const landlord = booking.landlord || {};
        
        const studentName = student.username || 'Unknown Student';
        const propertyName = property.title || 'Unknown Property';
        const landlordName = landlord.username || 'Unknown Landlord';
        const dateTime = formatBookingDateTime(booking.checkIn);
        const bookingType = extractBookingType(booking.specialRequests);

        // NEW: Get enhanced booking info
        const bookingSource = getBookingSourceBadge(booking);
        const priceInfo = getDisplayPrice(booking);

        // Generate card action buttons based on status
        const cardActionButtons = generateCardActionButtons(booking);

        return `
          <div class="col-lg-4 col-md-6 mb-3">
            <div class="booking-card-item ${booking.status}">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                  <h6 class="fw-bold mb-1">${propertyName}</h6>
                  <small class="text-muted">${landlordName}</small>
                </div>
                <span class="status-badge status-${booking.status}">${booking.status}</span>
              </div>
              
              <div class="d-flex align-items-center mb-2">
                <div class="student-avatar me-2" style="width: 35px; height: 35px; border-radius: 50%; background: #1e3a8a; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem;">
                  ${getInitials(studentName)}
                </div>
                <div>
                  <div class="fw-bold small">${studentName}</div>
                  <small class="text-muted">${student.email || 'No email'}</small>
                </div>
              </div>
              
              <div class="mb-2">
                <i class="bi bi-calendar me-2"></i>
                <strong>${dateTime.date}</strong>
              </div>
              <div class="mb-2">
                <i class="bi bi-clock me-2"></i>
                <span class="time-display">${dateTime.time}</span>
              </div>
              
              <!-- NEW: Booking Source and Pricing -->
              <div class="mb-2">
                ${bookingSource}
                ${getBookingTypeBadge(bookingType)}
              </div>
              
              <div class="mb-3">
                <div class="${priceInfo.isNegotiable ? 'text-warning fw-bold fs-5' : 'text-success fw-bold fs-5'}">
                  ${priceInfo.formatted}
                </div>
                <small class="text-muted">${getEnhancedBookingType(booking)}  ${priceInfo.type} pricing</small>
                ${booking.negotiatedPrice > 0 ? `
                  <div class="mt-1">
                    <small class="text-success">
                      <i class="bi bi-check-circle me-1"></i>Negotiated price
                    </small>
                  </div>
                ` : ''}
                ${priceInfo.isNegotiable ? `
                  <div class="mt-1">
                    <small class="text-warning">
                      <i class="bi bi-info-circle me-1"></i>Price to be discussed
                    </small>
                  </div>
                ` : ''}
              </div>
              
              <div class="d-flex gap-1">
                ${cardActionButtons}
              </div>
            </div>
          </div>
        `;
    }).join('');


// Update generateCardActionButtons to include delete option
function generateCardActionButtons(booking) {
    const status = booking.status || 'pending';
    
    // Check for deleted entities
    const property = booking.property || {};
    const student = booking.student || {};
    const landlord = booking.landlord || {};
    const hasDeletedEntity = property.title === '[Deleted Property]' || 
                           student.firstName === '[Deleted User]' || 
                           landlord.firstName === '[Deleted User]';
    
    // If there are deleted entities, show delete prominently
    if (hasDeletedEntity) {
        return `
            <button class="btn btn-sm btn-outline-primary flex-fill" onclick="viewBooking('${booking._id}')">
                <i class="bi bi-eye"></i> Details
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteBooking('${booking._id}')" title="Delete Booking">
                <i class="bi bi-trash"></i>
            </button>
        `;
    }
    
    switch(status) {
        case 'completed':
            return `
                <button class="btn btn-sm btn-outline-primary flex-fill" onclick="viewBooking('${booking._id}')">
                    <i class="bi bi-eye"></i> Details
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteBooking('${booking._id}')" title="Delete Booking">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            
        case 'confirmed':
            return `
                <button class="btn btn-sm btn-outline-primary flex-fill" onclick="viewBooking('${booking._id}')">
                    <i class="bi bi-eye"></i> Details
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="updateBookingStatus('${booking._id}', 'cancelled')" title="Cancel Booking">
                    <i class="bi bi-x"></i>
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="sendReminder('${booking._id}')" title="Send Reminder">
                    <i class="bi bi-bell"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="deleteBooking('${booking._id}')" title="Delete Booking">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            
        case 'cancelled':
            return `
                <button class="btn btn-sm btn-outline-primary flex-fill" onclick="viewBooking('${booking._id}')">
                    <i class="bi bi-eye"></i> Details
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteBooking('${booking._id}')" title="Delete Booking">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            
        case 'pending':
        default:
            return `
                <button class="btn btn-sm btn-outline-primary flex-fill" onclick="viewBooking('${booking._id}')">
                    <i class="bi bi-eye"></i> Details
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="updateBookingStatus('${booking._id}', 'confirmed')" title="Confirm Booking">
                    <i class="bi bi-check"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="updateBookingStatus('${booking._id}', 'cancelled')" title="Cancel Booking">
                    <i class="bi bi-x"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="deleteBooking('${booking._id}')" title="Delete Booking">
                    <i class="bi bi-trash"></i>
                </button>
            `;
    }
}

    cardsContainer.innerHTML = filteredBookings.map(booking => {
        const property = booking.property || {};
        const student = booking.student || {};
        const landlord = booking.landlord || {};
        
        const studentName = student.username || 'Unknown Student';
        const propertyName = property.title || 'Unknown Property';
        const landlordName = landlord.username || 'Unknown Landlord';
        const dateTime = formatBookingDateTime(booking.checkIn);
        const bookingType = extractBookingType(booking.specialRequests);

        // Generate card action buttons based on status
        const cardActionButtons = generateCardActionButtons(booking);

        return `
          <div class="col-lg-4 col-md-6 mb-3">
            <div class="booking-card-item ${booking.status}">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                  <h6 class="fw-bold mb-1">${propertyName}</h6>
                  <small class="text-muted">${landlordName}</small>
                </div>
                <span class="status-badge status-${booking.status}">${booking.status}</span>
              </div>
              
              <div class="d-flex align-items-center mb-2">
                <div class="student-avatar me-2" style="width: 35px; height: 35px; border-radius: 50%; background: #1e3a8a; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem;">
                  ${getInitials(studentName)}
                </div>
                <div>
                  <div class="fw-bold small">${studentName}</div>
                  <small class="text-muted">${student.email || 'No email'}</small>
                </div>
              </div>
              
              <div class="mb-2">
                <i class="bi bi-calendar me-2"></i>
                <strong>${dateTime.date}</strong>
              </div>
              <div class="mb-2">
                <i class="bi bi-clock me-2"></i>
                <span class="time-display">${dateTime.time}</span>
              </div>
              <div class="mb-3">
                ${getBookingTypeBadge(bookingType)}
              </div>
              
              <div class="d-flex gap-1">
                ${cardActionButtons}
              </div>
            </div>
          </div>
        `;
    }).join('');
}

    function getInitials(name) {
      return name ? name.split(' ').map(n => n[0]).join('').toUpperCase() : '?';
    }

    function changeMonth(direction) {
      currentMonth.setMonth(currentMonth.getMonth() + direction);
      generateCalendar();
    }

    async function updateBookingStatus(bookingId, status) {
      if (!confirm(`Are you sure you want to ${status} this booking?`)) {
        return;
      }

      try {
        const token = localStorage.getItem('token');
        
        // Use admin endpoint for status updates
        const response = await fetch(`${API_BASE_URL}/admin/bookings/${bookingId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ 
            status: status,
            adminNotes: `Status updated to ${status} by administrator`
          })
        });

        if (!response.ok) {
          throw new Error('Failed to update booking status');
        }

        const data = await response.json();
        alert('Booking status updated successfully');
        loadBookings(); // Reload to reflect changes
        
      } catch (error) {
        console.error('Error updating booking status:', error);
        alert('Error updating booking status: ' + error.message);
      }
    }

    function showErrorState(message) {
      const tbody = document.getElementById('bookingsTable');
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="text-center py-4">
            <i class="bi bi-exclamation-triangle fs-1 text-danger mb-3 d-block"></i>
            <p class="text-danger mb-2">${message}</p>
            <button class="btn btn-primary btn-sm" onclick="loadBookings()">
              <i class="bi bi-arrow-clockwise me-1"></i>Try Again
            </button>
          </td>
        </tr>
      `;
    }

  // FIXED: View booking details function
async function viewBooking(bookingId) {
  try {
    const token = localStorage.getItem('token');
    
    // Use admin endpoint for booking details
    const response = await fetch(`${API_BASE_URL}/admin/bookings/${bookingId}`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error('Failed to fetch booking details');
    }

    const data = await response.json();
    const booking = data.data?.booking || data.booking || data;

    // Debug the booking data to see what we're getting
    console.log('Booking details for modal:', {
      bookingId: booking._id,
      bookingType: booking.bookingType,
      studentRole: booking.student?.role,
      bookingMode: booking.student?.booking_mode,
      negotiatedPrice: booking.negotiatedPrice,
      totalPrice: booking.totalPrice,
      propertyPrice: booking.property?.price
    });

    // Create modal content
    const modalContent = createBookingModalContent(booking);
    document.getElementById('bookingDetails').innerHTML = modalContent;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
    modal.show();
    
  } catch (error) {
    console.error('Error loading booking details:', error);
    alert('Failed to load booking details: ' + error.message);
  }
}

    // Update createBookingModalContent to show delete option and indicate deleted entities
// Update createBookingModalContent to show tenant/student info and pricing// Update the booking modal to show detailed pricing information
function createBookingModalContent(booking) {
    const property = booking.property || {};
    const student = booking.student || {};
    const landlord = booking.landlord || {};

    // Check for deleted entities
    const isPropertyDeleted = property.title === '[Deleted Property]';
    const isStudentDeleted = student.firstName === '[Deleted User]';
    const isLandlordDeleted = landlord.firstName === '[Deleted User]';
    const hasDeletedEntity = isPropertyDeleted || isStudentDeleted || isLandlordDeleted;

    // Format date function
    const formatDateTime = (dateString) => {
        const date = new Date(dateString);
        const options = { 
          weekday: 'short', 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        };
        return date.toLocaleDateString('en-ZA', options);
    };

    // NEW: Get enhanced booking info
    const bookingSource = getEnhancedBookingType(booking);
    const priceInfo = getDisplayPrice(booking);
    const studentRole = student.role || 'student';
    const bookingMode = student.booking_mode || 'student';

    // Extract booking type
    const bookingType = extractBookingType(booking.specialRequests);
    const bookingTypeConfig = {
        'viewing': { text: 'Viewing Only', description: 'Student wants to view the property' },
        'contract': { text: 'Contract Only', description: 'Student wants to finalize contract' },
        'both': { text: 'Viewing + Contract', description: 'Student wants to view and potentially sign contract' }
    };

    const bookingTypeInfo = bookingTypeConfig[bookingType] || bookingTypeConfig['viewing'];

    return `
        ${hasDeletedEntity ? `
        <div class="alert alert-warning mb-3">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> This booking contains deleted ${isPropertyDeleted ? 'property' : ''}${isPropertyDeleted && (isStudentDeleted || isLandlordDeleted) ? ', ' : ''}${isStudentDeleted ? 'student account' : ''}${isStudentDeleted && isLandlordDeleted ? ', ' : ''}${isLandlordDeleted ? 'landlord account' : ''}. Consider deleting this booking to clean up your data.
        </div>
        ` : ''}
        
        <!-- IMPROVED: Booking Source and Pricing Header -->
        <div class="alert ${priceInfo.isNegotiable ? 'alert-warning' : 'alert-info'} mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1">${bookingSource} Booking</h6>
                    <p class="mb-0">User Role: ${studentRole} | Booking Mode: ${bookingMode}</p>
                </div>
                <div class="text-end">
                    <h4 class="${priceInfo.isNegotiable ? 'text-warning' : 'text-success'} mb-0">
                        ${priceInfo.formatted}
                    </h4>
                    <small class="text-muted">${priceInfo.type} pricing</small>
                    ${priceInfo.isNegotiable ? `
                        <div class="mt-1">
                            <small><i class="bi bi-info-circle me-1"></i>Price requires negotiation</small>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <h6>Student Information</h6>
            <p><strong>Name:</strong> ${student.username || 'Unknown'} ${isStudentDeleted ? '<span class="badge bg-danger ms-2">Deleted</span>' : ''}</p>
            <p><strong>Email:</strong> ${student.email || 'No email'}</p>
            <p><strong>Phone:</strong> ${student.phone || 'No phone'}</p>
            <p><strong>Role:</strong> ${studentRole}</p>
            <p><strong>Booking Mode:</strong> ${bookingMode}</p>
            ${student.university ? `<p><strong>University:</strong> ${student.university}</p>` : ''}
            ${student.course ? `<p><strong>Course:</strong> ${student.course}</p>` : ''}
          </div>
          <div class="col-md-6">
            <h6>Property Information</h6>
            <p><strong>Property:</strong> ${property.title || 'Unknown'} ${isPropertyDeleted ? '<span class="badge bg-danger ms-2">Deleted</span>' : ''}</p>
            <p><strong>Landlord:</strong> ${landlord.username || 'Unknown'} ${isLandlordDeleted ? '<span class="badge bg-danger ms-2">Deleted</span>' : ''}</p>
            <p><strong>Location:</strong> ${property.location?.address || 'No address'}</p>
            <p><strong>Base Price:</strong> R${property.price || 0}/month</p>
            ${property.acceptsShortTerm ? `<p><strong>Short-term:</strong> ${property.acceptsShortTerm ? 'Yes' : 'No'}</p>` : ''}
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-6">
            <h6>Booking Details</h6>
            <p><strong>Date & Time:</strong> ${booking.checkIn ? formatDateTime(booking.checkIn) : 'N/A'}</p>
            <p><strong>Duration:</strong> ${booking.duration || '2 hours (estimated)'}</p>
            <p><strong>Booking Type:</strong> ${bookingTypeInfo.text}</p>
            <p><strong>Description:</strong> ${bookingTypeInfo.description}</p>
          </div>
          <div class="col-md-6">
            <h6>Pricing Details</h6>
            <p><strong>Total Price:</strong> R${booking.totalPrice || 0}</p>
            ${booking.negotiatedPrice > 0 ? `
                <p><strong>Negotiated Price:</strong> R${booking.negotiatedPrice}</p>
                <p class="text-success"><i class="bi bi-check-circle me-1"></i>Price has been negotiated</p>
            ` : priceInfo.isNegotiable ? `
                <p class="text-warning"><i class="bi bi-question-circle me-1"></i>Price requires negotiation</p>
            ` : ''}
            ${booking.stayDuration ? `<p><strong>Stay Duration:</strong> ${booking.stayDuration}</p>` : ''}
            <p><strong>Price Type:</strong> ${priceInfo.type}</p>
            <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(booking.status)}">${booking.status || 'pending'}</span></p>
            <p><strong>Created:</strong> ${booking.createdAt ? formatDateTime(booking.createdAt) : 'N/A'}</p>
            <p><strong>Last Updated:</strong> ${booking.updatedAt ? formatDateTime(booking.updatedAt) : 'N/A'}</p>
          </div>
        </div>
        ${booking.specialRequests ? `
        <div class="row mt-3">
          <div class="col-12">
            <h6>Special Requests & Notes</h6>
            <div class="alert alert-light">${booking.specialRequests}</div>
          </div>
        </div>
        ` : ''}
        ${booking.cancellationReason ? `
        <div class="row mt-3">
          <div class="col-12">
            <h6>Cancellation Reason</h6>
            <div class="alert alert-warning">${booking.cancellationReason}</div>
          </div>
        </div>
        ` : ''}
        ${booking.adminNotes ? `
        <div class="row mt-3">
          <div class="col-12">
            <h6>Admin Notes</h6>
            <div class="alert alert-info">${booking.adminNotes}</div>
          </div>
        </div>
        ` : ''}
        
        <div class="row mt-4">
          <div class="col-12">
            <div class="d-flex justify-content-end gap-2">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              ${hasDeletedEntity ? `
                <button type="button" class="btn btn-danger" onclick="deleteBooking('${booking._id}')">
                  <i class="bi bi-trash me-2"></i>Delete Booking
                </button>
              ` : `
                <button type="button" class="btn btn-outline-danger" onclick="deleteBooking('${booking._id}')">
                  <i class="bi bi-trash me-2"></i>Delete
                </button>
              `}
            </div>
          </div>
        </div>
    `;
}

    function getStatusColor(status) {
      const colors = {
        pending: 'warning',
        confirmed: 'success',
        cancelled: 'danger',
        completed: 'info'
      };
      return colors[status] || 'secondary';
    }

    // NEW: Generate action buttons based on booking status
// Update generateActionButtons to include delete option, especially for deleted entities
// Update generateActionButtons to include delete option, especially for deleted entities
function generateActionButtons(booking, hasDeletedEntity = false) {
    const status = booking.status || 'pending';
    
    // If there are deleted entities, make delete option more prominent
    if (hasDeletedEntity) {
        return `
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-danger dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-trash"></i> Cleanup
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="viewBooking('${booking._id}')">
                        <i class="bi bi-eye me-2"></i>View Details
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger fw-bold" href="#" onclick="deleteBooking('${booking._id}')">
                        <i class="bi bi-trash me-2"></i>Delete Booking
                    </a></li>
                </ul>
            </div>
        `;
    }
    
    switch(status) {
        case 'completed':
            return `
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        Actions
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="viewBooking('${booking._id}')">
                            <i class="bi bi-eye me-2"></i>View Details
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteBooking('${booking._id}')">
                            <i class="bi bi-trash me-2"></i>Delete
                        </a></li>
                    </ul>
                </div>
            `;
            
        case 'confirmed':
            return `
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        Actions
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="viewBooking('${booking._id}')">
                            <i class="bi bi-eye me-2"></i>View Details
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="updateBookingStatus('${booking._id}', 'cancelled')">
                            <i class="bi bi-x-circle me-2"></i>Cancel
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-info" href="#" onclick="sendReminder('${booking._id}')">
                            <i class="bi bi-bell me-2"></i>Send Reminder
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteBooking('${booking._id}')">
                            <i class="bi bi-trash me-2"></i>Delete
                        </a></li>
                    </ul>
                </div>
            `;
            
        case 'cancelled':
            return `
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        Actions
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="viewBooking('${booking._id}')">
                            <i class="bi bi-eye me-2"></i>View Details
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteBooking('${booking._id}')">
                            <i class="bi bi-trash me-2"></i>Delete
                        </a></li>
                    </ul>
                </div>
            `;
            
        case 'pending':
        default:
            return `
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        Actions
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="viewBooking('${booking._id}')">
                            <i class="bi bi-eye me-2"></i>View Details
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="updateBookingStatus('${booking._id}', 'confirmed')">
                            <i class="bi bi-check-circle me-2"></i>Confirm
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="updateBookingStatus('${booking._id}', 'cancelled')">
                            <i class="bi bi-x-circle me-2"></i>Cancel
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteBooking('${booking._id}')">
                            <i class="bi bi-trash me-2"></i>Delete
                        </a></li>
                    </ul>
                </div>
            `;
    }
}

   // NEW: Enhanced sendReminder function with email sending
async function sendReminder(bookingId) {
    try {
        const booking = allBookings.find(b => b._id === bookingId);
        if (!booking) {
            showNotification('Booking not found', 'danger');
            return;
        }

        const studentName = booking.student?.username || 'Student';
        const propertyName = booking.property?.title || 'Property';
        const dateTime = formatBookingDateTime(booking.checkIn);

        // Create a modal for reminder options
        const reminderModalContent = `
            <div class="mb-4">
                <h6>Send Reminder for Booking</h6>
                <p class="text-muted">Send reminder emails to both student and landlord about the upcoming viewing.</p>
                
                <div class="alert alert-info">
                    <strong>Booking Details:</strong><br>
                    <strong>Student:</strong> ${studentName}<br>
                    <strong>Property:</strong> ${propertyName}<br>
                    <strong>Date:</strong> ${dateTime.date}<br>
                    <strong>Time:</strong> ${dateTime.time}
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Reminder Type</label>
                <select class="form-select" id="reminderType">
                    <option value="general">General Reminder</option>
                    <option value="24_hours">24 Hours Before</option>
                    <option value="same_day">Same Day Reminder</option>
                    <option value="1_hour">1 Hour Before</option>
                    <option value="custom">Custom Message</option>
                </select>
            </div>
            
            <div class="mb-3" id="customMessageContainer" style="display: none;">
                <label class="form-label">Custom Message</label>
                <textarea class="form-control" id="customMessage" rows="3" placeholder="Enter your custom reminder message..."></textarea>
                <div class="form-text">This message will be included in the reminder email.</div>
            </div>
            
            <div class="alert alert-warning">
                <i class="bi bi-info-circle me-2"></i>
                This will send emails to both <strong>${studentName}</strong> and the landlord.
            </div>
        `;

        // Create and show modal
        const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
        document.getElementById('bookingDetails').innerHTML = `
            <div class="modal-header">
                <h5 class="modal-title">Send Reminder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                ${reminderModalContent}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSendReminder">
                    <i class="bi bi-send me-1"></i>Send Reminder
                </button>
            </div>
        `;

        modal.show();

        // Show/hide custom message based on selection
        document.getElementById('reminderType').addEventListener('change', function() {
            const customContainer = document.getElementById('customMessageContainer');
            customContainer.style.display = this.value === 'custom' ? 'block' : 'none';
        });

        // Handle send reminder confirmation
        document.getElementById('confirmSendReminder').addEventListener('click', async function() {
            const reminderType = document.getElementById('reminderType').value;
            const customMessage = document.getElementById('customMessage').value;
            
            const sendBtn = this;
            const originalText = sendBtn.innerHTML;
            sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
            sendBtn.disabled = true;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/admin/bookings/${bookingId}/send-reminder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        reminderType: reminderType,
                        customMessage: customMessage
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    modal.hide();
                    
                    const successMessage = `Reminder sent successfully! Emails delivered to ${data.data.sentTo.join(' and ')}.`;
                    showNotification(successMessage, 'success');
                    
                    // Log for debugging
                    console.log('Reminder sent:', {
                        bookingId: bookingId,
                        reminderType: reminderType,
                        results: data.data
                    });
                } else {
                    throw new Error(data.error || 'Failed to send reminder');
                }
            } catch (error) {
                console.error('Error sending reminder:', error);
                showNotification('Failed to send reminder: ' + error.message, 'danger');
                
                // Reset button
                sendBtn.innerHTML = originalText;
                sendBtn.disabled = false;
            }
        });

    } catch (error) {
        console.error('Error preparing reminder:', error);
        showNotification('Failed to prepare reminder: ' + error.message, 'danger');
    }
}

    async function exportBookings() {
    try {
        // Show loading state
        const originalText = event.target.innerHTML;
        event.target.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Exporting...';
        event.target.disabled = true;

        console.log('Exporting bookings data...');
        
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/admin/bookings/export`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            
            // Create filename with timestamp
            const timestamp = new Date().toISOString().split('T')[0];
            a.download = `bookings-export-${timestamp}.csv`;
            
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showNotification('Bookings exported successfully!', 'success');
        } else {
            // Fallback: Generate export from current data
            await exportBookingsFallback();
        }
        
        // Reset button
        event.target.innerHTML = originalText;
        event.target.disabled = false;
    } catch (error) {
        console.error('Export error:', error);
        // Fallback to local generation
        await exportBookingsFallback();
        
        // Reset button
        event.target.innerHTML = originalText;
        event.target.disabled = false;
    }
}

// Fallback export generation
async function exportBookingsFallback() {
    try {
        // Get all bookings for export
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/admin/bookings?page=1&limit=1000`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            const bookings = data.data?.bookings || data.bookings || [];
            
            // Convert to CSV format
            const csvData = convertBookingsToCSV(bookings);
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            
            const timestamp = new Date().toISOString().split('T')[0];
            a.download = `bookings-export-${timestamp}.csv`;
            
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showNotification('Bookings exported successfully!', 'success');
        } else {
            throw new Error('Failed to fetch data for export');
        }
    } catch (error) {
        console.error('Export generation error:', error);
        showNotification('Failed to export bookings: ' + error.message, 'danger');
    }
}

// Convert bookings data to CSV
function convertBookingsToCSV(bookings) {
    const headers = [
        'Booking ID',
        'Property Name',
        'Property Type',
        'Location',
        'Student Name',
        'Student Email',
        'Student Phone',
        'Landlord Name',
        'Landlord Email',
        'Booking Date',
        'Booking Time',
        'Booking Type',
        'Status',
        'Duration',
        'Special Requests',
        'Total Price',
        'Created Date',
        'Last Updated',
        'Cancellation Reason',
        'Admin Notes'
    ];

    const rows = bookings.map(booking => {
        const property = booking.property || {};
        const student = booking.student || {};
        const landlord = booking.landlord || {};
        
        const studentName = student.username || student.firstName 
            ? `${student.firstName || ''} ${student.surname || ''}`.trim() 
            : 'Unknown Student';
        
        const landlordName = landlord.username || landlord.firstName
            ? `${landlord.firstName || ''} ${landlord.surname || ''}`.trim()
            : 'Unknown Landlord';
        
        const bookingType = extractBookingType(booking.specialRequests);
        const dateTime = formatBookingDateTime(booking.checkIn);
        const bookingDate = dateTime.date;
        const bookingTime = dateTime.time;

        return [
            `"${booking._id || ''}"`,
            `"${property.title || ''}"`,
            `"${property.propertyType || ''}"`,
            `"${property.location?.address || ''}"`,
            `"${studentName}"`,
            `"${student.email || ''}"`,
            `"${student.phone || ''}"`,
            `"${landlordName}"`,
            `"${landlord.email || ''}"`,
            `"${bookingDate}"`,
            `"${bookingTime}"`,
            `"${bookingType}"`,
            `"${booking.status || ''}"`,
            `"${booking.duration || ''}"`,
            `"${(booking.specialRequests || '').replace(/"/g, '""')}"`,
            `"${booking.totalPrice || ''}"`,
            `"${booking.createdAt ? new Date(booking.createdAt).toLocaleDateString() : ''}"`,
            `"${booking.updatedAt ? new Date(booking.updatedAt).toLocaleDateString() : ''}"`,
            `"${(booking.cancellationReason || '').replace(/"/g, '""')}"`,
            `"${(booking.adminNotes || '').replace(/"/g, '""')}"`
        ];
    });

    return [headers, ...rows].map(row => row.join(',')).join('\n');
}

// Notification function
function showNotification(message, type) {
    // Create toast notification
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.id = toastId;
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
    toastContainer.style.zIndex = '9999';
    document.body.appendChild(toastContainer);
    return toastContainer;
}

    // Event listeners for filters
    document.getElementById('searchInput').addEventListener('input', filterBookings);
    document.getElementById('statusFilter').addEventListener('change', filterBookings);
    document.getElementById('dateFilter').addEventListener('change', filterBookings);

    // Update your existing DOMContentLoaded event
    document.addEventListener('DOMContentLoaded', function() {
      loadBookings();
      generateCalendar();
      loadPendingReschedules(); // NEW: Load pending reschedules on page load
    });
  </script>
</body>
</html>