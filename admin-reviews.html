<!DOCTYPE html>
<html lang="en-ZA">
<head>
    <!-- Essential Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResLinQ | Student Accommodation Platform - Find Your Perfect Student Home in South Africa</title>
    <meta name="description" content="ResLinQ helps students find verified accommodations near campuses in South Africa. Browse listings, book viewings, and join our student community. Safe, affordable student housing.">
    <meta name="keywords" content="student accommodation, South Africa student housing, university residences, student rentals, campus accommodation, student living, ResLinQ">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://www.reslinq.co.za/">

    <!-- Favicon & App Icons -->
    <link rel="icon" href="/images/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="manifest" href="/images/site.webmanifest">

    <!-- Enhanced Open Graph / Social Media -->
    <meta property="og:title" content="ResLinQ - Student Living, Simplified | Find Student Accommodation in South Africa">
    <meta property="og:description" content="Find verified student accommodations near South African campuses. Safe, affordable housing with easy booking and community support. Browse 500+ listings.">
    <meta property="og:image" content="/images/og-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://www.reslinq.co.za/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="ResLinQ">
    <meta property="og:locale" content="en_ZA">
    
    <!-- Enhanced Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ResLinQ - Student Accommodation Made Simple">
    <meta name="twitter:description" content="Find your perfect student home near campus with verified listings and easy booking. 500+ accommodations across South Africa.">
    <meta name="twitter:image" content="/images/og-image.jpg">
    <meta name="twitter:site" content="@ResLinQ">

    <!-- Additional SEO Meta Tags -->
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta name="author" content="ResLinQ">
    <meta name="geo.region" content="ZA">
    <meta name="geo.placename" content="South Africa">
    

    <!-- Preload critical resources -->
    <link rel="preload" href="style.css" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" as="style">

    <!-- Then the actual stylesheet links (keep your existing ones) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
    <style>
    :root {
      --primary: #1e3a8a;
      --primary-light: #3b82f6;
      --primary-dark: #1e40af;
      --success: #059669;
      --warning: #f59e0b;
      --danger: #dc2626;
      --info: #60a5fa;
      --light-bg: #f8fafc;
      --navy: #0b2447;
      --admin-sidebar: #0f172a;
    }

    body {
      background: #f8fafc;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      overflow-x: hidden;
    }

    .admin-sidebar {
      background: var(--admin-sidebar);
      color: white;
      min-height: 100vh;
      position: fixed;
      width: 280px;
      transition: all 0.3s ease;
      z-index: 1000;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }

    .admin-sidebar.collapsed {
      width: 80px;
    }

    .admin-sidebar.collapsed .sidebar-text {
      display: none;
    }

    .sidebar-brand {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }

    .sidebar-nav {
      padding: 1rem 0;
    }

    .nav-item {
      margin: 0.25rem 1rem;
    }

    .nav-link {
      color: rgba(255,255,255,0.8);
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .nav-link:hover, .nav-link.active {
      background: rgba(59, 130, 246, 0.1);
      color: white;
      border-left: 3px solid var(--primary-light);
    }

    .admin-main {
      margin-left: 280px;
      transition: all 0.3s ease;
      min-height: 100vh;
    }

    .admin-main.expanded {
      margin-left: 80px;
    }

    .admin-header {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 1rem 2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .admin-content {
      padding: 2rem;
    }

    /* Reviews-specific styles */
    .review-card {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      border-left: 4px solid var(--primary);
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }

    .review-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }

    .review-card.positive { border-left-color: var(--success); }
    .review-card.negative { border-left-color: var(--danger); }
    .review-card.neutral { border-left-color: var(--warning); }

    .rating-stars {
      color: var(--warning);
    }

    .rating-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .rating-excellent { background: #d1fae5; color: #059669; }
    .rating-good { background: #dbeafe; color: #1d4ed8; }
    .rating-average { background: #fef3c7; color: #d97706; }
    .rating-poor { background: #fef3c7; color: #b45309; }
    .rating-bad { background: #fee2e2; color: #dc2626; }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-responded { background: #d1fae5; color: #059669; }
    .status-pending { background: #fef3c7; color: #d97706; }
    .status-hidden { background: #f1f5f9; color: #64748b; }

    .review-type-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.7rem;
      background: #f8fafc;
      color: #64748b;
      border: 1px solid #e2e8f0;
    }

    .data-table {
      background: white;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .table th {
      background: #f8fafc;
      border-bottom: 2px solid #e2e8f0;
      font-weight: 600;
      color: #64748b;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Tabs */
    .review-tabs {
      background: white;
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .nav-tabs .nav-link {
      border: none;
      color: #64748b;
      font-weight: 500;
      padding: 0.75rem 1.5rem;
    }

    .nav-tabs .nav-link.active {
      background: var(--primary);
      color: white;
      border-radius: 0.75rem;
    }

    /* Analytics Cards */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .analytics-card {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      transition: transform 0.3s ease;
    }

    .analytics-card:hover {
      transform: translateY(-2px);
    }

    .analytics-card.rating { border-top: 4px solid var(--warning); }
    .analytics-card.reviews { border-top: 4px solid var(--primary); }
    .analytics-card.responded { border-top: 4px solid var(--success); }
    .analytics-card.pending { border-top: 4px solid var(--info); }

    /* Rating Distribution */
    .distribution-bar {
      height: 8px;
      border-radius: 4px;
      background: #e2e8f0;
      margin: 0.5rem 0;
      overflow: hidden;
    }

    .distribution-fill {
      height: 100%;
      border-radius: 4px;
    }

    .distribution-5 { background: var(--success); }
    .distribution-4 { background: var(--info); }
    .distribution-3 { background: var(--warning); }
    .distribution-2 { background: #f59e0b; }
    .distribution-1 { background: var(--danger); }

    /* Review Insights */
    .insight-card {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .property-image {
      width: 60px;
      height: 60px;
      border-radius: 0.5rem;
      object-fit: cover;
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 0.5rem 1rem;
      border-radius: 0.75rem;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    /* Charts */
    .chart-container {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }

    .chart-placeholder {
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8fafc;
      border-radius: 0.5rem;
      color: #64748b;
    }
  </style>
</head>
<body>

  <!-- Admin Redirect Check -->
  <script>
    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    
    if (!token) {
      alert("Please log in to access admin panel.");
      window.location.href = "authorization.html";
    } else if (user.role !== 'admin') {
      alert("Access denied. Admin privileges required.");
      window.location.href = "index.html";
    }
  </script>

  <!-- Admin Sidebar -->
  <div class="admin-sidebar" id="adminSidebar">
    <div class="sidebar-brand">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="bi bi-shield-check text-primary fs-4 me-2"></i>
          <span class="sidebar-text fs-5 ">ResLinQ Admin</span>
        </div>
        <button class="btn btn-sm btn-outline-light" id="sidebarToggle">
          <i class="bi bi-list"></i>
        </button>
      </div>
    </div>

    <div class="sidebar-nav">
      <div class="nav-item">
        <a class="nav-link" href="admin-dashboard.html">
          <i class="bi bi-speedometer2"></i>
          <span class="sidebar-text">Dashboard</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="admin-users.html">
          <i class="bi bi-people"></i>
          <span class="sidebar-text">Users</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="admin-properties.html">
          <i class="bi bi-houses"></i>
          <span class="sidebar-text">Properties</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="admin-bookings.html">
          <i class="bi bi-calendar-check"></i>
          <span class="sidebar-text">Bookings</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="admin-reports.html">
          <i class="bi bi-flag"></i>
          <span class="sidebar-text">Reports</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link active" href="admin-reviews.html">
          <i class="bi bi-star"></i>
          <span class="sidebar-text">Reviews</span>
          <span class="notification-badge" id="reviewsNotification">0</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="admin-verification.html">
          <i class="bi bi-patch-check"></i>
          <span class="sidebar-text">Verification</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="admin-messages.html">
          <i class="bi bi-chat-dots"></i>
          <span class="sidebar-text">Messages</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="admin-payments.html">
          <i class="bi bi-credit-card"></i>
          <span class="sidebar-text">Payments</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="admin-settings.html">
          <i class="bi bi-gear"></i>
          <span class="sidebar-text">Settings</span>
        </a>
      </div>
      
      <div class="nav-item mt-4">
        <a class="nav-link text-warning" href="admin-login.html">
          <i class="bi bi-box-arrow-right"></i>
          <span class="sidebar-text">Logout</span>
        </a>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="admin-main" id="adminMain">
    <!-- Header -->
    <header class="admin-header">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4 class="fw-bold mb-0">Reviews Management</h4>
          <small class="text-muted">Monitor and moderate user reviews</small>
        </div>
        <div class="d-flex align-items-center gap-3">
          <button class="btn btn-primary" onclick="generateReviewsReport()">
            <i class="bi bi-graph-up me-2"></i>Analytics Report
          </button>
          <div class="dropdown">
            <button class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
              <i class="bi bi-bell"></i>
              <span class="notification-badge" id="headerNotification">0</span>
            </button>
            <div class="dropdown-menu dropdown-menu-end">
              <h6 class="dropdown-header">Review Alerts</h6>
              <div id="reviewAlerts">
                <!-- Alerts will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="admin-content">
      <!-- Analytics Overview -->
      <div class="analytics-grid">
        <div class="analytics-card rating">
          <div class="text-warning mb-2">
            <i class="bi bi-star-fill fs-1"></i>
          </div>
          <h3 class="fw-bold" id="averageRating">0.0</h3>
          <p class="text-muted mb-0">Average Rating</p>
        </div>
        <div class="analytics-card reviews">
          <div class="text-primary mb-2">
            <i class="bi bi-chat-square-text fs-1"></i>
          </div>
          <h3 class="fw-bold" id="totalReviews">0</h3>
          <p class="text-muted mb-0">Total Reviews</p>
        </div>
        <div class="analytics-card responded">
          <div class="text-success mb-2">
            <i class="bi bi-check-circle fs-1"></i>
          </div>
          <h3 class="fw-bold" id="respondedReviews">0</h3>
          <p class="text-muted mb-0">Responded</p>
        </div>
        <div class="analytics-card pending">
          <div class="text-info mb-2">
            <i class="bi bi-clock fs-1"></i>
          </div>
          <h3 class="fw-bold" id="pendingReviews">0</h3>
          <p class="text-muted mb-0">Pending Response</p>
        </div>
      </div>

      <div class="row">
        <!-- Left Column: Statistics and Filters -->
        <div class="col-md-4">
          <!-- Rating Distribution -->
          <div class="chart-container">
            <h5 class="text-navy mb-4">Rating Distribution</h5>
            <div id="ratingDistribution">
              <!-- Distribution will be populated here -->
            </div>
          </div>

          <!-- Quick Filters -->
          <div class="chart-container">
            <h5 class="text-navy mb-4">Quick Filters</h5>
            <div class="quick-actions">
              <button class="btn btn-outline-primary action-btn" onclick="filterByRating(5)">
                <i class="bi bi-star-fill text-warning me-1"></i>5 Stars
              </button>
              <button class="btn btn-outline-primary action-btn" onclick="filterByRating(1)">
                <i class="bi bi-star-fill text-danger me-1"></i>1 Star
              </button>
              <button class="btn btn-outline-success action-btn" onclick="filterByStatus('responded')">
                <i class="bi bi-check-circle me-1"></i>Responded
              </button>
              <button class="btn btn-outline-warning action-btn" onclick="filterByStatus('pending_response')">
                <i class="bi bi-clock me-1"></i>Pending
              </button>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="chart-container">
            <h5 class="text-navy mb-4">Recent Activity</h5>
            <div id="recentActivity">
              <!-- Recent activity will be populated here -->
            </div>
          </div>
        </div>

        <!-- Right Column: Reviews List -->
        <div class="col-md-8">
          <!-- Review Tabs -->
          <div class="review-tabs">
            <ul class="nav nav-tabs" id="reviewTabs">
              <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#all-tab">
                  <i class="bi bi-list-ul me-2"></i>All Reviews
                  <span class="badge bg-secondary ms-2" id="allCount">0</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#pending-tab">
                  <i class="bi bi-clock me-2"></i>Pending Response
                  <span class="badge bg-warning ms-2" id="pendingCount">0</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#responded-tab">
                  <i class="bi bi-check-circle me-2"></i>Responded
                  <span class="badge bg-success ms-2" id="respondedCount">0</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#reported-tab">
                  <i class="bi bi-flag me-2"></i>Reported
                  <span class="badge bg-danger ms-2" id="reportedCount">0</span>
                </a>
              </li>
            </ul>
          </div>

          <!-- Search and Filters -->
          <div class="data-table mb-4">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
              <h5 class="fw-bold mb-0" id="tabTitle">All Reviews</h5>
              <div class="d-flex gap-2">
                <input type="text" class="form-control form-control-sm" placeholder="Search reviews..." 
                       id="searchInput" style="width: 200px;">
                <select class="form-select form-select-sm" id="ratingFilter" style="width: auto;">
                  <option value="">All Ratings</option>
                  <option value="5">5 Stars</option>
                  <option value="4">4 Stars</option>
                  <option value="3">3 Stars</option>
                  <option value="2">2 Stars</option>
                  <option value="1">1 Star</option>
                </select>
                <select class="form-select form-select-sm" id="sortFilter" style="width: auto;">
                  <option value="createdAt_desc">Newest First</option>
                  <option value="createdAt_asc">Oldest First</option>
                  <option value="rating_desc">Highest Rating</option>
                  <option value="rating_asc">Lowest Rating</option>
                </select>
                <button class="btn btn-sm btn-primary" onclick="adminReviewsManager.loadReviews()">
                  <i class="bi bi-filter"></i> Apply
                </button>
              </div>
            </div>
          </div>

          <!-- Tab Content -->
          <div class="tab-content">
            <!-- All Reviews Tab -->
            <div class="tab-pane fade show active" id="all-tab">
              <div id="allReviewsList">
                <!-- All reviews will be loaded here -->
              </div>
            </div>

            <!-- Pending Response Tab -->
            <div class="tab-pane fade" id="pending-tab">
              <div id="pendingReviewsList">
                <!-- Pending reviews will be loaded here -->
              </div>
            </div>

            <!-- Responded Tab -->
            <div class="tab-pane fade" id="responded-tab">
              <div id="respondedReviewsList">
                <!-- Responded reviews will be loaded here -->
              </div>
            </div>

            <!-- Reported Tab -->
            <div class="tab-pane fade" id="reported-tab">
              <div id="reportedReviewsList">
                <!-- Reported reviews will be loaded here -->
              </div>
            </div>
          </div>

          <!-- Pagination -->
          <nav aria-label="Reviews pagination" class="mt-4">
            <ul class="pagination justify-content-center" id="reviewsPagination">
              <!-- Pagination will be populated here -->
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <!-- Review Details Modal -->
  <div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Review Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="reviewDetails">
          <!-- Review details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-warning" onclick="moderateReview('edit')">
            <i class="bi bi-pencil me-2"></i>Edit Content
          </button>
          <button type="button" class="btn btn-danger" onclick="moderateReview('hide')">
            <i class="bi bi-eye-slash me-2"></i>Hide Review
          </button>
          <button type="button" class="btn btn-success" onclick="moderateReview('unhide')">
            <i class="bi bi-eye me-2"></i>Unhide Review
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Moderate Review Modal -->
  <div class="modal fade" id="moderateModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="moderateModalTitle">Moderate Review</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="moderateForm">
            <input type="hidden" id="moderateReviewId">
            <input type="hidden" id="moderateAction">
            <div class="mb-3">
              <label class="form-label">Reason for Action</label>
              <textarea class="form-control" id="moderateReason" rows="3" 
                        placeholder="Explain why you are taking this action..."></textarea>
            </div>
            <div class="mb-3" id="editCommentSection" style="display: none;">
              <label class="form-label">Modified Comment</label>
              <textarea class="form-control" id="modifiedComment" rows="4" 
                        placeholder="Enter the modified review content..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="submitModeration()">Confirm Action</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE_URL = 'https://linqs-backend.onrender.com/api';

    // Sidebar Toggle
    document.getElementById('sidebarToggle').addEventListener('click', function() {
      document.getElementById('adminSidebar').classList.toggle('collapsed');
      document.getElementById('adminMain').classList.toggle('expanded');
    });

    // Reviews Management
    class AdminReviewsManager {
      constructor() {
        this.token = localStorage.getItem("token");
        this.currentFilter = {
          status: 'all',
          rating: '',
          search: '',
          sortBy: 'createdAt',
          sortOrder: 'desc',
          page: 1,
          limit: 10
        };
        this.init();
      }

      async init() {
        await this.loadReviewStats();
        await this.loadReviews();
        this.setupEventListeners();
        this.setupRealTimeUpdates();
      }

      async loadReviewStats() {
        try {
          console.log('Loading review stats...');
          const response = await fetch(`${API_BASE_URL}/admin/reviews/stats/overview`, {
            headers: {
              'Authorization': `Bearer ${this.token}`
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          
          if (data.success) {
            console.log('Review stats loaded:', data.data.statistics);
            this.updateDashboardStats(data.data.statistics);
            this.updateRatingDistribution(data.data.ratingDistribution);
            this.updateRecentActivity(data.data.recentActivity);
            this.updateNotificationBadges(data.data.statistics);
          } else {
            console.error('API returned error:', data.error);
            this.showError('Failed to load review statistics: ' + data.error);
          }
        } catch (error) {
          console.error('Error loading review stats:', error);
          this.showError('Failed to load review statistics. Please check console for details.');
        }
      }

      async loadReviews() {
        try {
          console.log('Loading reviews for admin...');
          
          // Build query parameters
          const queryParams = new URLSearchParams({
            page: this.currentFilter.page,
            limit: this.currentFilter.limit,
            status: this.currentFilter.status,
            sortBy: this.currentFilter.sortBy,
            sortOrder: this.currentFilter.sortOrder
          });

          // Add optional filters
          if (this.currentFilter.rating) {
            queryParams.append('rating', this.currentFilter.rating);
          }
          if (this.currentFilter.search) {
            queryParams.append('search', this.currentFilter.search);
          }

          console.log('Fetching reviews with params:', queryParams.toString());
          
          const response = await fetch(`${API_BASE_URL}/admin/reviews?${queryParams}`, {
            headers: {
              'Authorization': `Bearer ${this.token}`
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          
          if (data.success) {
            console.log('Reviews loaded:', data.data.reviews.length);
            console.log('Pagination:', data.data.pagination);
            
            // Display reviews based on current tab
            this.displayReviews(data.data.reviews);
            
            // Update pagination
            this.updatePagination(data.data.pagination);
            
            // Update counts
            if (data.data.statistics) {
              this.updateReviewCounts(data.data.statistics);
            }
          } else {
            console.error('API returned error:', data.error);
            this.showError('Failed to load reviews: ' + data.error);
          }
        } catch (error) {
          console.error('Error loading reviews:', error);
          this.showError('Failed to load reviews. Please check console for details.');
        }
      }

      displayReviews(reviews) {
        const currentTab = this.getCurrentTab();
        const containerId = `${currentTab}ReviewsList`;
        const container = document.getElementById(containerId);
        
        if (!container) return;

        if (!reviews || reviews.length === 0) {
          container.innerHTML = this.getEmptyState(currentTab);
          return;
        }

        container.innerHTML = reviews.map(review => this.generateReviewCard(review)).join('');
      }

      generateReviewCard(review) {
    const sentiment = this.getReviewSentiment(review.rating);
    const hasResponse = review.landlordResponse && review.landlordResponse.comment;
    const isHidden = review.isHidden || false;
    const studentName = review.student?.firstName 
        ? `${review.student.firstName} ${review.student.lastName}`
        : review.student?.username || 'Anonymous Student';
    
    const landlordName = review.landlord?.firstName
        ? `${review.landlord.firstName} ${review.landlord.lastName}`
        : review.landlord?.username || 'Landlord';
    
    const propertyName = review.property?.title || 'Property';
    const reviewDate = new Date(review.createdAt).toLocaleDateString();
    const responseDate = hasResponse ? new Date(review.landlordResponse.respondedAt).toLocaleDateString() : '';

    return `
        <div class="review-card ${sentiment}">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="d-flex align-items-center">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" 
                         style="width: 50px; height: 50px;">
                        <i class="bi bi-person-fill text-white"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">${studentName}</h6>
                        <small class="text-muted">Reviewed ${propertyName}</small>
                        <br>
                        <small class="text-info">${review.reviewType === 'booking' ? 'Booking Review' : 'General Review'}</small>
                    </div>
                </div>
                <div class="text-end">
                    <div class="rating-stars mb-1">
                        ${this.generateStars(review.rating)}
                    </div>
                    <small class="text-muted">${reviewDate}</small>
                    <div class="mt-1">
                        ${isHidden ? 
                            '<span class="badge bg-danger">Hidden</span>' : 
                            `<span class="status-badge status-${hasResponse ? 'responded' : 'pending'}">
                                ${hasResponse ? 'Responded' : 'Pending Response'}
                            </span>`
                        }
                    </div>
                </div>
            </div>
            
            ${isHidden ? `
                <div class="alert alert-warning py-2 mb-3">
                    <small><i class="bi bi-eye-slash me-1"></i>This review is currently hidden from public view</small>
                </div>
            ` : ''}
            
            <h6 class="fw-bold">${review.title}</h6>
            <p class="mb-3">${review.comment}</p>
            
            ${review.cleanliness || review.location || review.value ? `
                <div class="d-flex flex-wrap gap-3 mb-3 small">
                    ${review.cleanliness ? `<span><i class="bi bi-bucket me-1"></i>Cleanliness: ${review.cleanliness}/5</span>` : ''}
                    ${review.location ? `<span><i class="bi bi-geo-alt me-1"></i>Location: ${review.location}/5</span>` : ''}
                    ${review.value ? `<span><i class="bi bi-currency-dollar me-1"></i>Value: ${review.value}/5</span>` : ''}
                </div>
            ` : ''}
            
            ${review.isRecommended ? `
                <div class="alert alert-success py-1 px-2 d-inline-block mb-3">
                    <i class="bi bi-check-circle me-1"></i>Recommended
                </div>
            ` : ''}
            
            ${hasResponse ? `
                <div class="alert alert-light border">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <strong class="text-primary">
                            <i class="bi bi-patch-check-fill me-1"></i>Landlord's Response
                        </strong>
                        <small class="text-muted">${responseDate}</small>
                    </div>
                    <p class="mb-0">${review.landlordResponse.comment}</p>
                </div>
            ` : `
                <div class="alert alert-warning py-2">
                    <small><i class="bi bi-clock me-1"></i>No response from landlord yet</small>
                </div>
            `}
            
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="adminReviewsManager.viewReview('${review._id}')">
                        <i class="bi bi-eye me-1"></i>View Details
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="adminReviewsManager.viewProperty('${review.property?._id}')">
                        <i class="bi bi-house me-1"></i>View Property
                    </button>
                </div>
                <div class="d-flex gap-1">
                    ${!hasResponse ? `
                        <button class="btn btn-sm btn-outline-warning" onclick="adminReviewsManager.remindLandlord('${review._id}')">
                            <i class="bi bi-bell me-1"></i>Remind
                        </button>
                    ` : ''}
                    <button class="btn btn-sm btn-outline-danger" onclick="adminReviewsManager.deleteReview('${review._id}')">
                        <i class="bi bi-trash me-1"></i>Delete
                    </button>
                </div>
            </div>
        </div>
    `;
}

      generateStars(rating) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
          if (i <= rating) {
            stars += '<i class="bi bi-star-fill"></i>';
          } else {
            stars += '<i class="bi bi-star"></i>';
          }
        }
        return stars;
      }

      getReviewSentiment(rating) {
        if (rating >= 4) return 'positive';
        if (rating <= 2) return 'negative';
        return 'neutral';
      }

      getEmptyState(tab) {
        const messages = {
          'all': 'No reviews found',
          'pending': 'No reviews pending response',
          'responded': 'No responded reviews',
          'reported': 'No reported reviews'
        };
        
        return `
          <div class="text-center py-5">
            <i class="bi bi-chat-square-text display-4 text-muted mb-3"></i>
            <p class="text-muted">${messages[tab] || 'No reviews found'}</p>
            <small class="text-muted">Reviews will appear here as users submit them</small>
          </div>
        `;
      }

      updateDashboardStats(stats) {
        document.getElementById('averageRating').textContent = stats.averageRating || '0.0';
        document.getElementById('totalReviews').textContent = stats.total || 0;
        document.getElementById('respondedReviews').textContent = stats.responded || 0;
        document.getElementById('pendingReviews').textContent = stats.pendingResponse || 0;
      }

      updateRatingDistribution(distribution) {
        const container = document.getElementById('ratingDistribution');
        if (!container) return;

        const totalReviews = Object.values(distribution).reduce((sum, count) => sum + count, 0);
        
        container.innerHTML = [5, 4, 3, 2, 1].map(rating => {
          const count = distribution[rating] || 0;
          const percentage = totalReviews > 0 ? (count / totalReviews) * 100 : 0;
          
          return `
            <div class="d-flex align-items-center mb-2">
              <div class="me-3" style="width: 60px;">
                <span class="rating-stars small">
                  ${this.generateStars(rating)}
                </span>
              </div>
              <div class="flex-grow-1">
                <div class="distribution-bar">
                  <div class="distribution-fill distribution-${rating}" style="width: ${percentage}%"></div>
                </div>
              </div>
              <div class="ms-3 text-end" style="width: 40px;">
                <small class="text-muted">${count}</small>
              </div>
            </div>
          `;
        }).join('');
      }

      updateRecentActivity(activities) {
        const container = document.getElementById('recentActivity');
        if (!container) return;

        if (!activities || activities.length === 0) {
          container.innerHTML = '<p class="text-muted text-center">No recent activity</p>';
          return;
        }

        container.innerHTML = activities.map(activity => {
          const studentName = activity.student?.[0]?.firstName 
            ? `${activity.student[0].firstName} ${activity.student[0].lastName}`
            : activity.student?.[0]?.username || 'Student';
          
          const propertyName = activity.property?.[0]?.title || 'Property';
          const timeAgo = this.getTimeAgo(new Date(activity.createdAt));
          
          return `
            <div class="d-flex align-items-start mb-3">
              <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" 
                   style="width: 35px; height: 35px;">
                <i class="bi bi-star-fill text-white" style="font-size: 0.8rem;"></i>
              </div>
              <div class="flex-grow-1">
                <p class="mb-0 small">
                  <strong>${studentName}</strong> reviewed 
                  <strong>${propertyName}</strong>
                </p>
                <small class="text-muted">${timeAgo}</small>
                <div class="rating-stars small mt-1">
                  ${this.generateStars(activity.rating)}
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      getTimeAgo(date) {
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);
        
        if (diffInSeconds < 60) return 'Just now';
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
        return `${Math.floor(diffInSeconds / 86400)}d ago`;
      }

      updateReviewCounts(statistics) {
        document.getElementById('allCount').textContent = statistics.total || 0;
        document.getElementById('pendingCount').textContent = statistics.pendingResponse || 0;
        document.getElementById('respondedCount').textContent = statistics.responded || 0;
        // Reported count would come from a separate endpoint
        document.getElementById('reportedCount').textContent = '0';
      }

      updatePagination(pagination) {
        const container = document.getElementById('reviewsPagination');
        if (!container) return;

        const { currentPage, totalPages, hasNextPage, hasPrevPage } = pagination;
        
        let paginationHTML = '';

        // Previous button
        paginationHTML += `
          <li class="page-item ${!hasPrevPage ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="adminReviewsManager.changePage(${currentPage - 1})" ${!hasPrevPage ? 'tabindex="-1" aria-disabled="true"' : ''}>
              <i class="bi bi-chevron-left"></i>
            </a>
          </li>
        `;

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
          if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
            paginationHTML += `
              <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="adminReviewsManager.changePage(${i})">${i}</a>
              </li>
            `;
          } else if (i === currentPage - 2 || i === currentPage + 2) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          }
        }

        // Next button
        paginationHTML += `
          <li class="page-item ${!hasNextPage ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="adminReviewsManager.changePage(${currentPage + 1})" ${!hasNextPage ? 'tabindex="-1" aria-disabled="true"' : ''}>
              <i class="bi bi-chevron-right"></i>
            </a>
          </li>
        `;

        container.innerHTML = paginationHTML;
      }

      changePage(page) {
        this.currentFilter.page = page;
        this.loadReviews();
      }

      getCurrentTab() {
        const activeTab = document.querySelector('#reviewTabs .nav-link.active');
        if (activeTab) {
          const target = activeTab.getAttribute('href');
          if (target === '#all-tab') return 'all';
          if (target === '#pending-tab') return 'pending';
          if (target === '#responded-tab') return 'responded';
          if (target === '#reported-tab') return 'reported';
        }
        return 'all';
      }

      updateNotificationBadges(stats) {
        const totalPending = stats.pendingResponse || 0;
        
        // Update sidebar notification
        const sidebarBadge = document.getElementById('reviewsNotification');
        if (sidebarBadge) {
          sidebarBadge.textContent = totalPending > 99 ? '99+' : totalPending;
          sidebarBadge.style.display = totalPending > 0 ? 'flex' : 'none';
        }
        
        // Update header notification
        const headerBadge = document.getElementById('headerNotification');
        if (headerBadge) {
          headerBadge.textContent = totalPending > 99 ? '99+' : totalPending;
          headerBadge.style.display = totalPending > 0 ? 'flex' : 'none';
        }
        
        // Update dropdown alerts
        this.updateAlertDropdown(stats);
      }

      updateAlertDropdown(stats) {
        const dropdownMenu = document.querySelector('.dropdown-menu');
        if (!dropdownMenu) return;

        let alertsHTML = '<h6 class="dropdown-header">Review Alerts</h6>';
        
        const pendingCount = stats.pendingResponse || 0;
        const todayCount = stats.today || 0;
        
        if (pendingCount > 0) {
          alertsHTML += `<a class="dropdown-item text-warning" href="#">
            <i class="bi bi-clock me-2"></i>${pendingCount} reviews pending response
          </a>`;
        }
        
        if (todayCount > 0) {
          alertsHTML += `<a class="dropdown-item text-info" href="#">
            <i class="bi bi-star me-2"></i>${todayCount} new reviews today
          </a>`;
        }
        
        if (pendingCount === 0 && todayCount === 0) {
          alertsHTML += '<a class="dropdown-item text-muted" href="#">No new alerts</a>';
        }

        alertsHTML += '<div class="dropdown-divider"></div>';
        alertsHTML += '<a class="dropdown-item text-primary" href="#" onclick="adminReviewsManager.loadReviews()">';
        alertsHTML += '<i class="bi bi-arrow-clockwise me-2"></i>Refresh';
        alertsHTML += '</a>';

        document.getElementById('reviewAlerts').innerHTML = alertsHTML;
      }

      setupEventListeners() {
        // Search input
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            this.currentFilter.search = e.target.value;
            this.currentFilter.page = 1;
            setTimeout(() => this.loadReviews(), 500);
          });
        }

        // Rating filter
        const ratingFilter = document.getElementById('ratingFilter');
        if (ratingFilter) {
          ratingFilter.addEventListener('change', (e) => {
            this.currentFilter.rating = e.target.value;
            this.currentFilter.page = 1;
            this.loadReviews();
          });
        }

        // Sort filter
        const sortFilter = document.getElementById('sortFilter');
        if (sortFilter) {
          sortFilter.addEventListener('change', (e) => {
            const [sortBy, sortOrder] = e.target.value.split('_');
            this.currentFilter.sortBy = sortBy;
            this.currentFilter.sortOrder = sortOrder;
            this.currentFilter.page = 1;
            this.loadReviews();
          });
        }

        // Tab changes
        const reviewTabs = document.getElementById('reviewTabs');
        if (reviewTabs) {
          reviewTabs.addEventListener('shown.bs.tab', (e) => {
            const target = e.target.getAttribute('href');
            
            // Update filter based on tab
            if (target === '#all-tab') this.currentFilter.status = 'all';
            else if (target === '#pending-tab') this.currentFilter.status = 'pending_response';
            else if (target === '#responded-tab') this.currentFilter.status = 'responded';
            else if (target === '#reported-tab') this.currentFilter.status = 'reported';
            
            this.currentFilter.page = 1;
            
            // Update tab title
            const tabTitle = document.getElementById('tabTitle');
            if (tabTitle) {
              tabTitle.textContent = e.target.textContent.trim().split('\n')[0];
            }
            
            setTimeout(() => {
              this.loadReviews();
            }, 100);
          });
        }
      }

      setupRealTimeUpdates() {
        // Refresh data every 2 minutes
        setInterval(() => {
          this.loadReviewStats();
          this.loadReviews();
        }, 120000);

        // Refresh when page becomes visible
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            this.loadReviewStats();
            this.loadReviews();
          }
        });
      }

      async viewReview(reviewId) {
        try {
          const response = await fetch(`${API_BASE_URL}/admin/reviews/${reviewId}`, {
            headers: {
              'Authorization': `Bearer ${this.token}`
            }
          });
          
          const data = await response.json();
          
          if (data.success) {
            this.displayReviewModal(data.data.review);
          } else {
            this.showError('Failed to load review details');
          }
        } catch (error) {
          console.error('Error viewing review:', error);
          this.showError('Failed to load review details');
        }
      }

      displayReviewModal(review) {
    const modalContent = document.getElementById('reviewDetails');
    
    // Store review ID for moderation actions
    modalContent.setAttribute('data-review-id', review._id);
    
    const studentName = review.student?.firstName 
        ? `${review.student.firstName} ${review.student.lastName}`
        : review.student?.username || 'Anonymous Student';
    
    const landlordName = review.landlord?.firstName
        ? `${review.landlord.firstName} ${review.landlord.lastName}`
        : review.landlord?.username || 'Landlord';
    
    const propertyName = review.property?.title || 'Property';
    const hasResponse = review.landlordResponse && review.landlordResponse.comment;
    const isHidden = review.isHidden || false;

    modalContent.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Review Information</h6>
                <p><strong>ID:</strong> #${review._id.slice(-6)}</p>
                <p><strong>Type:</strong> <span class="badge bg-secondary">${review.reviewType === 'booking' ? 'Booking Review' : 'General Review'}</span></p>
                <p><strong>Rating:</strong> <span class="rating-stars">${this.generateStars(review.rating)}</span></p>
                <p><strong>Status:</strong> 
                    <span class="status-badge status-${hasResponse ? 'responded' : 'pending'}">
                        ${hasResponse ? 'Responded' : 'Pending Response'}
                    </span>
                    ${isHidden ? '<span class="badge bg-danger ms-1">Hidden</span>' : ''}
                </p>
                <p><strong>Created:</strong> ${new Date(review.createdAt).toLocaleString()}</p>
                ${review.updatedAt ? `<p><strong>Updated:</strong> ${new Date(review.updatedAt).toLocaleString()}</p>` : ''}
            </div>
            <div class="col-md-6">
                <h6>Student Information</h6>
                <p><strong>Name:</strong> ${studentName}</p>
                <p><strong>Email:</strong> ${review.student?.email || 'Not provided'}</p>
                <p><strong>Phone:</strong> ${review.student?.phone || 'Not provided'}</p>
                
                <h6 class="mt-3">Landlord Information</h6>
                <p><strong>Name:</strong> ${landlordName}</p>
                <p><strong>Email:</strong> ${review.landlord?.email || 'Not provided'}</p>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <h6>Property Information</h6>
                <div class="card">
                    <div class="card-body">
                        <h5>${propertyName}</h5>
                        <p class="mb-1"><strong>Type:</strong> ${review.property?.propertyType || 'N/A'}</p>
                        <p class="mb-1"><strong>Location:</strong> ${review.property?.location?.address || 'N/A'}</p>
                        <p class="mb-0"><strong>Bedrooms:</strong> ${review.property?.bedrooms || 'N/A'}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <h6>Review Details</h6>
                <div class="card">
                    <div class="card-body">
                        <h5>${review.title}</h5>
                        <p class="mb-0">${review.comment}</p>
                    </div>
                </div>
            </div>
        </div>
        
        ${review.cleanliness || review.location || review.value ? `
        <div class="row mt-3">
            <div class="col-12">
                <h6>Detailed Ratings</h6>
                <div class="row">
                    ${review.cleanliness ? `
                        <div class="col-md-4">
                            <p class="mb-1"><strong>Cleanliness:</strong></p>
                            <div class="rating-stars">${this.generateStars(review.cleanliness)}</div>
                        </div>
                    ` : ''}
                    ${review.location ? `
                        <div class="col-md-4">
                            <p class="mb-1"><strong>Location:</strong></p>
                            <div class="rating-stars">${this.generateStars(review.location)}</div>
                        </div>
                    ` : ''}
                    ${review.value ? `
                        <div class="col-md-4">
                            <p class="mb-1"><strong>Value:</strong></p>
                            <div class="rating-stars">${this.generateStars(review.value)}</div>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
        ` : ''}
        
        ${review.isRecommended ? `
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-success">
                    <i class="bi bi-check-circle me-2"></i>This property is recommended by the student
                </div>
            </div>
        </div>
        ` : ''}
        
        ${hasResponse ? `
        <div class="row mt-3">
            <div class="col-12">
                <h6>Landlord Response</h6>
                <div class="alert alert-info">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <strong>Response from ${landlordName}</strong>
                        <small class="text-muted">${new Date(review.landlordResponse.respondedAt).toLocaleString()}</small>
                    </div>
                    <p class="mb-0">${review.landlordResponse.comment}</p>
                </div>
            </div>
        </div>
        ` : ''}
        
        ${review.booking ? `
        <div class="row mt-3">
            <div class="col-12">
                <h6>Booking Information</h6>
                <div class="card">
                    <div class="card-body">
                        <p class="mb-1"><strong>Check-in:</strong> ${new Date(review.booking.checkIn).toLocaleDateString()}</p>
                        <p class="mb-1"><strong>Check-out:</strong> ${new Date(review.booking.checkOut).toLocaleDateString()}</p>
                        <p class="mb-0"><strong>Status:</strong> <span class="badge bg-success">${review.booking.status}</span></p>
                    </div>
                </div>
            </div>
        </div>
        ` : ''}
    `;

    const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
    
    // Update modal footer based on review status
    const modalFooter = document.querySelector('#reviewModal .modal-footer');
    if (modalFooter) {
        if (isHidden) {
            // For hidden reviews, show Unhide button only
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="moderateReview('edit')">
                    <i class="bi bi-pencil me-2"></i>Edit Content
                </button>
                <button type="button" class="btn btn-success" onclick="moderateReview('unhide')">
                    <i class="bi bi-eye me-2"></i>Unhide Review
                </button>
            `;
        } else {
            // For visible reviews, show Edit and Hide buttons
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="moderateReview('edit')">
                    <i class="bi bi-pencil me-2"></i>Edit Content
                </button>
                <button type="button" class="btn btn-danger" onclick="moderateReview('hide')">
                    <i class="bi bi-eye-slash me-2"></i>Hide Review
                </button>
            `;
        }
    }
    
    modal.show();
}


      async deleteReview(reviewId) {
        if (confirm('Are you sure you want to delete this review? This action cannot be undone.')) {
          try {
            const response = await fetch(`${API_BASE_URL}/admin/reviews/${reviewId}`, {
              method: 'DELETE',
              headers: {
                'Authorization': `Bearer ${this.token}`
              }
            });

            const data = await response.json();
            
            if (data.success) {
              this.showSuccess('Review deleted successfully');
              this.loadReviews();
              this.loadReviewStats();
            } else {
              this.showError('Error deleting review: ' + data.error);
            }
          } catch (error) {
            console.error('Error deleting review:', error);
            this.showError('Failed to delete review');
          }
        }
      }

      async remindLandlord(reviewId) {
        // This would integrate with your notification system
        this.showSuccess('Reminder sent to landlord');
      }

      viewProperty(propertyId) {
        if (propertyId) {
          window.open(`property-details.html?id=${propertyId}`, '_blank');
        }
      }

      showSuccess(message) {
        alert(message); // You can replace with toast notifications
      }

      showError(message) {
        alert('Error: ' + message); // You can replace with toast notifications
      }
    }

    // Initialize admin reviews manager
    let adminReviewsManager;

    // Load reviews on page load
    document.addEventListener('DOMContentLoaded', function() {
      adminReviewsManager = new AdminReviewsManager();
    });

    // Global functions for filtering
    function filterByRating(rating) {
      adminReviewsManager.currentFilter.rating = rating;
      adminReviewsManager.currentFilter.page = 1;
      adminReviewsManager.loadReviews();
    }

    function filterByStatus(status) {
      adminReviewsManager.currentFilter.status = status;
      adminReviewsManager.currentFilter.page = 1;
      adminReviewsManager.loadReviews();
    }

    // Moderate review functions
    function moderateReview(action) {
    const modal = bootstrap.Modal.getInstance(document.getElementById('reviewModal'));
    const reviewId = modal ? document.getElementById('reviewDetails').getAttribute('data-review-id') : null;
    
    if (!reviewId) {
        alert('No review selected');
        return;
    }

    document.getElementById('moderateReviewId').value = reviewId;
    document.getElementById('moderateAction').value = action;
    
    const modalTitle = document.getElementById('moderateModalTitle');
    const editSection = document.getElementById('editCommentSection');
    
    if (action === 'edit') {
        modalTitle.textContent = 'Edit Review Content';
        editSection.style.display = 'block';
        
        // Pre-fill with current comment if available
        const currentComment = document.querySelector('#reviewDetails .card-body p')?.textContent || '';
        document.getElementById('modifiedComment').value = currentComment;
    } else if (action === 'hide') {
        modalTitle.textContent = 'Hide Review';
        editSection.style.display = 'none';
    } else if (action === 'unhide') {
        modalTitle.textContent = 'Unhide Review';
        editSection.style.display = 'none';
    }
    
    // Clear previous reason
    document.getElementById('moderateReason').value = '';
    
    const moderateModal = new bootstrap.Modal(document.getElementById('moderateModal'));
    moderateModal.show();
}


    async function submitModeration() {
    const reviewId = document.getElementById('moderateReviewId').value;
    const action = document.getElementById('moderateAction').value;
    const reason = document.getElementById('moderateReason').value.trim();
    const modifiedComment = document.getElementById('modifiedComment').value.trim();

    if (!reason) {
        alert('Please provide a reason for this action');
        return;
    }

    if (action === 'edit' && !modifiedComment) {
        alert('Please provide the modified comment');
        return;
    }

    try {
        const response = await fetch(`${API_BASE_URL}/admin/reviews/${reviewId}/moderate`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${adminReviewsManager.token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: action,
                reason: reason,
                modifiedComment: action === 'edit' ? modifiedComment : undefined,
                isHidden: action === 'hide' ? true : (action === 'unhide' ? false : undefined)
            })
        });

        const data = await response.json();
        
        if (data.success) {
            showNotification(`Review ${action}ed successfully`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('moderateModal')).hide();
            bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
            adminReviewsManager.loadReviews();
            adminReviewsManager.loadReviewStats();
        } else {
            showNotification('Error moderating review: ' + data.error, 'danger');
        }
    } catch (error) {
        console.error('Error moderating review:', error);
        showNotification('Failed to moderate review', 'danger');
    }
}


    // Generate Analytics Report Function
async function generateReviewsReport() {
    try {
        // Show loading state
        const originalText = event.target.innerHTML;
        event.target.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Generating...';
        event.target.disabled = true;

        console.log('Generating reviews analytics report...');
        
        const response = await fetch(`${API_BASE_URL}/admin/reviews/export`, {
            headers: {
                'Authorization': `Bearer ${adminReviewsManager.token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            
            // Create filename with timestamp
            const timestamp = new Date().toISOString().split('T')[0];
            a.download = `reviews-analytics-${timestamp}.csv`;
            
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showNotification('Analytics report downloaded successfully!', 'success');
        } else {
            // Fallback: Generate report from current data
            await generateReviewsReportFallback();
        }
        
        // Reset button
        event.target.innerHTML = originalText;
        event.target.disabled = false;
    } catch (error) {
        console.error('Analytics report error:', error);
        // Fallback to local generation
        await generateReviewsReportFallback();
        
        // Reset button
        event.target.innerHTML = originalText;
        event.target.disabled = false;
    }
}

// Fallback analytics report generation
async function generateReviewsReportFallback() {
    try {
        // Get all reviews for export
        const response = await fetch(`${API_BASE_URL}/admin/reviews?page=1&limit=1000`, {
            headers: {
                'Authorization': `Bearer ${adminReviewsManager.token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            const reviews = data.data?.reviews || [];
            
            // Convert to CSV format
            const csvData = convertReviewsToCSV(reviews);
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            
            const timestamp = new Date().toISOString().split('T')[0];
            a.download = `reviews-analytics-${timestamp}.csv`;
            
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showNotification('Analytics report generated successfully!', 'success');
        } else {
            throw new Error('Failed to fetch data for analytics report');
        }
    } catch (error) {
        console.error('Analytics report generation error:', error);
        showNotification('Failed to generate analytics report: ' + error.message, 'danger');
    }
}

// Convert reviews data to CSV
function convertReviewsToCSV(reviews) {
    const headers = [
        'Review ID',
        'Rating',
        'Title',
        'Comment',
        'Review Type',
        'Student Name',
        'Student Email',
        'Landlord Name', 
        'Landlord Email',
        'Property Name',
        'Property Type',
        'Location',
        'Cleanliness Rating',
        'Location Rating',
        'Value Rating',
        'Is Recommended',
        'Has Response',
        'Response Date',
        'Status',
        'Created Date',
        'Last Updated'
    ];

    const rows = reviews.map(review => {
        const studentName = review.student?.firstName 
            ? `${review.student.firstName} ${review.student.lastName}`
            : review.student?.username || 'Anonymous';
        
        const landlordName = review.landlord?.firstName
            ? `${review.landlord.firstName} ${review.landlord.lastName}`
            : review.landlord?.username || 'Landlord';
        
        const hasResponse = review.landlordResponse && review.landlordResponse.comment;
        const responseDate = hasResponse ? new Date(review.landlordResponse.respondedAt).toLocaleDateString() : '';
        const status = review.isHidden ? 'hidden' : (hasResponse ? 'responded' : 'pending');

        return [
            `"${review._id || ''}"`,
            `"${review.rating || ''}"`,
            `"${(review.title || '').replace(/"/g, '""')}"`,
            `"${(review.comment || '').replace(/"/g, '""')}"`,
            `"${review.reviewType || ''}"`,
            `"${studentName}"`,
            `"${review.student?.email || ''}"`,
            `"${landlordName}"`,
            `"${review.landlord?.email || ''}"`,
            `"${review.property?.title || ''}"`,
            `"${review.property?.propertyType || ''}"`,
            `"${review.property?.location?.address || ''}"`,
            `"${review.cleanliness || ''}"`,
            `"${review.location || ''}"`,
            `"${review.value || ''}"`,
            `"${review.isRecommended ? 'Yes' : 'No'}"`,
            `"${hasResponse ? 'Yes' : 'No'}"`,
            `"${responseDate}"`,
            `"${status}"`,
            `"${review.createdAt ? new Date(review.createdAt).toLocaleDateString() : ''}"`,
            `"${review.updatedAt ? new Date(review.updatedAt).toLocaleDateString() : ''}"`
        ];
    });

    return [headers, ...rows].map(row => row.join(',')).join('\n');
}

// Notification function
function showNotification(message, type) {
    // Create toast notification
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.id = toastId;
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
    toastContainer.style.zIndex = '9999';
    document.body.appendChild(toastContainer);
    return toastContainer;
}

    
  </script>
</body>
</html>