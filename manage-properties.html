<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Properties | ResLinQ</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="style.css">
  
  <style>
    :root {
      --primary: #1e3a8a;
      --primary-light: #3b82f6;
      --primary-dark: #1e40af;
      --success: #059669;
      --warning: #f59e0b;
      --info: #60a5fa;
      --light-bg: #f8fafc;
    }
    
    body {
      background-color: var(--light-bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .bg-navy {
      background-color: var(--primary) 
    }
    
    .text-navy {
      color: var(--primary) 
    }
    
    .btn-navy {
      background-color: var(--primary);
      color: white;
      border: none;
    }
    
    .btn-navy:hover {
      background-color: var(--primary-dark);
      color: white;
    }
    
    /* Enhanced Hero Section with Animations */
    .properties-hero {
      background: linear-gradient(135deg, var(--primary) 0%, #9983e7 50%, var(--primary-light) 100%);
      color: white;
      padding: 4rem 0;
      border-radius: 0 0 1.5rem 1.5rem;
      margin-bottom: 1.5rem;
      position: relative;
      overflow: hidden;
      opacity: 0;
      animation: heroReveal 1s ease-out 0.2s forwards;
      display: flex;
      align-items: center;
      min-height: 250px;
    }

    .properties-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
      animation: float 20s infinite linear;
    }

    .hero-content {
      position: relative;
      z-index: 1;
      width: 100%;
    }

    .hero-title {
      animation: fadeInUp 0.8s ease-out 0.4s both;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .hero-subtitle {
      animation: fadeInUp 0.8s ease-out 0.6s both;
      font-size: 1.2rem;
      margin-bottom: 1.5rem;
      opacity: 0.9;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.5;
    }

    .hero-actions {
      animation: fadeInUp 0.8s ease-out 0.8s both;
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .hero-actions .btn {
      border-radius: 50px;
      padding: 0.6rem 1.5rem;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .hero-actions .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    /* Mobile Responsiveness for properties hero */
    @media (max-width: 768px) {
        .properties-hero {
            padding: 3rem 0;
            min-height: 200px;
        }
        
        .hero-title {
            font-size: 2rem;
        }
        
        .hero-subtitle {
            font-size: 1rem;
            padding: 0 1rem;
        }
        
        .hero-actions {
            gap: 0.75rem;
        }
        
        .hero-actions .btn {
            padding: 0.5rem 1.25rem;
            font-size: 0.9rem;
        }
    }

    @media (max-width: 576px) {
        .properties-hero {
            padding: 2.5rem 0;
            min-height: 180px;
        }
        
        .hero-title {
            font-size: 1.75rem;
        }
        
        .hero-subtitle {
            font-size: 0.95rem;
        }
        
        .hero-actions {
            flex-direction: column;
            align-items: center;
        }
        
        .hero-actions .btn {
            width: 200px;
            justify-content: center;
        }
    }

    /* Enhanced Stats Cards with Animations */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      position: relative;
    }
    
    @media (min-width: 768px) {
      .stats-container {
        grid-template-columns: repeat(6, 1fr);
        gap: 1rem;
      }
    }
    
    .stats-card {
      border: none;
      border-radius: 0.75rem;
      color: white;
      text-align: center;
      padding: 1rem 0.5rem;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      height: 100%;
      position: relative;
      overflow: hidden;
      animation: fadeInScale 0.6s ease-out;
    }

    .stats-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .stats-card:hover::before {
      left: 100%;
    }
    
    .stats-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .stats-card i {
      font-size: 1.5rem;
      opacity: 0.8;
      margin-bottom: 0.5rem;
    }
    
    .stats-card h5 {
      font-size: 1.25rem;
      margin-bottom: 0.25rem;
    }
    
    .stats-card small {
      font-size: 0.7rem;
    }
    
    @media (min-width: 768px) {
      .stats-card i {
        font-size: 2rem;
        margin-bottom: 0.75rem;
      }
      
      .stats-card h5 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }
      
      .stats-card small {
        font-size: 0.8rem;
      }
    }
    
    /* Property Cards - Enhanced Mobile Responsiveness */
    .property-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: none;
      border-radius: 0.75rem;
      height: 100%;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin-bottom: 1rem;
      overflow: hidden;
    }
    
    .property-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .property-card.available { border-left: 4px solid var(--success); }
    .property-card.occupied { border-left: 4px solid var(--warning); }
    .property-card.maintenance { border-left: 4px solid #dc3545; }
    
    .status-badge {
      font-size: 0.7em;
      padding: 0.3em 0.6em;
      border-radius: 15px;
    }
    
    .property-image {
      height: 160px;
      object-fit: cover;
      width: 100%;
      border-radius: 0.75rem 0.75rem 0 0;
    }
    
    .empty-state {
      text-align: center;
      padding: 2rem 1rem;
      color: #6c757d;
    }
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    .feature-badge {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 12px;
      padding: 0.2rem 0.6rem;
      font-size: 0.7em;
      margin: 0.1rem;
    }
    
    .action-buttons .btn {
      margin: 0.05rem;
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
    }
    
    .image-upload-container {
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .image-upload-container:hover {
      border-color: var(--primary);
      background: #e7f1ff;
    }
    .image-upload-container.dragover {
      border-color: var(--primary);
      background: #d4e6ff;
    }
    .image-preview {
      max-width: 100%;
      max-height: 150px;
      margin-top: 1rem;
      display: none;
    }
    
    .btn-landlord {
      border-radius: 2rem;
      padding: 0.5rem 1.5rem;
      font-weight: 500;
    }
    
    /* Filter and Search - Mobile Optimized */
    .filter-section {
      margin-bottom: 1.5rem;
    }
    
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    
    .filter-select {
      flex: 1 1 calc(50% - 0.5rem);
      min-width: 120px;
    }
    
    @media (min-width: 768px) {
      .filter-select {
        flex: 0 1 auto;
        width: auto;
      }
    }
    
    .search-container {
      display: flex;
      gap: 0.5rem;
    }
    
    .search-container .form-control {
      flex: 1;
    }
    
    /* View Toggle - Mobile Optimized */
    .view-toggle {
      margin-bottom: 1.5rem;
    }
    
    /* Property Cards - Enhanced Mobile Grid */
    .properties-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    
    @media (min-width: 480px) {
      .properties-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (min-width: 768px) {
      .properties-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (min-width: 992px) {
      .properties-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (min-width: 1200px) {
      .properties-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    /* Table Responsive */
    .table-responsive {
      font-size: 0.875rem;
    }
    
    /* Modal Improvements for Mobile */
    .modal-dialog {
      margin: 1rem;
    }
    
    @media (min-width: 576px) {
      .modal-dialog {
        margin: 1.75rem auto;
      }
    }

    /* Fixed Modal Z-Index Hierarchy */
.modal-backdrop {
  z-index: 1040 !important;
}

.modal {
  z-index: 1050 !important;
}

/* Photography Prompt Modal - Highest priority */
#photographyPromptModal {
  z-index: 1080 !important;
}

#photographyPromptModal.modal-backdrop {
  z-index: 1075 !important;
}

/* Add Property Modal */
#addPropertyModal {
  z-index: 1060 !important;
}

/* Edit Property Modal */
#editPropertyModal {
  z-index: 1065 !important;
}

/* Property Details Modal */
#propertyDetailsModal {
  z-index: 1070 !important;
}

/* Room Management Modal */
#roomManagementModal {
  z-index: 1075 !important;
}

/* Property Stats Modal (dynamically created) */
#propertyStatsModal {
  z-index: 1085 !important;
}
    
    /* Room Management Styles */
    .room-card {
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
    }
    
    .room-card:hover {
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    /* Loading spinner */
    .loading-spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .room-features-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .room-feature-badge {
      background-color: #e9ecef;
      color: #495057;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
    }

    /* Ensure proper spacing between content and footer */
    html, body {
        height: 100%;
        margin: 0;
    }

    body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    main {
        flex: 1 0 auto;
        padding-bottom: 2rem;
    }

    footer {
        flex-shrink: 0;
    }

    /* Multiple Image Upload Styles */
    .multi-image-upload {
      margin-bottom: 1rem;
    }
    
    .image-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .image-preview-item {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #dee2e6;
    }
    
    .image-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .image-preview-item .remove-image {
      position: absolute;
      top: 2px;
      right: 2px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
    }
    
    .image-preview-item .remove-image:hover {
      background: rgba(220, 53, 69, 0.9);
    }
    
    .image-url-input-group {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .image-url-input-group .form-control {
      flex: 1;
    }
    
    .image-url-list {
      margin-top: 0.5rem;
    }
    
    .image-url-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.25rem 0.5rem;
      background: #f8f9fa;
      border-radius: 4px;
      margin-bottom: 0.25rem;
    }
    
    .image-url-item .remove-url {
      background: none;
      border: none;
      color: #dc3545;
      cursor: pointer;
    }

    /* Property Statistics Modal Styles */
    .property-stats-modal .card {
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
    }

    .property-stats-modal .card:hover {
        transform: translateY(-2px);
    }

    .property-stats-modal .progress {
        background-color: #e9ecef;
    }

    .property-stats-modal .table th {
        border-top: none;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        color: #6c757d;
    }

    .property-stats-modal .table td {
        font-size: 0.875rem;
        vertical-align: middle;
    }

    /* Enhanced Animations */
    @keyframes heroReveal {
      0% {
        opacity: 0;
        transform: translateY(-10px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes float {
      0% {
        transform: translate(0, 0);
      }
      50% {
        transform: translate(-5px, -5px);
      }
      100% {
        transform: translate(0, 0);
      }
    }

    /* Property Card Mobile Optimizations */
    @media (max-width: 480px) {
      .property-card .card-body {
        padding: 0.75rem;
      }
      
      .property-card .card-title {
        font-size: 0.9rem;
      }
      
      .property-card .feature-badge {
        font-size: 0.65em;
        padding: 0.15rem 0.4rem;
      }
      
      .property-card .action-buttons .btn {
        padding: 0.2rem 0.4rem;
        font-size: 0.75rem;
      }
    }

    /* Enhanced Property Grid for Small Screens */
    @media (max-width: 380px) {
      .properties-grid {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }
      
      .stats-container {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
      }
      
      .stats-card {
        padding: 0.75rem 0.25rem;
      }
      
      .stats-card i {
        font-size: 1.25rem;
      }
      
      .stats-card h5 {
        font-size: 1.1rem;
      }
    }

    /* Better spacing for action buttons on mobile */
    @media (max-width: 576px) {
      .action-buttons {
        flex-wrap: wrap;
        justify-content: center !important;
      }
      
      .action-buttons .btn {
        margin: 0.1rem;
        flex: 0 0 auto;
      }

      /* Fix Modal Z-Index Hierarchy */
.modal-backdrop {
  z-index: 1040 !important;
}

.modal {
  z-index: 1050 !important;
}

#propertyStatsModal {
  z-index: 1060 !important;
}

#propertyStatsModal .modal-backdrop {
  z-index: 1055 !important;
}

#roomManagementModal {
  z-index: 1070 !important;
}

#roomManagementModal .modal-backdrop {
  z-index: 1065 !important;
}

/* Ensure modals stack properly */
.modal.fade.show {
  z-index: inherit !important;
}

/* Modal Centering for Mobile */
@media (max-width: 576px) {
  .modal-dialog.modal-dialog-centered {
    min-height: calc(100% - 1rem);
    margin: 0.5rem auto;
  }
  
  .modal-content {
    border-radius: 0.5rem;
  }
}

/* Ensure form validation styling */
.was-validated .form-control:invalid,
.form-control.is-invalid {
  border-color: #dc3545;
  padding-right: calc(1.5em + 0.75rem);
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.4.4.4-.4'/%3e%3cpath d='M6 7v1'/%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right calc(0.375em + 0.1875rem) center;
  background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.was-validated .form-control:valid,
.form-control.is-valid {
  border-color: #198754;
  padding-right: calc(1.5em + 0.75rem);
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right calc(0.375em + 0.1875rem) center;
  background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}
    }

/* Mobile Bottom Navigation */
.mobile-bottom-nav {
  display: none;
}

@media (max-width: 767px) {
  .mobile-bottom-nav {
    display: flex;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #1C2B4A;
    z-index: 1030;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
  }
  
  .mobile-nav-item {
    flex: 1;
    text-align: center;
    padding: 0.5rem;
    color: #fff;
    text-decoration: none;
    font-size: 0.75rem;
  }
  
  .mobile-nav-item.active {
    color: #64748b;
  }
  
  .mobile-nav-item i {
    display: block;
    font-size: 1.25rem;
    margin-bottom: 0.25rem;
  }
  
  /* Add padding to main content to account for bottom nav */
  main {
    margin-bottom: 80px;
  }
}

/* Fixed Modal Z-Index Hierarchy - CLEAN VERSION */
.modal-backdrop {
  z-index: 1040 !important;
}

.modal {
  z-index: 1050 !important;
}

/* Property Details Modal */
#propertyDetailsModal {
  z-index: 1060 !important;
}

/* Edit Property Modal */
#editPropertyModal {
  z-index: 1070 !important;
}

/* Room Management Modal */
#roomManagementModal {
  z-index: 1080 !important;
}

/* Add Property Modal */
#addPropertyModal {
  z-index: 1090 !important;
}

/* Photography Prompt Modal - Highest priority */
#photographyPromptModal {
  z-index: 1100 !important;
}

/* Property Stats Modal (dynamically created) */
#propertyStatsModal {
  z-index: 1110 !important;
}

/* Room Details Modal (dynamically created) */
#roomDetailsModal {
  z-index: 1120 !important;
}

/* Ensure proper stacking for all modals */
.modal.fade.show {
  z-index: inherit !important;
}

/* Enhanced Logout Modal Styling with Proper Z-Index */
#logoutModal {
  z-index: 1200 !important;
}

#logoutModal .modal-backdrop {
  z-index: 1195 !important;
}

#logoutModal .modal-content {
  border: none;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

#logoutModal .logout-icon-container {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%) !important;
}

#logoutModal .logout-icon-container i {
  color: white !important;
}

#logoutModal .modal-header {
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  border-radius: 15px 15px 0 0 !important;
}

#logoutModal .btn-primary {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  border: none;
  border-radius: 8px;
  padding: 10px 24px;
  font-weight: 500;
}

#logoutModal .btn-outline-secondary {
  border-radius: 8px;
  padding: 10px 24px;
  font-weight: 500;
}

#logoutModal .modal-body i.bi-person-check {
  color: var(--primary) !important;
}

/* Ensure modal backdrop covers everything */
.modal-backdrop.show {
  opacity: 0.5 !important;
}
</style>
</head>
<body>

  <!-- Redirect if not logged in as landlord -->
  <script>
    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    
    if (!token) {
      alert("Please log in to access this page.");
      window.location.href = "authorization.html";
    } else if (user.role !== 'landlord') {
      alert("This page is for landlords only.");
      window.location.href = "index.html";
    }
  </script>

  <!-- Dynamic Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-navy">
    <div class="container">
      <a class="navbar-brand" href="home.html"><i class="bi bi-house-heart-fill me-3"></i>ResLinQ</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
        <ul class="navbar-nav">
          <!-- Navigation will be populated by navbar.js -->
        </ul>
      </div>
      
      <!-- Dynamic Auth Buttons -->
      <div class="signup-login-buttons">
        <!-- Content will be populated by navbar.js -->
      </div>
    </div>
  </nav>


  <!-- Enhanced Hero Section -->
<section class="properties-hero">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <h1 class="display-6 fw-bold mb-2 hero-title">Manage Properties</h1>
        <p class="lead mb-3 hero-subtitle">Add, edit, and manage your rental properties</p>
      </div>
      <!-- In your hero section -->
    <div class="col-lg-4 text-lg-end mt-3 mt-lg-0 hero-actions">
      <button class="btn btn-light btn-lg" id="addPropertyHeroBtn">
        <i class="bi bi-plus-circle me-2"></i>Add New Property
      </button>
    </div>
    </div>
  </div>
</section>

  <main class="container">
    <!-- Property Statistics - Mobile Optimized -->
    <div class="stats-container">
      <div class="stats-card" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);">
        <i class="bi bi-buildings"></i>
        <h5 id="totalProperties">0</h5>
        <small>Total</small>
      </div>
      <div class="stats-card" style="background: linear-gradient(135deg, var(--success) 0%, #047857 100%);">
        <i class="bi bi-check-circle"></i>
        <h5 id="availableProperties">0</h5>
        <small>Available</small>
      </div>
      <div class="stats-card" style="background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);">
        <i class="bi bi-person-check"></i>
        <h5 id="occupiedProperties">0</h5>
        <small>Occupied</small>
      </div>
      <div class="stats-card" style="background: linear-gradient(135deg, var(--info) 0%, #3b82f6 100%);">
        <i class="bi bi-calendar-check"></i>
        <h5 id="activeBookings">0</h5>
        <small>Bookings</small>
      </div>
      <div class="stats-card" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
        <i class="bi bi-cash-coin"></i>
        <h5 id="totalEarnings">0</h5>
        <small>Revenue</small>
      </div>
      <div class="stats-card" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);">
        <i class="bi bi-tools"></i>
        <h5 id="maintenanceProperties">0</h5>
        <small>Maintenance</small>
      </div>
    </div>

    <!-- Filter and Search - Mobile Optimized -->
    <div class="filter-section">
      <div class="row">
        <div class="col-md-8 mb-2">
          <div class="filter-row">
            <select class="form-select filter-select" id="statusFilter" onchange="filterProperties()">
              <option value="">All Statuses</option>
              <option value="available">Available</option>
              <option value="occupied">Occupied</option>
              <option value="maintenance">Maintenance</option>
            </select>
            <select class="form-select filter-select" id="typeFilter" onchange="filterProperties()">
              <option value="">All Types</option>
              <option value="apartment">Apartment</option>
              <option value="house">House</option>
              <option value="condo">Condo</option>
              <option value="townhouse">Townhouse</option>
              <option value="studio">Studio</option>
              
            </select>
            <select class="form-select filter-select" id="locationFilter" onchange="filterProperties()">
              <option value="">All Locations</option>
              <option value="bloemfontein">Bloemfontein</option>
              <option value="johannesburg">Johannesburg</option>
              <option value="pretoria">Pretoria</option>
              <option value="cape-town">Cape Town</option>
              <option value="durban">Durban</option>
              <option value="pietermaritzburg">Pietermaritzburg</option>
            </select>
          </div>
        </div>
        <div class="col-md-4">
          <div class="search-container">
            <input type="text" class="form-control" placeholder="Search..." id="searchInput" onkeyup="filterProperties()">
            <button class="btn btn-primary" onclick="filterProperties()">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Toggle - Mobile Optimized -->
    <div class="view-toggle">
      <div class="btn-group btn-group-sm" role="group">
        <input type="radio" class="btn-check" name="viewMode" id="gridView" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="gridView">
          <i class="bi bi-grid-3x3-gap me-1"></i>Grid
        </label>
        <input type="radio" class="btn-check" name="viewMode" id="listView" autocomplete="off">
        <label class="btn btn-outline-primary" for="listView">
          <i class="bi bi-list-ul me-1"></i>List
        </label>
      </div>
    </div>

    <!-- Loading State -->
    <div class="row mt-4" id="loadingState">
      <div class="col-12 text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading properties...</p>
      </div>
    </div>

    <!-- Properties Grid View -->
    <div class="properties-grid" id="propertiesGridView" style="display: none;">
      <!-- Properties will be loaded here -->
    </div>

    <!-- Properties List View (Hidden by default) -->
    <div class="row" id="propertiesListView" style="display: none;">
      <div class="col-12">
        <div class="card">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>Property</th>
                    <th>Location</th>
                    <th>Type</th>
                    <th>Price</th>
                    <th>Status</th>
                    <th>Gender</th>
                    <th>Accreditation</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="propertiesTable">
                  <!-- Properties table rows will be populated here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="row mt-4" id="emptyState" style="display: none;">
      <div class="col-12">
        <div class="empty-state">
          <i class="bi bi-house-door"></i>
          <h4>No properties yet</h4>
          <p class="text-muted">Start by adding your first student accommodation property to begin receiving booking requests.</p>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPropertyModal">
            <i class="bi bi-plus-circle me-1"></i>Add Your First Property
          </button>
        </div>
      </div>
    </div>

  </main>

  <!-- Photography Prompt Modal - FIXED Z-INDEX -->
<div class="modal fade" id="photographyPromptModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title">
          <i class="bi bi-camera me-2"></i>Professional Photos = Better Results
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div class="mb-4">
          <i class="bi bi-camera-fill display-4 text-warning mb-3"></i>
          <h5>Get Professional Property Photos</h5>
          <p class="text-muted">
            Listings with professional photos get <strong>3x more views</strong> and <strong>book 47% faster</strong>!
          </p>
        </div>
        
        <div class="bg-light p-3 rounded mb-3">
          <h6 class="text-navy">Harmse Photography (Pty) Ltd</h6>
          <p class="mb-2">Specialized in student accommodation photography</p>
          <div class="d-flex justify-content-center gap-3">
            <a href="https://wa.me/27813332265" class="btn btn-success btn-sm">
              <i class="bi bi-whatsapp me-1"></i>WhatsApp
            </a>
            <a href="tel:+27813332265" class="btn btn-primary btn-sm">
              <i class="bi bi-telephone me-1"></i>Call Now
            </a>
            <a href="https://harmsephotography.co.za/" target="_blank" class="btn btn-info btn-sm">
              <i class="bi bi-globe me-1"></i>Website
            </a>
          </div>
        </div>
        
        <div class="alert alert-info small">
          <i class="bi bi-lightbulb me-1"></i>
          <strong>Tip:</strong> You can still proceed with your own photos, but we recommend professional shots for best results.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" onclick="proceedToAddProperty()">
          I'll Use My Own Photos
        </button>
        <button type="button" class="btn btn-warning" onclick="proceedToAddProperty()">
          <i class="bi bi-plus-circle me-1"></i>Add Property Anyway
        </button>
      </div>
    </div>
  </div>
</div>

  <!-- Enhanced Add Property Modal -->
<div class="modal fade" id="addPropertyModal" tabindex="-1" aria-labelledby="addPropertyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="addPropertyModalLabel">
          <i class="bi bi-plus-circle me-2"></i>Add New Property
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addPropertyForm" class="needs-validation" novalidate>
          <!-- Property Basic Information -->
          <div class="row mb-4">
            <div class="col-12">
              <h6 class="text-primary mb-3 border-bottom pb-2">
                <i class="bi bi-info-circle me-2"></i>Basic Information
              </h6>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label fw-semibold">Property Title *</label>
                <input type="text" class="form-control form-control-lg" name="title" required placeholder="e.g., Modern Apartment near UFS">
                <div class="invalid-feedback">Please provide a property title.</div>
              </div>
              <div class="mb-3">
                <label class="form-label fw-semibold">Property Type *</label>
                <select class="form-select form-select-lg" name="propertyType" required>
                  <option value="">Select Property Type</option>
                  <option value="apartment">Apartment</option>
                  <option value="house">House</option>
                  <option value="condo">Condo</option>
                  <option value="townhouse">Townhouse</option>
                  <option value="studio">Studio</option>
                </select>
                <div class="invalid-feedback">Please select a property type.</div>
              </div>
              <div class="mb-3">
                <label class="form-label fw-semibold">Monthly Rent (ZAR) *</label>
                <div class="input-group">
                  <span class="input-group-text bg-light">R</span>
                  <input type="number" class="form-control form-control-lg" name="price" required min="0" placeholder="3500">
                </div>
                <div class="invalid-feedback">Please provide a valid rent amount.</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
              <label class="form-label fw-semibold">Number of Bedrooms *</label>
                <div class="input-group">
                  <input type="number" class="form-control form-control-lg" name="bedrooms" required min="0" max="50" placeholder="2">
                  <span class="input-group-text bg-light">rooms</span>
                </div>
                <div class="invalid-feedback">Please enter the number of bedrooms.</div>
              </div>
              <div class="mb-3">
              <label class="form-label fw-semibold">Number of Bathrooms *</label>
              <div class="input-group">
                <input type="number" class="form-control form-control-lg" name="bathrooms" required min="0" max="20" step="0.5" placeholder="1.5">
                <span class="input-group-text bg-light">bathrooms</span>
              </div>
              <div class="invalid-feedback">Please enter the number of bathrooms.</div>
              <small class="text-muted">You can use decimals (e.g., 1.5 for one full bathroom and one half bathroom)</small>
            </div>
              <div class="mb-3">
                <label class="form-label fw-semibold">Property Status *</label>
                <select class="form-select form-select-lg" name="availability" required>
                  <option value="available">Available</option>
                  <option value="occupied">Occupied</option>
                  <option value="maintenance">Under Maintenance</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Location Information -->
          <div class="row mb-4">
            <div class="col-12">
              <h6 class="text-primary mb-3 border-bottom pb-2">
                <i class="bi bi-geo-alt me-2"></i>Location Details
              </h6>
            </div>
            <div class="col-12 mb-3">
              <label class="form-label fw-semibold">Full Address *</label>
              <input type="text" class="form-control" name="address" required placeholder="123 University Street, Campus Area">
              <div class="invalid-feedback">Please provide the full address.</div>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label fw-semibold">City *</label>
              <select class="form-select" name="city" required>
                <option value="">Select City</option>
                <option value="Bloemfontein">Bloemfontein</option>
                <option value="Johannesburg">Johannesburg</option>
                <option value="Pretoria">Pretoria</option>
                <option value="Cape Town">Cape Town</option>
                <option value="Durban">Durban</option>
                <option value="Other">Pietermaritzburg</option>
              </select>
              <div class="invalid-feedback">Please select a city.</div>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label fw-semibold">State *</label>
              <input type="text" class="form-control" name="state" required placeholder="Free State">
              <div class="invalid-feedback">Please provide the state.</div>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label fw-semibold">Zip Code *</label>
              <input type="text" class="form-control" name="zipCode" required placeholder="9301">
              <div class="invalid-feedback">Please provide the zip code.</div>
            </div>
          </div>

          <!-- Student Accommodation Details -->
          <div class="row mb-4">
            <div class="col-12">
              <h6 class="text-primary mb-3 border-bottom pb-2">
                <i class="bi bi-people me-2"></i>Student Accommodation Details
              </h6>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Gender Preference *</label>
              <select class="form-select" name="genderPreference" required>
                <option value="">Select Preference</option>
                <option value="unisex">Unisex (Any Gender)</option>
                <option value="male">Male Only</option>
                <option value="female">Female Only</option>
              </select>
              <small class="text-muted">Choose the gender preference for this accommodation</small>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Accreditation Type *</label>
              <select class="form-select" name="accreditation" required>
                <option value="">Select Accreditation</option>
                <option value="accredited">Accredited (University-approved)</option>
                <option value="self">Self-paying (Private accommodation)</option>
              </select>
              <small class="text-muted">Choose whether this is university-accredited or private accommodation</small>
            </div>
          </div>

          <!-- Property Images -->
          <div class="row mb-4">
            <div class="col-12">
              <h6 class="text-primary mb-3 border-bottom pb-2">
                <i class="bi bi-images me-2"></i>Property Images
              </h6>
              <div class="mb-3">
                <label class="form-label fw-semibold">Upload Images</label>
                <input type="file" class="form-control" id="propertyImageFile" accept="image/*" multiple 
                       onchange="handleMultiplePropertyImageUpload('propertyImageFile', 'propertyImagePreviewContainer')">
                <small class="text-muted">You can select multiple images. Maximum 10 images.</small>
                
                <div class="image-preview-container mt-3" id="propertyImagePreviewContainer">
                  <!-- Preview images will be added here -->
                </div>
              </div>
              
              <div class="mt-3">
                <label class="form-label fw-semibold">Or Add Image URLs</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="propertyImageUrlInput" placeholder="https://example.com/image.jpg">
                  <button type="button" class="btn btn-outline-primary" onclick="addPropertyImageUrl()">Add URL</button>
                </div>
                <div class="image-url-list mt-2" id="propertyImageUrlList">
                  <!-- URL items will be added here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Property Description -->
          <div class="row mb-4">
            <div class="col-12">
              <h6 class="text-primary mb-3 border-bottom pb-2">
                <i class="bi bi-text-paragraph me-2"></i>Property Description
              </h6>
              <div class="mb-3">
                <label class="form-label fw-semibold">Description *</label>
                <textarea class="form-control" name="description" rows="4" required 
                          placeholder="Describe the property, amenities, nearby facilities, and any important details for students..."></textarea>
                <div class="invalid-feedback">Please provide a property description.</div>
              </div>
            </div>
          </div>

          <!-- Amenities -->
          <div class="row mb-4">
            <div class="col-12">
              <h6 class="text-primary mb-3 border-bottom pb-2">
                <i class="bi bi-list-check me-2"></i>Amenities & Features
              </h6>
              <div class="row">
                <div class="col-md-3 col-6 mb-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="amenities" value="wifi" id="wifi">
                    <label class="form-check-label" for="wifi">
                      <i class="bi bi-wifi me-1"></i>WiFi
                    </label>
                  </div>
                </div>
                <div class="col-md-3 col-6 mb-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="amenities" value="parking" id="parking">
                    <label class="form-check-label" for="parking">
                      <i class="bi bi-car-front me-1"></i>Parking
                    </label>
                  </div>
                </div>
                <div class="col-md-3 col-6 mb-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="amenities" value="laundry" id="laundry">
                    <label class="form-check-label" for="laundry">
                      <i class="bi bi-droplet me-1"></i>Laundry
                    </label>
                  </div>
                </div>
                <div class="col-md-3 col-6 mb-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="amenities" value="furnished" id="furnished">
                    <label class="form-check-label" for="furnished">
                      <i class="bi bi-house me-1"></i>Furnished
                    </label>
                  </div>
                </div>
                <div class="col-md-3 col-6 mb-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="amenities" value="gym" id="gym">
                    <label class="form-check-label" for="gym">
                      <i class="bi bi-activity me-1"></i>Gym
                    </label>
                  </div>
                </div>
                <div class="col-md-3 col-6 mb-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="amenities" value="pool" id="pool">
                    <label class="form-check-label" for="pool">
                      <i class="bi bi-water me-1"></i>Pool
                    </label>
                  </div>
                </div>
                <div class="col-md-3 col-6 mb-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="amenities" value="ac" id="ac">
                    <label class="form-check-label" for="ac">
                      <i class="bi bi-snow me-1"></i>Air Conditioning
                    </label>
                  </div>
                </div>
                <div class="col-md-3 col-6 mb-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="amenities" value="shuttle" id="shuttle">
                    <label class="form-check-label" for="shuttle">
                      <i class="bi bi-bus-front me-1"></i>Shuttle 
                    </label>
                  </div>
                </div>
                <div class="col-md-3 col-6 mb-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="amenities" value="cctv" id="cctv">
                    <label class="form-check-label" for="cctv">
                      <i class="bi bi-camera-video me-1"></i>CCTV
                    </label>
                  </div>
                </div>
                <div class="col-md-3 col-6 mb-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="amenities" value="heating" id="heating">
                    <label class="form-check-label" for="heating">
                      <i class="bi bi-thermometer-sun me-1"></i>Heating
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary px-4" onclick="addNewProperty()" id="addPropertyBtn">
          <i class="bi bi-plus-circle me-2"></i>Add Property
        </button>
      </div>
    </div>
  </div>
</div>



  <!-- Property Details Modal -->
  <div class="modal fade" id="propertyDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Property Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="propertyDetailsContent">
          <!-- Content will be populated dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Property Modal -->
  <div class="modal fade" id="editPropertyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Property</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editPropertyForm">
            <input type="hidden" id="editPropertyId">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Property Title *</label>
                  <input type="text" class="form-control" id="editPropertyTitle" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Property Type *</label>
                  <select class="form-select" id="editPropertyType" required>
                    <option value="">Select Type</option>
                    <option value="apartment">Apartment</option>
                    <option value="house">House</option>
                    <option value="condo">Condo</option>
                    <option value="townhouse">Townhouse</option>
                    <option value="studio">Studio</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Monthly Rent (ZAR) *</label>
                  <input type="number" class="form-control" id="editPropertyPrice" required min="0">
                </div>
                <div class="mb-3">
                  <label class="form-label">Address *</label>
                  <input type="text" class="form-control" id="editPropertyAddress" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">City *</label>
                  <select class="form-select" id="editPropertyCity" required>
                    <option value="">Select City</option>
                    <option value="Bloemfontein">Bloemfontein</option>
                    <option value="Johannesburg">Johannesburg</option>
                    <option value="Pretoria">Pretoria</option>
                    <option value="Cape Town">Cape Town</option>
                    <option value="Durban">Durban</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">State *</label>
                  <input type="text" class="form-control" id="editPropertyState" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Zip Code *</label>
                  <input type="text" class="form-control" id="editPropertyZipCode" required>
                </div>
        

                <!-- Add these fields to your Edit Property Modal -->
                <div class="mb-3">
                    <label class="form-label">Number of Bedrooms *</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="editPropertyBedrooms" required min="0" max="50" placeholder="2">
                        <span class="input-group-text bg-light">rooms</span>
                    </div>
                    <div class="invalid-feedback">Please enter the number of bedrooms.</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Number of Bathrooms *</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="editPropertyBathrooms" required min="0" max="20" step="0.5" placeholder="1.5">
                        <span class="input-group-text bg-light">bathrooms</span>
                    </div>
                    <div class="invalid-feedback">Please enter the number of bathrooms.</div>
                    <small class="text-muted">You can use decimals (e.g., 1.5 for one full bathroom and one half bathroom)</small>
                </div>
                
                <!-- Gender Preference in Edit -->
                <div class="mb-3">
                  <label class="form-label">Gender Preference *</label>
                  <select class="form-select" id="editPropertyGenderPreference" required>
                    <option value="">Select Preference</option>
                    <option value="unisex">Unisex (Any Gender)</option>
                    <option value="male">Male Only</option>
                    <option value="female">Female Only</option>
                  </select>
                </div>
                
                <!-- Accreditation in Edit -->
                <div class="mb-3">
                  <label class="form-label">Accreditation Type *</label>
                  <select class="form-select" id="editPropertyAccreditation" required>
                    <option value="">Select Accreditation</option>
                    <option value="accredited">Accredited (University-approved)</option>
                    <option value="self">Self-paying (Private accommodation)</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Property Availability in Edit -->
            <div class="mb-3">
              <label class="form-label">Property Availability *</label>
              <select class="form-select" id="editPropertyAvailability" required>
                <option value="available">Available</option>
                <option value="occupied">Occupied</option>
                <option value="maintenance">Under Maintenance</option>
              </select>
            </div>
            
            <div class="row">
              <div class="col-12">
                <div class="mb-3">
                  <label class="form-label">Description *</label>
                  <textarea class="form-control" id="editPropertyDescription" rows="3" required></textarea>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-12">
                <label class="form-label">Amenities</label>
                <div class="row">
                  <div class="col-md-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="editAmenityWifi" value="wifi">
                      <label class="form-check-label">WiFi</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="editAmenityParking" value="parking">
                      <label class="form-check-label">Parking</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="editAmenityLaundry" value="laundry">
                      <label class="form-check-label">Laundry</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="editAmenityFurnished" value="furnished">
                      <label class="form-check-label">Furnished</label>
                    </div>
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-md-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="editAmenityGym" value="gym">
                      <label class="form-check-label">Gym</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="editAmenityPool" value="pool">
                      <label class="form-check-label">Pool</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="editAmenityAC" value="ac">
                      <label class="form-check-label">Air Conditioning</label>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="editAmenityCCTV" value="cctv">
                      <label class="form-check-label">CCTV</label>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="editAmenityShuttle" value="shuttle">
                      <label class="form-check-label">Shuttle</label>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="editAmenityHeating" value="heating">
                      <label class="form-check-label">Heating</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Enhanced Image Upload for Edit - MULTIPLE IMAGES -->
            <div class="mb-3">
              <label class="form-label">Update Property Images</label>
              
              <!-- Option 1: Upload multiple files from storage -->
              <div class="mb-3">
                <label class="form-label small">Upload from your device:</label>
                <input type="file" class="form-control" id="editPropertyImageFile" accept="image/*" multiple onchange="handleMultiplePropertyImageUpload('editPropertyImageFile', 'editPropertyImagePreviewContainer')">
                <small class="text-muted">You can select multiple images at once</small>
                
                <!-- Image preview container -->
                <div class="image-preview-container" id="editPropertyImagePreviewContainer">
                  <!-- Preview images will be added here -->
                </div>
              </div>
              
              <!-- Option 2: Add multiple URLs -->
              <div>
                <label class="form-label small">Or add image URLs:</label>
                <div class="image-url-input-group">
                  <input type="text" class="form-control" id="editPropertyImageUrlInput" placeholder="https://example.com/image.jpg">
                  <button type="button" class="btn btn-outline-primary" onclick="addEditPropertyImageUrl()">Add URL</button>
                </div>
                
                <!-- URL list container -->
                <div class="image-url-list" id="editPropertyImageUrlList">
                  <!-- URL items will be added here -->
                </div>
              </div>
              
              <small class="text-muted">You can upload multiple images from your device or provide URLs</small>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="deletePropertyFromEdit()">Delete Property</button>
          <button type="button" class="btn btn-primary" onclick="updateProperty()">Update Property</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Room Management Modal -->
  <div class="modal fade" id="roomManagementModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="roomManagementTitle">Manage Rooms</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 id="propertyRoomsTitle">Rooms for </h6>
            <button class="btn btn-primary btn-sm" onclick="showAddRoomForm()">
              <i class="bi bi-plus-circle me-1"></i>Add Room
            </button>
          </div>
          
          <!-- Add Room Form -->
          <div class="card mb-4" id="addRoomForm" style="display: none;">
            <div class="card-body">
              <h6 class="card-title" id="roomFormTitle">Add New Room</h6>
              <form id="addRoomFormFields">
                <input type="hidden" id="roomPropertyId">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Room Type *</label>
                      <select class="form-select" id="roomType" required>
                        <option value="">Select Room Type</option>
                        <option value="bachelor">Bachelor Room</option>
                        <option value="single">Single Room</option>
                        <option value="ensuite">En-suite Room</option>
                        <option value="sharing">Sharing Room</option>
                        <option value="cottage">Single Cottage</option>
                        <option value="shared-cottage">Shared Cottage</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Room Number/Name</label>
                      <input type="text" class="form-control" id="roomNumber" placeholder="e.g., Room 1, Cottage A">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Monthly Rent (ZAR) *</label>
                      <input type="number" class="form-control" id="roomPrice" required min="0">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Room Size</label>
                      <input type="text" class="form-control" id="roomSize" placeholder="e.g., 15 m²">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Availability *</label>
                      <select class="form-select" id="roomAvailability" required onchange="toggleOccupantInfo()">
                        <option value="true">Available</option>
                        <option value="false">Occupied</option>
                      </select>
                    </div>
                    <div class="mb-3" id="occupantInfo" style="display: none;">
                      <label class="form-label">Occupant Name</label>
                      <input type="text" class="form-control" id="occupantName" placeholder="Current occupant name">
                      <label class="form-label mt-2">Move-in Date</label>
                      <input type="date" class="form-control" id="moveInDate">
                    </div>
                    <!-- Enhanced Room Image Upload - MULTIPLE IMAGES -->
                    <div class="mb-3">
                      <label class="form-label">Room Images</label>
                      
                      <!-- Option 1: Upload multiple files from storage -->
                      <div class="mb-3">
                        <label class="form-label small">Upload from your device:</label>
                        <input type="file" class="form-control" id="roomImageFile" accept="image/*" multiple onchange="handleMultipleRoomImageUpload('roomImageFile', 'roomImagePreviewContainer')">
                        <small class="text-muted">You can select multiple images at once</small>
                        
                        <!-- Image preview container -->
                        <div class="image-preview-container" id="roomImagePreviewContainer">
                          <!-- Preview images will be added here -->
                        </div>
                      </div>
                      
                      <!-- Option 2: Add multiple URLs -->
                      <div>
                        <label class="form-label small">Or add image URLs:</label>
                        <div class="image-url-input-group">
                          <input type="text" class="form-control" id="roomImageUrlInput" placeholder="https://example.com/room-image.jpg">
                          <button type="button" class="btn btn-outline-primary" onclick="addRoomImageUrl()">Add URL</button>
                        </div>
                        
                        <!-- URL list container -->
                        <div class="image-url-list" id="roomImageUrlList">
                          <!-- URL items will be added here -->
                        </div>
                      </div>
                      
                      <small class="text-muted">You can upload multiple images from your device or provide URLs</small>
                    </div>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-12">
                    <div class="mb-3">
                      <label class="form-label">Room Description *</label>
                      <textarea class="form-control" id="roomDescription" rows="3" required placeholder="Describe this room's features, furniture, and special characteristics..."></textarea>
                    </div>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-12">
                    <label class="form-label">Room Features</label>
                    <div class="row">
                      <div class="col-md-3">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" value="single-bed" id="featureSingleBed">
                          <label class="form-check-label">Single Bed</label>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" value="double-bed" id="featureDoubleBed">
                          <label class="form-check-label">Double Bed</label>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" value="desk" id="featureDesk">
                          <label class="form-check-label">Desk</label>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" value="wardrobe" id="featureWardrobe">
                          <label class="form-check-label">Wardrobe</label>
                        </div>
                      </div>
                    </div>
                    <div class="row mt-2">
                      <div class="col-md-3">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" value="private-bathroom" id="featurePrivateBathroom">
                          <label class="form-check-label">Private Bathroom</label>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" value="air-conditioning" id="featureAC">
                          <label class="form-check-label">Air Conditioning</label>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" value="heating" id="featureHeating">
                          <label class="form-check-label">Heating</label>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" value="balcony" id="featureBalcony">
                          <label class="form-check-label">Balcony</label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="mt-3">
                  <button type="button" class="btn btn-primary" onclick="addRoom()" id="roomActionButton">Add Room</button>
                  <button type="button" class="btn btn-secondary" onclick="hideAddRoomForm()">Cancel</button>
                </div>
              </form>
            </div>
          </div>
          
          <!-- Bulk Room Addition -->
          <div class="card mb-4">
            <div class="card-body">
              <h6 class="card-title">Bulk Room Setup</h6>
              <p class="text-muted small">Add multiple rooms of the same type with identical features</p>
              <div class="row">
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">Number of Rooms</label>
                    <input type="number" class="form-control" id="bulkRoomCount" min="1" max="20" value="1">
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">Room Type</label>
                    <select class="form-select" id="bulkRoomType">
                      <option value="single">Single Room</option>
                      <option value="sharing">Sharing Room</option>
                      <option value="ensuite">En-suite Room</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">Price per Room (ZAR)</label>
                    <input type="number" class="form-control" id="bulkRoomPrice" min="0">
                  </div>
                </div>
              </div>
              <button class="btn btn-outline-primary btn-sm" onclick="addBulkRooms()">
                <i class="bi bi-copy me-1"></i>Add Multiple Rooms
              </button>
            </div>
          </div>
          
          <!-- Rooms List -->
          <div id="roomsListContainer">
            <div class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading rooms...</span>
              </div>
              <p class="mt-2 text-muted">Loading rooms...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Bottom Navigation -->
<div class="mobile-bottom-nav d-lg-none">
  <a href="landlord-dashboard.html" class="mobile-nav-item">
    <i class="bi bi-house"></i>
    <span>Dashboard</span>
  </a>
  <a href="manage-properties.html" class="mobile-nav-item active">
    <i class="bi bi-building"></i>
    <span>Properties</span>
  </a>
  <a href="landlord-booking.html" class="mobile-nav-item">
    <i class="bi bi-calendar-check"></i>
    <span>Bookings</span>
  </a>
  <a href="landlord-analytics.html" class="mobile-nav-item">
    <i class="bi bi-bar-chart"></i>
    <span>Analytics</span>
  </a>
  <a href="landlord-help.html" class="mobile-nav-item">
      <i class="bi bi-question-circle"></i>
      <span>Help</span>
    </a>
</div>

  <!-- Enhanced Footer -->
  <footer class="py-4 bg-navy text-white">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 mb-4">
          <h5 class="fw-bold-footer">
            <i class="bi bi-house-heart-fill me-2"></i>ResLinQ
          </h5>
          <p class="text-light">Your trusted platform for managing student accommodation properties efficiently.</p>
        </div>
        <div class="col-lg-2 col-6 mb-4">
          <h6 class="text-light">Property Management</h6>
          <ul class="list-unstyled">
            <li><a href="manage-properties.html" class="text-light text-decoration-none">My Properties</a></li>
            <li><a href="landlord-booking.html" class="text-light text-decoration-none">Bookings</a></li>
            <li><a href="landlord-reports.html" class="text-light text-decoration-none">Reports</a></li>
          </ul>
        </div>
        <div class="col-lg-2 col-6 mb-4">
          <h6 class="text-light">Account</h6>
          <ul class="list-unstyled">
            <li><a href="profile.html" class="text-light text-decoration-none">Profile</a></li>
            <li><a href="landlord-analytics.html" class="text-light text-decoration-none">Analytics</a></li>
            <li><a href="landlord-help.html" class="text-light text-decoration-none">Help</a></li>
          </ul>
        </div>
        <div class="col-lg-4 mb-4">
          <h6 class="text-light">Landlord Support</h6>
          <p class="text-light small">
            <i class="bi bi-envelope me-2"></i>reslinqco@gmail.com<br>
            <i class="bi bi-telephone me-2"></i>+27 65 023 5612<br>
            <i class="bi bi-geo-alt me-2"></i>South Africa<br>
            <i class="bi bi-clock me-2"></i>Mon-Fri: 9AM-5PM
          </p>
        </div>
      </div>
      <hr class="text-light">
      <div class="text-center">
        <p>&copy; 2025 ResLinQ (Pty) Ltd. All rights reserved. | POPIA Compliant | Making student accommodation simple and reliable</p>
        <p class="small mt-2">Registration Number: 2025/826617/07</p>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="navbar.js"></script>
   
  <script>
    // Global variables
    let allProperties = [];
    let filteredProperties = [];
    let currentPropertyRooms = [];
    let currentEditingRoomId = null;

    // Image storage for forms
    let propertyImages = {
        add: {
            files: [],
            urls: []
        },
        edit: {
            files: [],
            urls: []
        }
    };
    
    let roomImages = {
        add: {
            files: [],
            urls: []
        },
        edit: {
            files: [],
            urls: []
        }
    };

    const API_BASE_URL = 'https://linqs-backend.onrender.com/api';

    // Status configuration
    const statusConfig = {
        // Approval statuses (admin-controlled)
        pending: { class: 'warning', text: 'Pending Approval', icon: 'bi-clock' },
        approved: { class: 'success', text: 'Approved', icon: 'bi-check-circle' },
        rejected: { class: 'danger', text: 'Rejected', icon: 'bi-x-circle' },
        
        // Availability statuses (landlord-controlled)
        available: { class: 'success', text: 'Available', icon: 'bi-check-circle' },
        occupied: { class: 'warning', text: 'Occupied', icon: 'bi-person-check' },
        maintenance: { class: 'danger', text: 'Maintenance', icon: 'bi-tools' }
    };

    // Type configuration
    const typeConfig = {
        apartment: { icon: 'bi-building', text: 'Apartment' },
        house: { icon: 'bi-house-door', text: 'House' },
        condo: { icon: 'bi-building', text: 'Condo' },
        townhouse: { icon: 'bi-house', text: 'Townhouse' },
        studio: { icon: 'bi-door-closed', text: 'Studio' }
    };

    // Gender preference configuration
    const genderConfig = {
        unisex: { icon: 'bi-people', text: 'Unisex', class: 'info' },
        male: { icon: 'bi-gender-male', text: 'Male Only', class: 'primary' },
        female: { icon: 'bi-gender-female', text: 'Female Only', class: 'danger' }
    };

    // Accreditation configuration
    const accreditationConfig = {
        accredited: { icon: 'bi-award', text: 'Accredited', class: 'success' },
        self: { icon: 'bi-house', text: 'Self-paying', class: 'info' }
    };

    // Room type configuration
    const roomTypeConfig = {
        bachelor: { icon: 'bi-person', text: 'Bachelor Room', class: 'primary' },
        single: { icon: 'bi-person', text: 'Single Room', class: 'info' },
        ensuite: { icon: 'bi-droplet', text: 'En-suite Room', class: 'success' },
        sharing: { icon: 'bi-people', text: 'Sharing Room', class: 'warning' },
        cottage: { icon: 'bi-house', text: 'Single Cottage', class: 'dark' },
        'shared-cottage': { icon: 'bi-houses', text: 'Shared Cottage', class: 'secondary' }
    };

    // ============ HELPER FUNCTIONS ============

    // Get property status (handles both availability and legacy isAvailable)
    function getPropertyStatus(property) {
        // Use availability field first (landlord-controlled)
        if (property.availability) {
            return property.availability;
        }
        // Fallback to isAvailable for legacy properties
        else if (property.isAvailable !== undefined) {
            return property.isAvailable ? 'available' : 'occupied';
        }
        return 'available'; // default
    }

    // Get amenity icon
    function getAmenityIcon(amenity) {
        const icons = {
            wifi: 'wifi',
            parking: 'car-front',
            laundry: 'droplet',
            furnished: 'house',
            gym: 'activity',
            pool: 'water',
            ac: 'snow',
            heating: 'thermometer-sun',
            shuttle: 'bus-front',
            cctv: 'camera-video'
        };
        return icons[amenity] || 'check';
    }

    // Function to proceed to add property form
// Function to proceed to add property form
// Completely separate the modal triggers - FIXED VERSION
// FIXED: Proper photography modal handling
// FIXED: Proper photography modal handling for ALL add property buttons
document.addEventListener('DOMContentLoaded', function() {
  // Function to handle add property clicks
  function handleAddPropertyClick(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Show photography modal first
    const photographyModal = new bootstrap.Modal(document.getElementById('photographyPromptModal'));
    photographyModal.show();
  }

  // Handle the "Add New Property" button in hero section
  const heroAddBtn = document.querySelector('.hero-actions button');
  if (heroAddBtn) {
    heroAddBtn.addEventListener('click', handleAddPropertyClick);
  }

  // Handle the "Add Your First Property" button in empty state
  const emptyStateBtn = document.querySelector('.empty-state button');
  if (emptyStateBtn) {
    emptyStateBtn.addEventListener('click', handleAddPropertyClick);
  }

  // Also handle any dynamically created empty state buttons
  document.addEventListener('click', function(e) {
    if (e.target.closest('.empty-state button') || 
        (e.target.classList.contains('empty-state') && e.target.tagName === 'BUTTON')) {
      handleAddPropertyClick(e);
    }
  });
});

// FIXED: Proceed to add property function
function proceedToAddProperty() {
  // Close photography modal first
  const photographyModal = bootstrap.Modal.getInstance(document.getElementById('photographyPromptModal'));
  if (photographyModal) {
    photographyModal.hide();
  }
  
  // Wait for modal to fully close, then open add property modal
  setTimeout(() => {
    const addPropertyModal = new bootstrap.Modal(document.getElementById('addPropertyModal'));
    addPropertyModal.show();
  }, 300);
}
    // ============ IMAGE MANAGEMENT FUNCTIONS ============

    // Handle multiple property image file selection
    // Handle multiple property image file selection - FIXED comments
function handleMultiplePropertyImageUpload(inputId, previewContainerId) {
    const fileInput = document.getElementById(inputId);
    const previewContainer = document.getElementById(previewContainerId);
    
    if (fileInput.files && fileInput.files.length > 0) {
        // Determine if this is for add or edit form
        const isEdit = inputId.includes('edit');
        const imageType = isEdit ? 'edit' : 'add';
        
        // Process each file (these will be uploaded to Cloudinary later)
        for (let i = 0; i < fileInput.files.length; i++) {
            const file = fileInput.files[i];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Create preview item (local preview only)
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                previewItem.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <button type="button" class="remove-image" onclick="removeNewPropertyImage('${imageType}', 'file', ${propertyImages[imageType].files.length})">
                        <i class="bi bi-x"></i>
                    </button>
                `;
                
                previewContainer.appendChild(previewItem);
                
                // Store file data for Cloudinary upload
                propertyImages[imageType].files.push({
                    file: file,
                    preview: e.target.result
                });
            };
            
            reader.readAsDataURL(file);
        }
    }
}

    // Handle multiple room image file selection
    function handleMultipleRoomImageUpload(inputId, previewContainerId) {
        const fileInput = document.getElementById(inputId);
        const previewContainer = document.getElementById(previewContainerId);
        
        if (fileInput.files && fileInput.files.length > 0) {
            // Determine if this is for add or edit form
            const isEdit = inputId.includes('edit');
            const imageType = isEdit ? 'edit' : 'add';
            
            // Clear existing previews
            previewContainer.innerHTML = '';
            
            // Process each file
            for (let i = 0; i < fileInput.files.length; i++) {
                const file = fileInput.files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // Create preview item
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" class="remove-image" onclick="removeRoomImage('${imageType}', 'file', ${roomImages[imageType].files.length})">
                            <i class="bi bi-x"></i>
                        </button>
                    `;
                    
                    previewContainer.appendChild(previewItem);
                    
                    // Store file data
                    roomImages[imageType].files.push({
                        file: file,
                        preview: e.target.result
                    });
                };
                
                reader.readAsDataURL(file);
            }
        }
    }

    // Add property image URL
    function addPropertyImageUrl() {
        const urlInput = document.getElementById('propertyImageUrlInput');
        const urlList = document.getElementById('propertyImageUrlList');
        
        if (urlInput.value.trim() !== '') {
            // Add to URL list
            const urlItem = document.createElement('div');
            urlItem.className = 'image-url-item';
            urlItem.innerHTML = `
                <span>${urlInput.value}</span>
                <button type="button" class="remove-url" onclick="removeNewPropertyImage('add', 'url', ${propertyImages.add.urls.length})">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            
            urlList.appendChild(urlItem);
            
            // Store URL
            propertyImages.add.urls.push(urlInput.value);
            
            // Clear input
            urlInput.value = '';
        }
    }

    // Add edit property image URL
    function addEditPropertyImageUrl() {
        const urlInput = document.getElementById('editPropertyImageUrlInput');
        const urlList = document.getElementById('editPropertyImageUrlList');
        
        if (urlInput.value.trim() !== '') {
            // Add to URL list
            const urlItem = document.createElement('div');
            urlItem.className = 'image-url-item';
            urlItem.innerHTML = `
                <span>${urlInput.value}</span>
                <button type="button" class="remove-url" onclick="removeNewPropertyImage('edit', 'url', ${propertyImages.edit.urls.length})">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            
            urlList.appendChild(urlItem);
            
            // Store URL
            propertyImages.edit.urls.push(urlInput.value);
            
            // Clear input
            urlInput.value = '';
        }
    }

    // Add room image URL
    function addRoomImageUrl() {
        const urlInput = document.getElementById('roomImageUrlInput');
        const urlList = document.getElementById('roomImageUrlList');
        
        if (urlInput.value.trim() !== '') {
            // Add to URL list
            const urlItem = document.createElement('div');
            urlItem.className = 'image-url-item';
            urlItem.innerHTML = `
                <span>${urlInput.value}</span>
                <button type="button" class="remove-url" onclick="removeRoomImage('add', 'url', ${roomImages.add.urls.length})">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            
            urlList.appendChild(urlItem);
            
            // Store URL
            roomImages.add.urls.push(urlInput.value);
            
            // Clear input
            urlInput.value = '';
        }
    }

    // Remove new property image (not yet saved)
    function removeNewPropertyImage(type, source, index) {
    if (source === 'file') {
        // Remove from files array
        propertyImages[type].files.splice(index, 1);
        
        // Update preview container
        const containerId = type === 'add' ? 'propertyImagePreviewContainer' : 'editPropertyImagePreviewContainer';
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        // Re-render previews (only new files, not existing images)
        propertyImages[type].files.forEach((fileData, i) => {
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.innerHTML = `
                <img src="${fileData.preview}" alt="Preview">
                <button type="button" class="remove-image" onclick="removeNewPropertyImage('${type}', 'file', ${i})">
                    <i class="bi bi-x"></i>
                </button>
            `;
            container.appendChild(previewItem);
        });
    } else if (source === 'url') {
        // Remove from URLs array
        propertyImages[type].urls.splice(index, 1);
        
        // Update URL list
        const listId = type === 'add' ? 'propertyImageUrlList' : 'editPropertyImageUrlList';
        const list = document.getElementById(listId);
        list.innerHTML = '';
        
        // Re-render URL list
        propertyImages[type].urls.forEach((url, i) => {
            const urlItem = document.createElement('div');
            urlItem.className = 'image-url-item';
            urlItem.innerHTML = `
                <span>${url}</span>
                <button type="button" class="remove-url" onclick="removeNewPropertyImage('${type}', 'url', ${i})">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            list.appendChild(urlItem);
        });
    }
}

   // Improved remove existing property image function
async function removeExistingPropertyImage(propertyId, imageIndex, event = null) {
    // Prevent default if event exists (for click events)
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    try {
        console.log('Attempting to remove property image:', { propertyId, imageIndex });
        
        const token = localStorage.getItem("token");
        if (!token) {
            throw new Error('No authentication token found');
        }

        const property = allProperties.find(p => p._id === propertyId);
        
        if (!property) {
            throw new Error('Property not found in local data');
        }
        
        if (!property.images || property.images.length <= imageIndex) {
            throw new Error('Image not found at specified index');
        }

        // Get the button element properly
        let removeBtn;
        if (event && event.target) {
            removeBtn = event.target.closest('.remove-image') || event.target.closest('.remove-url');
        }
        
        // Show loading state on the button
        if (removeBtn) {
            const originalHTML = removeBtn.innerHTML;
            removeBtn.innerHTML = '<span class="loading-spinner"></span>';
            removeBtn.disabled = true;
        }

        // Remove the image from the property's images array
        const updatedImages = [...property.images];
        const removedImage = updatedImages.splice(imageIndex, 1);
        console.log('Image removed locally:', removedImage[0]);
        console.log('Updated images array:', updatedImages);
        
        // Create a complete update object with all required fields
        const updateData = {
            title: property.title,
            description: property.description,
            price: property.price,
            location: property.location,
            propertyType: property.propertyType,
            bedrooms: property.bedrooms,
            bathrooms: property.bathrooms,
            amenities: property.amenities || [],
            genderPreference: property.genderPreference,
            accreditation: property.accreditation,
            availability: property.availability,
            images: updatedImages
        };

        console.log('Sending update request to server with data:', updateData);
        
        // Update the property on the server
        const response = await fetch(`${API_BASE_URL}/properties/${propertyId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        });

        console.log('Server response status:', response.status);
        
        if (!response.ok) {
            let errorMessage = `Server returned ${response.status}`;
            try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorData.message || errorMessage;
                console.error('Server error details:', errorData);
            } catch (e) {
                // If response is not JSON, get text instead
                const text = await response.text();
                errorMessage = text || errorMessage;
            }
            throw new Error(`Failed to remove image: ${errorMessage}`);
        }

        const result = await response.json();
        console.log('Update successful:', result);

        // Update local data
        property.images = updatedImages;
        
        // Update the propertyImages.edit.urls array to match the updated images
        propertyImages.edit.urls = [...updatedImages];
        
        console.log('Image removal successful, updating UI...');
        
        // Show success message
        showToast('Image removed successfully!', 'success');
        
        // Close the current edit modal first
        const editModal = bootstrap.Modal.getInstance(document.getElementById('editPropertyModal'));
        if (editModal) {
            editModal.hide();
        }
        
        // Wait for modal to close, then reopen with updated data
        setTimeout(() => {
            editProperty(propertyId);
        }, 500);
        
    } catch (error) {
        console.error('Error removing image:', error);
        
        // More detailed error logging
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            console.error('Network error - check API URL and connectivity');
            showToast('Network error: Could not connect to server', 'error');
        } else {
            showToast('Failed to remove image: ' + error.message, 'error');
        }
        
        // Restore button state
        const removeBtn = event ? (event.target.closest('.remove-image') || event.target.closest('.remove-url')) : null;
        if (removeBtn) {
            removeBtn.innerHTML = '<i class="bi bi-x"></i>';
            removeBtn.disabled = false;
        }
    }
}

// Remove existing room image with proper state management
async function removeExistingRoomImage(propertyId, roomId, imageIndex) {
    try {
        const token = localStorage.getItem("token");
        const room = currentPropertyRooms.find(r => r._id === roomId);
        
        if (!room || !room.images || room.images.length <= imageIndex) {
            alert('Image not found!');
            return;
        }

        // Show loading state on the button
        const removeBtn = event.target.closest('.remove-image');
        const originalHTML = removeBtn.innerHTML;
        removeBtn.innerHTML = '<span class="loading-spinner"></span>';
        removeBtn.disabled = true;

        // Remove the image from the room's images array
        const updatedImages = [...room.images];
        updatedImages.splice(imageIndex, 1);
        
        // Update the room on the server
        const response = await fetch(`${API_BASE_URL}/properties/${propertyId}/rooms/${roomId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                images: updatedImages
            })
        });

        if (!response.ok) {
            throw new Error('Failed to remove image');
        }

        // Update local data
        room.images = updatedImages;
        
        // Update the roomImages.add.urls array to match the updated images
        roomImages.add.urls = [...updatedImages];
        
        // Show success message
        showToast('Image removed successfully!', 'success');
        
        // Refresh the edit form to show updated images
        setTimeout(() => {
            editExistingRoom(roomId);
        }, 500);
        
    } catch (error) {
        console.error('Error removing room image:', error);
        showToast('Failed to remove image: ' + error.message, 'error');
        // Restore button state
        const removeBtn = event.target.closest('.remove-image');
        removeBtn.innerHTML = '<i class="bi bi-x"></i>';
        removeBtn.disabled = false;
    }
}

// Toast notification function
function showToast(message, type = 'info') {
    // Remove existing toasts
    const existingToasts = document.querySelectorAll('.custom-toast');
    existingToasts.forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = `custom-toast position-fixed ${type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info'} text-white p-3 rounded shadow`;
    toast.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 250px;
        animation: slideInRight 0.3s ease-out;
    `;
    
    toast.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <span>${message}</span>
            <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 3000);
}

// Add CSS for toast animation
const toastStyles = document.createElement('style');
toastStyles.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .loading-spinner {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid #ffffff;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
`;
document.head.appendChild(toastStyles);

    // Remove room image
    function removeRoomImage(type, source, index) {
    if (source === 'file') {
        // Remove from files array
        roomImages[type].files.splice(index, 1);
        
        // Update preview container
        const containerId = type === 'add' ? 'roomImagePreviewContainer' : 'editRoomImagePreviewContainer';
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        // Re-render previews
        roomImages[type].files.forEach((fileData, i) => {
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.innerHTML = `
                <img src="${fileData.preview}" alt="Preview">
                <button type="button" class="remove-image" onclick="removeRoomImage('${type}', 'file', ${i})">
                    <i class="bi bi-x"></i>
                </button>
            `;
            container.appendChild(previewItem);
        });
    } else if (source === 'url') {
        // Remove from URLs array
        roomImages[type].urls.splice(index, 1);
        
        // Update URL list
        const listId = type === 'add' ? 'roomImageUrlList' : 'editRoomImageUrlList';
        const list = document.getElementById(listId);
        list.innerHTML = '';
        
        // Re-render URL list
        roomImages[type].urls.forEach((url, i) => {
            const urlItem = document.createElement('div');
            urlItem.className = 'image-url-item';
            urlItem.innerHTML = `
                <span>${url}</span>
                <button type="button" class="remove-url" onclick="removeRoomImage('${type}', 'url', ${i})">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            list.appendChild(urlItem);
        });
    }
}

    // Reset image data when modals are closed
    function resetPropertyImageData() {
        propertyImages.add.files = [];
        propertyImages.add.urls = [];
        propertyImages.edit.files = [];
        propertyImages.edit.urls = [];
        
        // Clear preview containers
        document.getElementById('propertyImagePreviewContainer').innerHTML = '';
        document.getElementById('editPropertyImagePreviewContainer').innerHTML = '';
        document.getElementById('propertyImageUrlList').innerHTML = '';
        document.getElementById('editPropertyImageUrlList').innerHTML = '';
        
        // Clear URL inputs
        document.getElementById('propertyImageUrlInput').value = '';
        document.getElementById('editPropertyImageUrlInput').value = '';
    }

    function resetRoomImageData() {
        roomImages.add.files = [];
        roomImages.add.urls = [];
        roomImages.edit.files = [];
        roomImages.edit.urls = [];
        
        // Clear preview containers
        document.getElementById('roomImagePreviewContainer').innerHTML = '';
        document.getElementById('roomImageUrlList').innerHTML = '';
        
        // Clear URL inputs
        document.getElementById('roomImageUrlInput').value = '';
    }

    // ============ PROPERTY MANAGEMENT FUNCTIONS ============

    // Load properties from backend
    async function loadProperties() {
        try {
            showLoadingState();
            
            const token = localStorage.getItem("token");
            if (!token) {
                throw new Error('No authentication token found');
            }

            const response = await fetch(`${API_BASE_URL}/properties/user/my-properties`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`Failed to fetch properties: ${response.status}`);
            }

            const data = await response.json();
            allProperties = data.properties || [];
            filteredProperties = [...allProperties];

            hideLoadingState();
            renderFilteredProperties();
            
        } catch (error) {
            console.error('Error loading properties:', error);
            hideLoadingState();
            showEmptyState();
            alert('Failed to load properties: ' + error.message);
        }
    }

    // ============ ADD NEW PROPERTY ============
async function addNewProperty() {
    const form = document.getElementById('addPropertyForm');
    const addBtn = document.getElementById('addPropertyBtn');
    
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }

    try {
        addBtn.disabled = true;
        addBtn.innerHTML = '<span class="loading-spinner"></span> Adding Property...';

        const token = localStorage.getItem("token");
        if (!token) throw new Error('No authentication token found');

        const formData = new FormData(form);
        const amenities = formData.getAll('amenities');
        
        const propertyData = {
            title: formData.get('title'),
            description: formData.get('description'),
            price: parseInt(formData.get('price')),
            location: {
                address: formData.get('address'),
                city: formData.get('city'),
                state: formData.get('state'),
                zipCode: formData.get('zipCode')
            },
            propertyType: formData.get('propertyType'),
            bedrooms: parseInt(formData.get('bedrooms')),
            bathrooms: parseInt(formData.get('bathrooms')),
            amenities: amenities,
            genderPreference: formData.get('genderPreference'),
            accreditation: formData.get('accreditation'),
            availability: formData.get('availability'),
            contactInfo: {
                phone: JSON.parse(localStorage.getItem("user")).phone || '',
                email: JSON.parse(localStorage.getItem("user")).email || ''
            },
            images: [] // Start with empty array
        };

        // ✅ FIXED: Upload all images to Cloudinary first
        const filesToUpload = propertyImages.add.files.map(fileData => fileData.file);
        
        if (filesToUpload.length > 0) {
            const uploadedUrls = await uploadMultipleToCloudinary(filesToUpload);
            propertyData.images.push(...uploadedUrls);
        }
        
        // Add URL images (these are already external URLs)
        propertyData.images.push(...propertyImages.add.urls);

        console.log('Creating property with images:', propertyData.images);

        const response = await fetch(`${API_BASE_URL}/properties`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(propertyData)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to create property');
        }

        alert('Property added successfully!');
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('addPropertyModal'));
        modal.hide();
        
        form.reset();
        form.classList.remove('was-validated');
        resetPropertyImageData();
        
        await loadProperties();
        
    } catch (error) {
        console.error('Error adding property:', error);
        alert('Failed to add property: ' + error.message);
    } finally {
        addBtn.disabled = false;
        addBtn.innerHTML = '<i class="bi bi-plus-circle me-2"></i>Add Property';
    }
}

// ============ UPDATE PROPERTY ============
async function updateProperty() {
    const propertyId = document.getElementById('editPropertyId').value;
    const property = allProperties.find(p => p._id === propertyId);
    
    if (!property) {
        alert('Property not found!');
        return;
    }

    try {
        const token = localStorage.getItem("token");
        if (!token) {
            throw new Error('No authentication token found');
        }

        // Get existing images from the property (these are the ones that remain after deletions)
        const existingImages = propertyImages.edit.urls;
        
        // Upload new files to Cloudinary
        const filesToUpload = propertyImages.edit.files.map(fileData => fileData.file);
        const newUploadedUrls = await uploadMultipleToCloudinary(filesToUpload);
        
        // Combine kept URLs with newly uploaded URLs
        const allImages = [
            ...existingImages,     // URLs user kept from existing images (after any deletions)
            ...newUploadedUrls    // Newly uploaded images
        ];

        console.log('Image update summary:', {
            existing: property.images ? property.images.length : 0,
            kept: existingImages.length,
            new: newUploadedUrls.length,
            final: allImages.length
        });

        const updatedData = {
            title: document.getElementById('editPropertyTitle').value,
            description: document.getElementById('editPropertyDescription').value,
            price: parseInt(document.getElementById('editPropertyPrice').value),
            location: {
                address: document.getElementById('editPropertyAddress').value,
                city: document.getElementById('editPropertyCity').value,
                state: document.getElementById('editPropertyState').value,
                zipCode: document.getElementById('editPropertyZipCode').value
            },
            propertyType: document.getElementById('editPropertyType').value,
            bedrooms: parseInt(document.getElementById('editPropertyBedrooms').value),
            bathrooms: parseInt(document.getElementById('editPropertyBathrooms').value),
            amenities: getSelectedEditAmenities(),
            genderPreference: document.getElementById('editPropertyGenderPreference').value,
            accreditation: document.getElementById('editPropertyAccreditation').value,
            availability: document.getElementById('editPropertyAvailability').value,
            images: allImages
        };

        const response = await fetch(`${API_BASE_URL}/properties/${propertyId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedData)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to update property');
        }

        const result = await response.json();
        console.log('Update successful:', result);
        
        alert('Property updated successfully!');
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('editPropertyModal'));
        modal.hide();
        
        // Reset image data
        resetPropertyImageData();
        
        // Reload properties
        await loadProperties();
        
    } catch (error) {
        console.error('Error updating property:', error);
        alert('Failed to update property: ' + error.message);
    }
}

    // ✅ CORRECT - Upload to Cloudinary and get URL
// ✅ IMPROVED: Upload to Cloudinary with better error handling
async function uploadToCloudinary(file) {
    try {
        const formData = new FormData();
        formData.append('image', file);

        const response = await fetch(`${API_BASE_URL}/upload`, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Upload failed: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        
        if (!result.url) {
            throw new Error('No URL returned from Cloudinary upload');
        }
        
        console.log('Cloudinary upload successful:', result.url);
        return result.url;
    } catch (error) {
        console.error('Cloudinary upload error:', error);
        throw new Error(`Failed to upload image: ${error.message}`);
    }
}

// ✅ IMPROVED: Batch upload multiple images with error handling
async function uploadMultipleToCloudinary(files) {
    const uploadedUrls = [];
    
    for (const file of files) {
        try {
            const cloudinaryUrl = await uploadToCloudinary(file);
            uploadedUrls.push(cloudinaryUrl);
        } catch (error) {
            console.error('Failed to upload image, skipping:', file.name, error);
            // Continue with other images even if one fails
        }
    }
    
    return uploadedUrls;
}

    // ============ PROPERTY DISPLAY FUNCTIONS ============

    // Generate property card for grid view
    function generatePropertyCard(property) {
        const approvalStatus = property.status || 'pending';
        const availabilityStatus = property.availability || 'available';
        
        const approvalInfo = statusConfig[approvalStatus] || statusConfig.pending;
        const availabilityInfo = statusConfig[availabilityStatus] || statusConfig.available;
        
        const type = typeConfig[property.propertyType] || typeConfig.apartment;
        const gender = genderConfig[property.genderPreference] || genderConfig.unisex;
        const accreditation = accreditationConfig[property.accreditation] || accreditationConfig.self;
        const imageUrl = property.images && property.images.length > 0 ? property.images[0] : 'https://via.placeholder.com/400x250/007bff/ffffff?text=Property+Image';
        
        return `
            <div class="property-card ${availabilityStatus}">
                <img src="${imageUrl}" class="property-image" alt="${property.title}">
                <div class="card-body p-3">
                    <!-- Approval Status (Admin) -->
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="badge bg-${approvalInfo.class} status-badge">
                            <i class="${approvalInfo.icon} me-1"></i>${approvalInfo.text}
                        </span>
                        <span class="badge bg-${gender.class} status-badge">
                            <i class="${gender.icon} me-1"></i>${gender.text}
                        </span>
                    </div>
                    
                    <!-- Availability Status (Landlord) -->
                    <div class="mb-2">
                        <span class="badge bg-${availabilityInfo.class} status-badge">
                            <i class="${availabilityInfo.icon} me-1"></i>${availabilityInfo.text}
                        </span>
                    </div>
                    
                    <h6 class="card-title text-navy text-truncate">${property.title}</h6>
                    <p class="text-muted small mb-2 text-truncate">
                        <i class="bi bi-geo-alt me-1"></i>${property.location.address}, ${property.location.city}
                    </p>
                    <p class="text-muted small mb-2">
                        <i class="bi bi-door-closed me-1"></i>${property.bedrooms} beds • ${property.bathrooms} baths
                    </p>
                    
                    <div class="mb-2">
                        <span class="badge bg-${accreditation.class} status-badge">
                            <i class="${accreditation.icon} me-1"></i>${accreditation.text}
                        </span>
                    </div>
                    
                    ${property.adminNotes && approvalStatus === 'rejected' ? `
                        <div class="alert alert-danger small p-2 mb-2">
                            <strong>Admin Note:</strong> ${property.adminNotes}
                        </div>
                    ` : ''}
                    
                    ${approvalStatus === 'pending' ? `
                        <div class="alert alert-warning small p-2 mb-2">
                            <i class="bi bi-info-circle me-1"></i>Waiting for admin approval
                        </div>
                    ` : ''}
                    
                    <div class="mb-2">
                        ${(property.amenities || []).slice(0, 3).map(amenity => `
                            <span class="feature-badge d-inline-block">
                                <i class="bi bi-${getAmenityIcon(amenity)} me-1"></i>${amenity}
                            </span>
                        `).join('')}
                        ${(property.amenities || []).length > 3 ? `<span class="feature-badge">+${(property.amenities || []).length - 3}</span>` : ''}
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-navy mb-0">R${property.price || 0}</h6>
                        <small class="text-muted">/month</small>
                    </div>
                    
                    <div class="d-flex justify-content-between small text-muted">
                        <span>
                            <i class="bi bi-calendar-check me-1"></i>${property.reviewCount || 0} reviews
                        </span>
                        <span>
                            Added: ${property.createdAt ? new Date(property.createdAt).toLocaleDateString() : 'Unknown'}
                        </span>
                    </div>
                </div>
                
                <div class="card-footer bg-transparent p-2">
                    <div class="action-buttons d-flex justify-content-between">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewPropertyDetails('${property._id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editProperty('${property._id}')" 
                            ${approvalStatus !== 'approved' ? 'disabled title="Edit after approval"' : ''}>
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewPropertyStats('${property._id}')">
                            <i class="bi bi-graph-up"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="manageRooms('${property._id}')" 
                            ${approvalStatus !== 'approved' ? 'disabled title="Add rooms after approval"' : ''}>
                            <i class="bi bi-door-closed"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProperty('${property._id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Generate table row for list view
    function generatePropertyRow(property) {
        const status = getPropertyStatus(property);
        const statusInfo = statusConfig[status] || statusConfig.available;
        const type = typeConfig[property.propertyType] || typeConfig.apartment;
        const gender = genderConfig[property.genderPreference] || genderConfig.unisex;
        const accreditation = accreditationConfig[property.accreditation] || accreditationConfig.self;
        const imageUrl = property.images && property.images.length > 0 ? property.images[0] : 'https://via.placeholder.com/400x250/007bff/ffffff?text=Property+Image';
        
        return `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <img src="${imageUrl}" class="rounded me-2" width="40" height="40" alt="${property.title}">
                        <div>
                            <div class="fw-bold small">${property.title}</div>
                            <small class="text-muted">${type.text}</small>
                        </div>
                    </div>
                </td>
                <td class="small">${property.location.city}</td>
                <td class="small">${type.text}</td>
                <td class="small">R${property.price || 0}</td>
                <td>
                    <span class="badge bg-${statusInfo.class} small">
                        <i class="${statusInfo.icon} me-1"></i>${statusInfo.text}
                    </span>
                </td>
                <td>
                    <span class="badge bg-${gender.class} small">
                        <i class="${gender.icon} me-1"></i>${gender.text}
                    </span>
                </td>
                <td>
                    <span class="badge bg-${accreditation.class} small">
                        <i class="${accreditation.icon} me-1"></i>${accreditation.text}
                    </span>
                </td>
                <td>
                    <div class="action-buttons d-flex gap-1">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewPropertyDetails('${property._id}')" title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editProperty('${property._id}')" title="Edit Property">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewPropertyStats('${property._id}')" title="View Stats">
                            <i class="bi bi-graph-up"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="manageRooms('${property._id}')" title="Manage Rooms">
                            <i class="bi bi-door-closed"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProperty('${property._id}')" title="Delete Property">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }

    // Filter properties function
    function filterProperties() {
        const statusFilter = document.getElementById('statusFilter').value;
        const typeFilter = document.getElementById('typeFilter').value;
        const locationFilter = document.getElementById('locationFilter').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        filteredProperties = allProperties.filter(property => {
            // Status filter - use availability field
            if (statusFilter) {
                const propertyStatus = property.availability || (property.isAvailable ? 'available' : 'occupied');
                if (propertyStatus !== statusFilter) return false;
            }
            
            // Type filter
            if (typeFilter && property.propertyType !== typeFilter) return false;
            
            // Location filter
            if (locationFilter && property.location.city.toLowerCase() !== locationFilter.toLowerCase()) return false;
            
            // Search term filter
            if (searchTerm) {
                const searchFields = [
                    property.title,
                    property.description,
                    property.location.address,
                    property.location.city
                ];
                const matchesSearch = searchFields.some(field => 
                    field && field.toLowerCase().includes(searchTerm)
                );
                if (!matchesSearch) return false;
            }
            
            return true;
        });
        
        renderFilteredProperties();
    }

    // Calculate monthly revenue based on occupied rooms
    async function calculateMonthlyRevenue() {
        try {
            const token = localStorage.getItem("token");
            if (!token) {
                throw new Error('No authentication token found');
            }

            let totalRevenue = 0;

            // Loop through all filtered properties and calculate revenue from occupied rooms
            for (const property of filteredProperties) {
                try {
                    // Fetch rooms for this property
                    const response = await fetch(`${API_BASE_URL}/properties/${property._id}/rooms`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const rooms = data.rooms || [];
                        
                        // Sum up revenue from occupied rooms only
                        const propertyRevenue = rooms
                            .filter(room => !room.isAvailable)
                            .reduce((sum, room) => sum + (room.price || 0), 0);
                        
                        totalRevenue += propertyRevenue;
                    }
                } catch (error) {
                    console.error(`Error fetching rooms for property ${property._id}:`, error);
                    // Continue with other properties even if one fails
                }
            }

            return totalRevenue;
        } catch (error) {
            console.error('Error calculating monthly revenue:', error);
            throw error;
        }
    }

    // Render filtered properties
    function renderFilteredProperties() {
        // Update stats using helper function
        document.getElementById('totalProperties').textContent = filteredProperties.length;
        document.getElementById('availableProperties').textContent = filteredProperties.filter(p => getPropertyStatus(p) === 'available').length;
        document.getElementById('occupiedProperties').textContent = filteredProperties.filter(p => getPropertyStatus(p) === 'occupied').length;
        document.getElementById('maintenanceProperties').textContent = filteredProperties.filter(p => getPropertyStatus(p) === 'maintenance').length;
        
        // Fetch actual bookings count
        fetchActualBookingsCount().then(bookingsCount => {
            document.getElementById('activeBookings').textContent = bookingsCount;
        }).catch(() => {
            document.getElementById('activeBookings').textContent = filteredProperties.filter(p => p.hasBookings).length || 0;
        });
        
        // Calculate monthly revenue based on occupied rooms
        calculateMonthlyRevenue().then(monthlyRevenue => {
            document.getElementById('totalEarnings').textContent = monthlyRevenue;
        }).catch(() => {
            // Fallback to property-based calculation if room-based fails
            document.getElementById('totalEarnings').textContent = filteredProperties.reduce((sum, p) => sum + p.price, 0);
        });

        // Show empty state if no properties
        if (filteredProperties.length === 0) {
            showEmptyState();
            return;
        } else {
            hideEmptyState();
        }

        // Render properties
        const gridView = document.getElementById('propertiesGridView');
        const tableView = document.getElementById('propertiesTable');
        
        if (gridView) {
            gridView.innerHTML = filteredProperties.map(property => generatePropertyCard(property)).join('');
        }
        
        if (tableView) {
            tableView.innerHTML = filteredProperties.map(property => generatePropertyRow(property)).join('');
        }

        // AUTO-SHOW GRID VIEW
        document.getElementById('gridView').checked = true;
        document.getElementById('propertiesGridView').style.display = 'grid';
        document.getElementById('propertiesListView').style.display = 'none';
    }

    // Function to fetch actual bookings count
    async function fetchActualBookingsCount() {
        try {
            const token = localStorage.getItem("token");
            const response = await fetch(`${API_BASE_URL}/bookings/my-bookings`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                return data.bookings ? data.bookings.length : 0;
            }
            return 0;
        } catch (error) {
            console.error('Error fetching bookings:', error);
            return 0;
        }
    }

    
// View property details - FIXED with proper modal timing
function viewPropertyDetails(propertyId) {
    const property = allProperties.find(p => p._id === propertyId);
    if (property) {
        // Get the AVAILABILITY status (landlord-controlled), not approval status
        const availabilityStatus = property.availability || 'available';
        const availabilityInfo = statusConfig[availabilityStatus] || statusConfig.available;
        
        const type = typeConfig[property.propertyType] || typeConfig.apartment;
        const gender = genderConfig[property.genderPreference] || genderConfig.unisex;
        const accreditation = accreditationConfig[property.accreditation] || accreditationConfig.self;
        const imageUrl = property.images && property.images.length > 0 ? property.images[0] : 'https://via.placeholder.com/400x250/007bff/ffffff?text=Property+Image';
        
        // Create image carousel if multiple images exist
        let imagesHtml = '';
        if (property.images && property.images.length > 1) {
            imagesHtml = `
                <div id="propertyCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-indicators">
                        ${property.images.map((_, index) => `
                            <button type="button" data-bs-target="#propertyCarousel" data-bs-slide-to="${index}" ${index === 0 ? 'class="active" aria-current="true"' : ''} aria-label="Slide ${index + 1}"></button>
                        `).join('')}
                    </div>
                    <div class="carousel-inner">
                        ${property.images.map((image, index) => `
                            <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                <img src="${image}" class="d-block w-100" style="height: 300px; object-fit: cover;" alt="${property.title} - Image ${index + 1}">
                            </div>
                        `).join('')}
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            `;
        } else {
            imagesHtml = `<img src="${imageUrl}" class="img-fluid rounded" alt="${property.title}">`;
        }
        
        // AVAILABILITY Status Section - FIXED: Now shows Availability with correct colors
        const availabilitySection = `
            <div class="row mt-3">
                <div class="col-12">
                    <div class="card ${availabilityStatus === 'available' ? 'border-success' : availabilityStatus === 'occupied' ? 'border-warning' : 'border-danger'}">
                        <div class="card-header bg-${availabilityInfo.class} text-white">
                            <h6 class="mb-0">
                                <i class="bi ${availabilityInfo.icon} me-2"></i>Availability: ${availabilityInfo.text}
                            </h6>
                        </div>
                        <div class="card-body">
                            ${availabilityStatus === 'available' ? `
                                <p class="mb-2"><i class="bi bi-check-circle me-2"></i>This property is currently available for new tenants.</p>
                                <small class="text-muted">Students can book this property immediately.</small>
                            ` : availabilityStatus === 'occupied' ? `
                                <p class="mb-2"><i class="bi bi-person-check me-2"></i>This property is currently occupied.</p>
                                <small class="text-muted">No new bookings can be accepted until it becomes available.</small>
                            ` : availabilityStatus === 'maintenance' ? `
                                <p class="mb-2"><i class="bi bi-tools me-2"></i>This property is under maintenance.</p>
                                <small class="text-muted">The property is temporarily unavailable for bookings.</small>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const modalContent = `
            <div class="row">
                <div class="col-md-6">
                    ${imagesHtml}
                </div>
                <div class="col-md-6">
                    <h5>${property.title}</h5>
                    <p class="text-muted small">${property.location.address}, ${property.location.city}, ${property.location.state}</p>
                    
                    <div class="mb-3">
                        <span class="badge bg-${availabilityInfo.class} me-2">
                            <i class="${availabilityInfo.icon} me-1"></i>${availabilityInfo.text}
                        </span>
                        <span class="badge bg-${gender.class} me-2">
                            <i class="${gender.icon} me-1"></i>${gender.text}
                        </span>
                        <span class="badge bg-${accreditation.class} me-2">
                            <i class="${accreditation.icon} me-1"></i>${accreditation.text}
                        </span>
                        <span class="badge bg-light text-dark">${type.text}</span>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong class="small">Monthly Rent:</strong><br>
                            <h6 class="text-navy">R${property.price}</h6>
                        </div>
                        <div class="col-6">
                            <strong class="small">Rooms:</strong><br>
                            <h6>${property.bedrooms} beds • ${property.bathrooms} baths</h6>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <strong class="small">Amenities:</strong><br>
                        ${property.amenities && property.amenities.length > 0 ? 
                            property.amenities.map(amenity => `
                                <span class="badge bg-light text-dark me-1 small">
                                    <i class="bi bi-${getAmenityIcon(amenity)}"></i> ${amenity}
                                </span>
                            `).join('') : 
                            '<span class="text-muted small">No amenities specified</span>'
                        }
                    </div>
                </div>
            </div>
            
            ${availabilitySection}
            
            <div class="row mt-3">
                <div class="col-12">
                    <strong class="small">Description:</strong>
                    <p class="small">${property.description || 'No description provided.'}</p>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-6">
                    <strong class="small">Reviews:</strong> ${property.reviewCount || 0}
                </div>
                <div class="col-6">
                    <strong class="small">Rating:</strong> ${property.averageRating ? property.averageRating.toFixed(1) + ' ★' : 'No ratings yet'}
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-navy btn-sm" id="editFromDetailsBtn" data-property-id="${property._id}">
                            <i class="bi bi-pencil me-1"></i>Edit Property
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('propertyDetailsContent').innerHTML = modalContent;
        
        // Add event listener for the edit button
        setTimeout(() => {
            const editBtn = document.getElementById('editFromDetailsBtn');
            if (editBtn) {
                editBtn.addEventListener('click', function() {
                    const propertyId = this.getAttribute('data-property-id');
                    closeDetailsAndOpenEdit(propertyId);
                });
            }
        }, 100);
        
        const detailsModal = new bootstrap.Modal(document.getElementById('propertyDetailsModal'));
        detailsModal.show();
    }
}

// Helper function to close details and open edit with proper timing
function closeDetailsAndOpenEdit(propertyId) {
    const detailsModal = bootstrap.Modal.getInstance(document.getElementById('propertyDetailsModal'));
    if (detailsModal) {
        detailsModal.hide();
    }
    
    // Wait for modal to fully close before opening edit
    setTimeout(() => {
        editProperty(propertyId);
    }, 400);
}
    
    // Edit property - FIXED to handle Cloudinary URLs properly
// Edit property - IMPROVED to track image changes
function editProperty(propertyId) {
    console.log('Edit button clicked for property:', propertyId);
    const property = allProperties.find(p => p._id === propertyId);
    console.log('Found property:', property);
    
    if (property) {
        // Populate form with current property data
        document.getElementById('editPropertyId').value = property._id;
        document.getElementById('editPropertyTitle').value = property.title;
        document.getElementById('editPropertyType').value = property.propertyType;
        document.getElementById('editPropertyPrice').value = property.price;
        document.getElementById('editPropertyAddress').value = property.location.address;
        document.getElementById('editPropertyCity').value = property.location.city;
        document.getElementById('editPropertyState').value = property.location.state;
        document.getElementById('editPropertyZipCode').value = property.location.zipCode;
        
        document.getElementById('editPropertyBedrooms').value = property.bedrooms;
        document.getElementById('editPropertyBathrooms').value = property.bathrooms;
        
        document.getElementById('editPropertyDescription').value = property.description;
        document.getElementById('editPropertyGenderPreference').value = property.genderPreference || 'unisex';
        document.getElementById('editPropertyAccreditation').value = property.accreditation || 'self';
        
        // Use availability field (landlord-controlled)
        document.getElementById('editPropertyAvailability').value = property.availability || 'available';
        
        // Reset image data first
        propertyImages.edit.files = [];
        propertyImages.edit.urls = [];
        
        // Clear preview containers
        document.getElementById('editPropertyImagePreviewContainer').innerHTML = '';
        document.getElementById('editPropertyImageUrlList').innerHTML = '';
        
        // Handle existing images - initialize URLs with existing images
        if (property.images && property.images.length > 0) {
            // Store existing Cloudinary URLs as the base URLs to keep
            propertyImages.edit.urls = [...property.images];
            
            // Render URL list and previews for existing Cloudinary images
            const urlList = document.getElementById('editPropertyImageUrlList');
            const previewContainer = document.getElementById('editPropertyImagePreviewContainer');
            
            property.images.forEach((url, i) => {
                // Add to URL list (these are the images user starts with)
                const urlItem = document.createElement('div');
                urlItem.className = 'image-url-item';
                urlItem.innerHTML = `
                    <span>${url}</span>
                    <button type="button" class="remove-url" onclick="removeExistingPropertyImage('${propertyId}', ${i}, event)">
                        <i class="bi bi-trash"></i>
                    </button>
                `;
                urlList.appendChild(urlItem);
                
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                previewItem.innerHTML = `
                    <img src="${url}" alt="Existing image">
                    <button type="button" class="remove-image" onclick="removeExistingPropertyImage('${propertyId}', ${i}, event)">
                        <i class="bi bi-x"></i>
                    </button>
                `;
                previewContainer.appendChild(previewItem);
            });
        }

        // Set amenities checkboxes
        const amenities = property.amenities || [];
        document.getElementById('editAmenityWifi').checked = amenities.includes('wifi');
        document.getElementById('editAmenityParking').checked = amenities.includes('parking');
        document.getElementById('editAmenityLaundry').checked = amenities.includes('laundry');
        document.getElementById('editAmenityFurnished').checked = amenities.includes('furnished');
        document.getElementById('editAmenityGym').checked = amenities.includes('gym');
        document.getElementById('editAmenityPool').checked = amenities.includes('pool');
        document.getElementById('editAmenityAC').checked = amenities.includes('ac');
        document.getElementById('editAmenityHeating').checked = amenities.includes('heating');
        document.getElementById("editAmenityShuttle").checked = amenities.includes("shuttle");
        document.getElementById("editAmenityCCTV").checked = amenities.includes("cctv");

        console.log('Opening edit modal for property:', property.title);
        // Show the modal
        new bootstrap.Modal(document.getElementById('editPropertyModal')).show();
    } else {
        console.error('Property not found with ID:', propertyId);
        alert('Property not found!');
    }
}
    // Delete property
    async function deleteProperty(propertyId) {
        const property = allProperties.find(p => p._id === propertyId);
        
        if (property && confirm(`Are you sure you want to delete "${property.title}"? This action cannot be undone.`)) {
            try {
                const token = localStorage.getItem("token");
                if (!token) {
                    throw new Error('No authentication token found');
                }

                const response = await fetch(`${API_BASE_URL}/properties/${propertyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to delete property');
                }

                alert('Property deleted successfully');
                await loadProperties();
                
            } catch (error) {
                console.error('Error deleting property:', error);
                alert('Failed to delete property: ' + error.message);
            }
        }
    }

    // Delete property from edit modal
    async function deletePropertyFromEdit() {
        const propertyId = document.getElementById('editPropertyId').value;
        const property = allProperties.find(p => p._id === propertyId);
        
        if (property && confirm(`Are you sure you want to delete "${property.title}"? This action cannot be undone.`)) {
            try {
                const token = localStorage.getItem("token");
                if (!token) {
                    throw new Error('No authentication token found');
                }

                const response = await fetch(`${API_BASE_URL}/properties/${propertyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to delete property');
                }

                alert('Property deleted successfully');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editPropertyModal'));
                modal.hide();
                
                // Reload properties
                await loadProperties();
                
            } catch (error) {
                console.error('Error deleting property:', error);
                alert('Failed to delete property: ' + error.message);
            }
        }
    }

    // Enhanced View property statistics with better modal management
async function viewPropertyStats(propertyId) {
    const property = allProperties.find(p => p._id === propertyId);
    if (!property) {
        alert('Property not found!');
        return;
    }

    try {
        const token = localStorage.getItem("token");
        
        // Fetch rooms for this property
        const roomsResponse = await fetch(`${API_BASE_URL}/properties/${propertyId}/rooms`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!roomsResponse.ok) {
            throw new Error('Failed to fetch room data');
        }

        const roomsData = await roomsResponse.json();
        const rooms = roomsData.rooms || [];

        // Calculate statistics (your existing stats calculation code)
        const totalRooms = rooms.length;
        const availableRooms = rooms.filter(room => room.isAvailable).length;
        const occupiedRooms = rooms.filter(room => !room.isAvailable).length;
        const occupancyRate = totalRooms > 0 ? (occupiedRooms / totalRooms) * 100 : 0;
        
        // Calculate revenue
        const monthlyRevenue = rooms
            .filter(room => !room.isAvailable)
            .reduce((sum, room) => sum + (room.price || 0), 0);
        
        const potentialRevenue = rooms.reduce((sum, room) => sum + (room.price || 0), 0);
        const revenueEfficiency = potentialRevenue > 0 ? (monthlyRevenue / potentialRevenue) * 100 : 0;

        // Room type distribution
        const roomTypeStats = {};
        rooms.forEach(room => {
            const type = room.roomType || 'unknown';
            roomTypeStats[type] = (roomTypeStats[type] || 0) + 1;
        });

        // Create statistics modal content (your existing modal content)
        const modalContent = `
            <div class="property-stats-modal">
                <!-- Your existing modal content here -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-navy">${property.title} - Statistics</h5>
                        <p class="text-muted small">${property.location.address}, ${property.location.city}</p>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="row mb-4">
                    <div class="col-md-3 col-6 mb-3">
                        <div class="card bg-primary text-white text-center">
                            <div class="card-body py-3">
                                <h4 class="mb-1">${totalRooms}</h4>
                                <small>Total Rooms</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="card bg-success text-white text-center">
                            <div class="card-body py-3">
                                <h4 class="mb-1">${availableRooms}</h4>
                                <small>Available</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="card bg-warning text-white text-center">
                            <div class="card-body py-3">
                                <h4 class="mb-1">${occupiedRooms}</h4>
                                <small>Occupied</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="card bg-info text-white text-center">
                            <div class="card-body py-3">
                                <h4 class="mb-1">${occupancyRate.toFixed(1)}%</h4>
                                <small>Occupancy Rate</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Revenue Section -->
                <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header bg-navy text-white">
                                <h6 class="mb-0">Revenue Analysis</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Current Monthly Revenue:</span>
                                    <strong class="text-success">R${monthlyRevenue}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Potential Monthly Revenue:</span>
                                    <strong>R${potentialRevenue}</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Revenue Efficiency:</span>
                                    <strong class="${revenueEfficiency > 70 ? 'text-success' : revenueEfficiency > 40 ? 'text-warning' : 'text-danger'}">
                                        ${revenueEfficiency.toFixed(1)}%
                                    </strong>
                                </div>
                                <div class="progress mt-2" style="height: 8px;">
                                    <div class="progress-bar ${revenueEfficiency > 70 ? 'bg-success' : revenueEfficiency > 40 ? 'bg-warning' : 'bg-danger'}" 
                                         style="width: ${revenueEfficiency}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header bg-navy text-white">
                                <h6 class="mb-0">Room Type Distribution</h6>
                            </div>
                            <div class="card-body">
                                ${Object.entries(roomTypeStats).map(([type, count]) => {
                                    const percentage = totalRooms > 0 ? (count / totalRooms) * 100 : 0;
                                    const typeInfo = roomTypeConfig[type] || { text: type, class: 'secondary' };
                                    return `
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="small">
                                                <span class="badge bg-${typeInfo.class} me-1">${typeInfo.text}</span>
                                            </span>
                                            <div class="d-flex align-items-center">
                                                <span class="me-2 small">${count}</span>
                                                <span class="text-muted small">${percentage.toFixed(1)}%</span>
                                            </div>
                                        </div>
                                        <div class="progress mb-2" style="height: 6px;">
                                            <div class="progress-bar bg-${typeInfo.class}" style="width: ${percentage}%"></div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Room Details Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-navy text-white">
                                <h6 class="mb-0">Room Details</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>Room</th>
                                                <th>Type</th>
                                                <th>Status</th>
                                                <th>Price</th>
                                                <th>Occupant</th>
                                                <th>Move-in Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${rooms.map(room => {
                                                const typeInfo = roomTypeConfig[room.roomType] || { text: room.roomType, class: 'secondary' };
                                                return `
                                                    <tr>
                                                        <td>${room.roomNumber || 'N/A'}</td>
                                                        <td>
                                                            <span class="badge bg-${typeInfo.class} small">
                                                                ${typeInfo.text}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <span class="badge bg-${room.isAvailable ? 'success' : 'warning'} small">
                                                                ${room.isAvailable ? 'Available' : 'Occupied'}
                                                            </span>
                                                        </td>
                                                        <td>R${room.price}</td>
                                                        <td>${room.occupant?.name || '-'}</td>
                                                        <td>${room.occupant?.moveInDate ? new Date(room.occupant.moveInDate).toLocaleDateString() : '-'}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-end gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="closeStatsAndOpenRooms('${propertyId}')">
                                <i class="bi bi-door-closed me-1"></i>Manage Rooms
                            </button>
                            <button class="btn btn-navy btn-sm" data-bs-dismiss="modal">
                                <i class="bi bi-x me-1"></i>Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove any existing stats modal first
        const existingModal = document.getElementById('propertyStatsModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Create and show statistics modal with proper z-index
        const modalDiv = document.createElement('div');
        modalDiv.className = 'modal fade';
        modalDiv.id = 'propertyStatsModal';
        modalDiv.setAttribute('data-bs-backdrop', 'static');
        modalDiv.innerHTML = `
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-graph-up me-2"></i>Property Statistics
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${modalContent}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modalDiv);
        
        const statsModal = new bootstrap.Modal(document.getElementById('propertyStatsModal'));
        
        // Show the modal
        statsModal.show();
        
        // Clean up modal when hidden
        document.getElementById('propertyStatsModal').addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(modalDiv);
        });

    } catch (error) {
        console.error('Error loading property statistics:', error);
        alert('Failed to load property statistics: ' + error.message);
    }
}

// Helper function to close stats and open rooms
function closeStatsAndOpenRooms(propertyId) {
    const statsModal = bootstrap.Modal.getInstance(document.getElementById('propertyStatsModal'));
    statsModal.hide();
    
    // Small delay to ensure modal is closed before opening room management
    setTimeout(() => {
        manageRooms(propertyId);
    }, 300);
}

    // Helper function to get selected amenities in edit form
    function getSelectedEditAmenities() {
        const amenities = [];
        if (document.getElementById('editAmenityWifi').checked) amenities.push('wifi');
        if (document.getElementById('editAmenityParking').checked) amenities.push('parking');
        if (document.getElementById('editAmenityLaundry').checked) amenities.push('laundry');
        if (document.getElementById('editAmenityFurnished').checked) amenities.push('furnished');
        if (document.getElementById('editAmenityGym').checked) amenities.push('gym');
        if (document.getElementById('editAmenityPool').checked) amenities.push('pool');
        if (document.getElementById('editAmenityAC').checked) amenities.push('ac');
        if (document.getElementById('editAmenityHeating').checked) amenities.push('heating');
        if (document.getElementById('editAmenityShuttle').checked) amenities.push('shuttle');
        if (document.getElementById('editAmenityCCTV').checked) amenities.push('cctv');
        return amenities;
    }

    // ============ ROOM MANAGEMENT FUNCTIONS ============

    // Open room management modal
    function manageRooms(propertyId) {
        const property = allProperties.find(p => p._id === propertyId);
        if (!property) return;
        
        document.getElementById('roomPropertyId').value = propertyId;
        document.getElementById('roomManagementTitle').textContent = `Manage Rooms - ${property.title}`;
        document.getElementById('propertyRoomsTitle').textContent = `Rooms for ${property.title}`;
        
        // Reset room image data
        resetRoomImageData();
        
        // Load rooms for this property
        loadPropertyRooms(propertyId);
        
        // Show modal
        new bootstrap.Modal(document.getElementById('roomManagementModal')).show();
    }

    // Load property rooms from backend
    async function loadPropertyRooms(propertyId) {
        try {
            const token = localStorage.getItem("token");
            const response = await fetch(`${API_BASE_URL}/properties/${propertyId}/rooms`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                currentPropertyRooms = data.rooms || [];
                renderRoomsList();
            } else {
                throw new Error('Failed to load rooms');
            }
        } catch (error) {
            console.error('Error loading rooms:', error);
            currentPropertyRooms = [];
            renderRoomsList();
        }
    }

    // Render rooms list
    function renderRoomsList() {
        const container = document.getElementById('roomsListContainer');
        
        if (currentPropertyRooms.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-door-closed display-4 text-muted mb-3"></i>
                    <p class="text-muted">No rooms added yet</p>
                    <small>Add rooms to start receiving bookings for individual rooms</small>
                </div>
            `;
            return;
        }
        
        container.innerHTML = currentPropertyRooms.map(room => `
            <div class="card mb-3 room-card ${room.isAvailable ? 'border-success' : 'border-warning'}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <img src="${room.images && room.images.length > 0 ? room.images[0] : 'https://via.placeholder.com/200x150?text=Room+Image'}" 
                                class="img-fluid rounded" alt="${room.roomNumber || room.roomType}" style="height: 120px; object-fit: cover; width: 100%;">
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="card-title mb-1">
                                        ${room.roomNumber ? room.roomNumber + ' - ' : ''}${roomTypeConfig[room.roomType]?.text || room.roomType}
                                    </h6>
                                    <span class="badge bg-${roomTypeConfig[room.roomType]?.class || 'secondary'} mb-2">
                                        <i class="${roomTypeConfig[room.roomType]?.icon || 'bi-door-closed'} me-1"></i>
                                        ${roomTypeConfig[room.roomType]?.text || room.roomType}
                                    </span>
                                    <span class="badge bg-${room.isAvailable ? 'success' : 'warning'} ms-1">
                                        <i class="bi ${room.isAvailable ? 'bi-check-circle' : 'bi-person-check'} me-1"></i>
                                        ${room.isAvailable ? 'Available' : 'Occupied'}
                                    </span>
                                </div>
                            </div>
                            <p class="card-text small text-muted mb-2">${room.description || 'No description provided'}</p>
                            <div class="mb-2">
                                ${room.features && room.features.slice(0, 4).map(feature => `
                                    <span class="badge bg-light text-dark me-1 small">${feature}</span>
                                `).join('')}
                                ${room.features && room.features.length > 4 ? `<span class="badge bg-light text-dark small">+${room.features.length - 4}</span>` : ''}
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="text-muted small me-3"><i class="bi bi-arrows-fullscreen me-1"></i>${room.size || 'Size not specified'}</span>
                                </div>
                                <div>
                                    <strong class="text-primary">R${room.price}/month</strong>
                                </div>
                            </div>
                            ${!room.isAvailable && room.occupant ? `
                                <div class="mt-2 p-2 bg-light rounded small">
                                    <strong>Occupied by:</strong> ${room.occupant.name || 'Unknown'} 
                                    ${room.occupant.moveInDate ? `since ${new Date(room.occupant.moveInDate).toLocaleDateString()}` : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex flex-column gap-2">
                                <button class="btn btn-outline-warning btn-sm" onclick="editExistingRoom('${room._id}')">
                                    <i class="bi bi-pencil me-1"></i>Edit
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="viewRoomDetails('${room._id}')">
                                    <i class="bi bi-eye me-1"></i>View
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteRoom('${room._id}')">
                                    <i class="bi bi-trash me-1"></i>Delete
                                </button>
                                <button class="btn btn-${room.isAvailable ? 'warning' : 'success'} btn-sm" onclick="toggleRoomAvailability('${room._id}')">
                                    <i class="bi ${room.isAvailable ? 'bi-person-check' : 'bi-check-circle'} me-1"></i>
                                    ${room.isAvailable ? 'Mark Occupied' : 'Mark Available'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Show add room form
    function showAddRoomForm() {
        document.getElementById('addRoomForm').style.display = 'block';
        document.getElementById('addRoomFormFields').reset();
        currentEditingRoomId = null;
        
        // Reset room image data for add form
        resetRoomImageData();
        
        // Update form title and button text
        document.getElementById('roomFormTitle').textContent = 'Add New Room';
        document.getElementById('roomActionButton').textContent = 'Add Room';
        
        // Reset occupant info display
        document.getElementById('occupantInfo').style.display = 'none';
        
        // Scroll to the form
        document.getElementById('addRoomForm').scrollIntoView({ behavior: 'smooth' });
    }

    // Hide add room form
    function hideAddRoomForm() {
        document.getElementById('addRoomForm').style.display = 'none';
        currentEditingRoomId = null;
    }

    // Toggle occupant info based on availability
    function toggleOccupantInfo() {
        const isOccupied = document.getElementById('roomAvailability').value === 'false';
        document.getElementById('occupantInfo').style.display = isOccupied ? 'block' : 'none';
    }

    // Add or update room
    async function addRoom() {
        const propertyId = document.getElementById('roomPropertyId').value;
        
        if (currentEditingRoomId) {
            await updateRoom();
        } else {
            await addNewRoom();
        }
    }

    // Add new room - FIXED to use batch upload
async function addNewRoom() {
    const propertyId = document.getElementById('roomPropertyId').value;
    const roomData = {
        roomType: document.getElementById('roomType').value,
        roomNumber: document.getElementById('roomNumber').value,
        price: parseInt(document.getElementById('roomPrice').value),
        size: document.getElementById('roomSize').value,
        description: document.getElementById('roomDescription').value,
        isAvailable: document.getElementById('roomAvailability').value === 'true',
        images: [],
        features: getSelectedRoomFeatures()
    };

    // Add occupant info if room is occupied
    if (!roomData.isAvailable) {
        roomData.occupant = {
            name: document.getElementById('occupantName').value,
            moveInDate: document.getElementById('moveInDate').value
        };
    }

    // ✅ FIXED: Use batch upload for room images
    const filesToUpload = roomImages.add.files.map(fileData => fileData.file);
    
    if (filesToUpload.length > 0) {
        const uploadedUrls = await uploadMultipleToCloudinary(filesToUpload);
        roomData.images.push(...uploadedUrls);
    }
    
    // Add URL images (these are already external URLs)
    roomData.images.push(...roomImages.add.urls);

    console.log('Creating room with images:', roomData.images);

    try {
        const token = localStorage.getItem("token");
        const response = await fetch(`${API_BASE_URL}/properties/${propertyId}/rooms`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(roomData)
        });

        if (!response.ok) {
            throw new Error('Failed to add room');
        }

        alert('Room added successfully!');
        hideAddRoomForm();
        await loadPropertyRooms(propertyId);
        
        // Reset room image data after successful add
        resetRoomImageData();
    } catch (error) {
        console.error('Error adding room:', error);
        alert('Failed to add room: ' + error.message);
    }
}
    
// Update room - FIXED to use consistent Cloudinary handling
async function updateRoom() {
    if (!currentEditingRoomId) return;

    const propertyId = document.getElementById('roomPropertyId').value;
    const existingRoom = currentPropertyRooms.find(r => r._id === currentEditingRoomId);
    
    if (!existingRoom) {
        alert('Room not found!');
        return;
    }

    // Get existing images from the room (these are the ones that remain after deletions)
    const existingImages = roomImages.add.urls;
    
    // Upload new files to Cloudinary
    const filesToUpload = roomImages.add.files.map(fileData => fileData.file);
    const newUploadedUrls = await uploadMultipleToCloudinary(filesToUpload);
    
    // Combine existing images with new images
    const allImages = [
        ...existingImages,           // Existing Cloudinary URLs (after any deletions)
        ...newUploadedUrls,          // Newly uploaded Cloudinary URLs  
    ];

    const roomData = {
        roomType: document.getElementById('roomType').value,
        roomNumber: document.getElementById('roomNumber').value,
        price: parseInt(document.getElementById('roomPrice').value),
        size: document.getElementById('roomSize').value,
        description: document.getElementById('roomDescription').value,
        isAvailable: document.getElementById('roomAvailability').value === 'true',
        images: allImages,
        features: getSelectedRoomFeatures()
    };

    // Add occupant info if room is occupied
    if (!roomData.isAvailable) {
        roomData.occupant = {
            name: document.getElementById('occupantName').value,
            moveInDate: document.getElementById('moveInDate').value
        };
    } else {
        roomData.occupant = null;
    }

    try {
        const token = localStorage.getItem("token");
        const response = await fetch(`${API_BASE_URL}/properties/${propertyId}/rooms/${currentEditingRoomId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(roomData)
        });

        if (!response.ok) {
            throw new Error('Failed to update room');
        }

        alert('Room updated successfully!');
        hideAddRoomForm();
        await loadPropertyRooms(propertyId);
        currentEditingRoomId = null;
        
        // Reset room image data after successful update
        resetRoomImageData();
    } catch (error) {
        console.error('Error updating room:', error);
        alert('Failed to update room: ' + error.message);
    }
}

    // Get selected room features
    function getSelectedRoomFeatures() {
        const features = [];
        const checkboxes = [
            'featureSingleBed', 'featureDoubleBed', 'featureDesk', 'featureWardrobe',
            'featurePrivateBathroom', 'featureAC', 'featureHeating', 'featureBalcony'
        ];
        
        checkboxes.forEach(id => {
            if (document.getElementById(id).checked) {
                features.push(document.getElementById(id).value);
            }
        });
        
        return features;
    }

    // Edit existing room - FIXED to show existing images properly
    // Update the editExistingRoom function to handle Cloudinary URLs properly
function editExistingRoom(roomId) {
    const room = currentPropertyRooms.find(r => r._id === roomId);
    if (!room) return;

    // Reset room image data first
    roomImages.add.files = [];
    roomImages.add.urls = [];
    
    // Clear preview containers
    document.getElementById('roomImagePreviewContainer').innerHTML = '';
    document.getElementById('roomImageUrlList').innerHTML = '';

    // Populate the add room form with existing room data
    document.getElementById('roomType').value = room.roomType;
    document.getElementById('roomNumber').value = room.roomNumber || '';
    document.getElementById('roomPrice').value = room.price;
    document.getElementById('roomSize').value = room.size || '';
    document.getElementById('roomDescription').value = room.description || '';
    document.getElementById('roomAvailability').value = room.isAvailable ? 'true' : 'false';
    
    // Handle existing images - all should be Cloudinary URLs now
    if (room.images && room.images.length > 0) {
        // Store existing Cloudinary URLs
        roomImages.add.urls = [...room.images];
        
        // Render URL list and previews for existing Cloudinary images
        const urlList = document.getElementById('roomImageUrlList');
        const previewContainer = document.getElementById('roomImagePreviewContainer');
        
        room.images.forEach((url, i) => {
            // Add to URL list
            const urlItem = document.createElement('div');
            urlItem.className = 'image-url-item';
            urlItem.innerHTML = `
                <span>${url}</span>
                <button type="button" class="remove-url" onclick="removeExistingRoomImage('${document.getElementById('roomPropertyId').value}', '${roomId}', ${i})">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            urlList.appendChild(urlItem);
            
            // Create preview for Cloudinary image
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.innerHTML = `
                <img src="${url}" alt="Existing room image">
                <button type="button" class="remove-image" onclick="removeExistingRoomImage('${document.getElementById('roomPropertyId').value}', '${roomId}', ${i})">
                    <i class="bi bi-x"></i>
                </button>
            `;
            previewContainer.appendChild(previewItem);
        });
    }
        
    // Set occupant info if room is occupied
    if (!room.isAvailable && room.occupant) {
        document.getElementById('occupantName').value = room.occupant.name || '';
        document.getElementById('moveInDate').value = room.occupant.moveInDate || '';
        document.getElementById('occupantInfo').style.display = 'block';
    } else {
        document.getElementById('occupantInfo').style.display = 'none';
    }

    // Set room features checkboxes
    const features = room.features || [];
    document.getElementById('featureSingleBed').checked = features.includes('single-bed');
    document.getElementById('featureDoubleBed').checked = features.includes('double-bed');
    document.getElementById('featureDesk').checked = features.includes('desk');
    document.getElementById('featureWardrobe').checked = features.includes('wardrobe');
    document.getElementById('featurePrivateBathroom').checked = features.includes('private-bathroom');
    document.getElementById('featureAC').checked = features.includes('air-conditioning');
    document.getElementById('featureHeating').checked = features.includes('heating');
    document.getElementById('featureBalcony').checked = features.includes('balcony');

    // Show the form and set editing mode
    document.getElementById('addRoomForm').style.display = 'block';
    currentEditingRoomId = roomId;

    // Update form title and button text
    document.getElementById('roomFormTitle').textContent = 'Edit Room';
    document.getElementById('roomActionButton').textContent = 'Update Room';

    // Scroll to the form
    document.getElementById('addRoomForm').scrollIntoView({ behavior: 'smooth' });
}

    // View room details
    // View room details - FIXED with proper modal management
function viewRoomDetails(roomId) {
    const room = currentPropertyRooms.find(r => r._id === roomId);
    if (!room) return;

    const roomType = roomTypeConfig[room.roomType] || { text: room.roomType, icon: 'bi-door-closed', class: 'secondary' };
    
    // Create image carousel if multiple images exist
    let imagesHtml = '';
    if (room.images && room.images.length > 1) {
        imagesHtml = `
            <div id="roomCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-indicators">
                    ${room.images.map((_, index) => `
                        <button type="button" data-bs-target="#roomCarousel" data-bs-slide-to="${index}" ${index === 0 ? 'class="active" aria-current="true"' : ''} aria-label="Slide ${index + 1}"></button>
                    `).join('')}
                </div>
                <div class="carousel-inner">
                    ${room.images.map((image, index) => `
                        <div class="carousel-item ${index === 0 ? 'active' : ''}">
                            <img src="${image}" class="d-block w-100" style="height: 250px; object-fit: cover;" alt="${room.roomNumber || room.roomType} - Image ${index + 1}">
                        </div>
                    `).join('')}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#roomCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#roomCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        `;
    } else {
        const imageUrl = room.images && room.images.length > 0 ? room.images[0] : 'https://via.placeholder.com/400x300?text=Room+Image';
        imagesHtml = `<img src="${imageUrl}" class="img-fluid rounded" alt="${room.roomNumber || room.roomType}" style="width: 100%; height: 250px; object-fit: cover;">`;
    }
    
    const modalContent = `
        <div class="row">
            <div class="col-md-6">
                ${imagesHtml}
            </div>
            <div class="col-md-6">
                <h5>${room.roomNumber ? room.roomNumber + ' - ' : ''}${roomType.text}</h5>
                
                <div class="mb-3">
                    <span class="badge bg-${roomType.class} me-2">
                        <i class="${roomType.icon} me-1"></i>${roomType.text}
                    </span>
                    <span class="badge bg-${room.isAvailable ? 'success' : 'warning'}">
                        <i class="bi ${room.isAvailable ? 'bi-check-circle' : 'bi-person-check'} me-1"></i>
                        ${room.isAvailable ? 'Available' : 'Occupied'}
                    </span>
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Monthly Rent:</strong><br>
                        <h6 class="text-primary">R${room.price}</h6>
                    </div>
                    <div class="col-6">
                        <strong>Room Size:</strong><br>
                        <h6>${room.size || 'Not specified'}</h6>
                    </div>
                </div>
                
                ${!room.isAvailable && room.occupant ? `
                    <div class="mb-3 p-3 bg-light rounded">
                        <h6>Current Occupant</h6>
                        <p class="mb-1"><strong>Name:</strong> ${room.occupant.name || 'Not specified'}</p>
                        ${room.occupant.moveInDate ? `<p class="mb-0"><strong>Move-in Date:</strong> ${new Date(room.occupant.moveInDate).toLocaleDateString()}</p>` : ''}
                    </div>
                ` : ''}
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <h6>Description</h6>
                <p class="text-muted">${room.description || 'No description provided.'}</p>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <h6>Room Features</h6>
                <div class="room-features-list">
                    ${room.features && room.features.length > 0 ? 
                        room.features.map(feature => `
                            <span class="room-feature-badge">
                                <i class="bi bi-check-circle me-1"></i>${feature.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                            </span>
                        `).join('') : 
                        '<p class="text-muted">No features specified.</p>'
                    }
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-end gap-2">
                    <button class="btn btn-outline-warning btn-sm" id="editRoomFromDetailsBtn" data-room-id="${room._id}">
                        <i class="bi bi-pencil me-1"></i>Edit Room
                    </button>
                    <button class="btn btn-outline-primary btn-sm" data-bs-dismiss="modal">
                        <i class="bi bi-arrow-left me-1"></i>Back to Rooms
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Remove any existing room details modal first
    const existingModal = document.getElementById('roomDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Create a temporary modal for room details
    const modalDiv = document.createElement('div');
    modalDiv.className = 'modal fade';
    modalDiv.id = 'roomDetailsModal';
    modalDiv.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Room Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    ${modalContent}
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modalDiv);
    
    const roomModal = new bootstrap.Modal(document.getElementById('roomDetailsModal'));
    
    // Add event listener for the edit button after modal is shown
    roomModal._element.addEventListener('shown.bs.modal', function() {
        const editBtn = document.getElementById('editRoomFromDetailsBtn');
        if (editBtn) {
            editBtn.addEventListener('click', function() {
                const roomId = this.getAttribute('data-room-id');
                closeRoomModalAndEdit(roomId);
            });
        }
    });
    
    roomModal.show();
    
    // Clean up modal when hidden
    document.getElementById('roomDetailsModal').addEventListener('hidden.bs.modal', function() {
        setTimeout(() => {
            if (document.body.contains(this)) {
                document.body.removeChild(this);
            }
        }, 300);
    });
}

// Close room details modal and open edit form - FIXED
function closeRoomModalAndEdit(roomId) {
    const roomModal = bootstrap.Modal.getInstance(document.getElementById('roomDetailsModal'));
    if (roomModal) {
        roomModal.hide();
    }
    
    // Wait for modal to fully close before opening edit form
    setTimeout(() => {
        editExistingRoom(roomId);
    }, 400);
}
    

    // Close room details modal and open edit form
    function closeRoomModalAndEdit(roomId) {
        const roomModal = bootstrap.Modal.getInstance(document.getElementById('roomDetailsModal'));
        roomModal.hide();
        
        // Small delay to ensure modal is closed before opening edit form
        setTimeout(() => {
            editExistingRoom(roomId);
        }, 300);
    }

    // Add multiple rooms at once
    // Add multiple rooms at once
// Add multiple rooms at once - FIXED to use empty images array
async function addBulkRooms() {
    const propertyId = document.getElementById('roomPropertyId').value;
    const roomCount = parseInt(document.getElementById('bulkRoomCount').value);
    const roomType = document.getElementById('bulkRoomType').value;
    const price = parseInt(document.getElementById('bulkRoomPrice').value);

    if (!roomCount || !price) {
        alert('Please enter number of rooms and price');
        return;
    }

    try {
        const token = localStorage.getItem("token");
        
        for (let i = 1; i <= roomCount; i++) {
            const roomData = {
                roomType: roomType,
                roomNumber: `Room ${i}`,
                price: price,
                description: `Comfortable ${roomTypeConfig[roomType]?.text || roomType} with essential amenities`,
                isAvailable: true,
                images: [], // ✅ FIXED: Empty array - no images for bulk rooms
                features: ['single-bed', 'desk', 'wardrobe']
            };

            const response = await fetch(`${API_BASE_URL}/properties/${propertyId}/rooms`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(roomData)
            });

            if (!response.ok) {
                throw new Error(`Failed to add room ${i}`);
            }
        }

        alert(`${roomCount} rooms added successfully!`);
        await loadPropertyRooms(propertyId);
    } catch (error) {
        console.error('Error adding bulk rooms:', error);
        alert('Failed to add rooms: ' + error.message);
    }
}

    // Delete room
    async function deleteRoom(roomId) {
        const propertyId = document.getElementById('roomPropertyId').value;
        
        if (confirm('Are you sure you want to delete this room?')) {
            try {
                const token = localStorage.getItem("token");
                const response = await fetch(`${API_BASE_URL}/properties/${propertyId}/rooms/${roomId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    alert('Room deleted successfully!');
                    await loadPropertyRooms(propertyId);
                } else {
                    throw new Error('Failed to delete room');
                }
            } catch (error) {
                console.error('Error deleting room:', error);
                alert('Failed to delete room: ' + error.message);
            }
        }
    }

    // Toggle room availability
    async function toggleRoomAvailability(roomId) {
        const propertyId = document.getElementById('roomPropertyId').value;
        const room = currentPropertyRooms.find(r => r._id === roomId);
        
        if (!room) return;

        try {
            const token = localStorage.getItem("token");
            const response = await fetch(`${API_BASE_URL}/properties/${propertyId}/rooms/${roomId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    isAvailable: !room.isAvailable,
                    occupant: room.isAvailable ? { name: '', moveInDate: null } : null
                })
            });

            if (response.ok) {
                await loadPropertyRooms(propertyId);
            } else {
                throw new Error('Failed to update room');
            }
        } catch (error) {
            console.error('Error updating room:', error);
            alert('Failed to update room: ' + error.message);
        }
    }

    // ============ UI STATE MANAGEMENT ============

    function showLoadingState() {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('propertiesGridView').style.display = 'none';
        document.getElementById('propertiesListView').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
    }

    function hideLoadingState() {
        document.getElementById('loadingState').style.display = 'none';
    }

    function showEmptyState() {
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('propertiesGridView').style.display = 'none';
        document.getElementById('propertiesListView').style.display = 'none';
    }

    function hideEmptyState() {
        document.getElementById('emptyState').style.display = 'none';
    }

    // Enhanced logout function - FIXED
function logout() {
    console.log('Logout function called');
    
    // Close all open modals first
    const openModals = document.querySelectorAll('.modal.show');
    console.log(`Found ${openModals.length} open modals to close`);
    
    if (openModals.length > 0) {
        // Close all modals
        openModals.forEach(modal => {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) {
                bsModal.hide();
            }
        });
        
        // Wait for modals to close completely
        setTimeout(() => {
            performLogout();
        }, 500);
    } else {
        performLogout();
    }
}

// Enhanced modal cleanup function
function cleanupModals() {
    // Remove any dynamically created modals that might be stacking
    const dynamicModals = document.querySelectorAll('.modal:not(#editPropertyModal):not(#addPropertyModal):not(#propertyDetailsModal):not(#roomManagementModal):not(#photographyPromptModal)');
    dynamicModals.forEach(modal => {
        if (modal.id.includes('StatsModal') || modal.id.includes('DetailsModal')) {
            modal.remove();
        }
    });
    
    // Clean up duplicate backdrops
    const backdrops = document.querySelectorAll('.modal-backdrop');
    if (backdrops.length > 1) {
        for (let i = 1; i < backdrops.length; i++) {
            backdrops[i].remove();
        }
    }
    
    // Ensure body styling is correct
    if (!document.querySelector('.modal.show')) {
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }
}

function performLogout() {
    // Clear storage and redirect
    localStorage.removeItem("token");
    localStorage.removeItem("user");
    console.log('Local storage cleared, redirecting...');
    window.location.href = "index.html";
}

    // ============ INITIALIZATION ============

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadProperties();
        
        // View mode toggle
        document.getElementById('gridView').addEventListener('change', function() {
            document.getElementById('propertiesGridView').style.display = 'grid';
            document.getElementById('propertiesListView').style.display = 'none';
        });
        
        document.getElementById('listView').addEventListener('change', function() {
            document.getElementById('propertiesGridView').style.display = 'none';
            document.getElementById('propertiesListView').style.display = 'block';
        });

        // Add event listener for Enter key in search
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                filterProperties();
            }
        });

        // Reset image data when modals are closed
        document.getElementById('addPropertyModal').addEventListener('hidden.bs.modal', function() {
            resetPropertyImageData();
        });
        
        document.getElementById('editPropertyModal').addEventListener('hidden.bs.modal', function() {
            resetPropertyImageData();
        });
        
        document.getElementById('roomManagementModal').addEventListener('hidden.bs.modal', function() {
            resetRoomImageData();
        });
    });

    // Clean modal event handlers
document.addEventListener('DOMContentLoaded', function() {
  // Ensure edit property modal works
  document.addEventListener('click', function(e) {
    if (e.target.closest('[onclick*="editProperty"]')) {
      // Let the original onclick handler work
      return;
    }
    
    if (e.target.closest('[onclick*="viewPropertyDetails"]')) {
      // Let the original onclick handler work  
      return;
    }
  });

  // Properly handle modal hiding
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('hidden.bs.modal', function() {
      // Reset any form data when modal closes
      const forms = this.querySelectorAll('form');
      forms.forEach(form => {
        form.classList.remove('was-validated');
      });
    });
  });
});

// Global modal cleanup and management
function initializeModalCleanup() {
    // Clean up any zombie modals on page load
    document.addEventListener('DOMContentLoaded', function() {
        const zombieModals = document.querySelectorAll('.modal:not(#propertyDetailsModal):not(#editPropertyModal):not(#roomManagementModal):not(#addPropertyModal):not(#photographyPromptModal)');
        zombieModals.forEach(modal => {
            if (modal.id.includes('DetailsModal') || modal.id.includes('StatsModal')) {
                modal.remove();
            }
        });
    });

    // Handle modal backdrop issues
    document.addEventListener('hidden.bs.modal', function(event) {
        const modal = event.target;
        
        // Remove any duplicate backdrops
        const backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length > 1) {
            for (let i = 1; i < backdrops.length; i++) {
                backdrops[i].remove();
            }
        }
        
        // Ensure body class is clean
        if (!document.querySelector('.modal.show')) {
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }
    });
}

// Initialize modal cleanup
initializeModalCleanup();
</script>
</body>
</html>